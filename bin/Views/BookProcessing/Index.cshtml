@inject Microsoft.AspNetCore.Antiforgery.IAntiforgery Antiforgery
@model EBookDashboard.Models.APIRawResponse
@{
    ViewData["Title"] = "Process AI Responses";
    Layout = "~/Views/Shared/_Layout.cshtml";
    // Get anti-forgery token
    var token = Antiforgery.GetAndStoreTokens(Context).RequestToken;
}
<!-- Add hidden anti-forgery token -->
@Html.AntiForgeryToken()

<div class="container mt-4">
    <h2 class="mb-4">🔄 Process AI Responses</h2>

    <div class="row">
        <div class="col-md-8">
            <!-- Statistics Card -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">📊 Processing Statistics</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-4">
                            <div class="border rounded p-3">
                                <h3 id="totalResponses">0</h3>
                                <p class="mb-0 text-muted">Total Responses</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="border rounded p-3">
                                <h3 id="unprocessedCount">0</h3>
                                <p class="mb-0 text-muted">Unprocessed</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="border rounded p-3">
                                <h3 id="processedCount">0</h3>
                                <p class="mb-0 text-muted">Processed</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Process All Button -->
            <div class="card mb-4">
                <div class="card-body text-center">
                    <button id="processAllBtn" class="btn btn-success btn-lg" onclick="processAllResponses()">
                        <i class="bi bi-play-circle"></i> Process All Unprocessed Responses
                    </button>
                    <div id="processAllStatus" class="mt-2"></div>
                </div>
            </div>

            <!-- Unprocessed Responses List -->
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">📋 Unprocessed Responses</h5>
                </div>
                <div class="card-body">
                    <div id="unprocessedList" class="mt-3">
                        <div class="text-center">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p class="mt-2">Loading unprocessed responses...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <!-- Manual Processing Card -->
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">🔧 Manual Processing</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="responseIdInput" class="form-label">Response ID</label>
                        <input type="number" id="responseIdInput" class="form-control" placeholder="Enter Response ID">
                    </div>
                    <button id="processSingleBtn" class="btn btn-primary w-100" onclick="processSingleResponse()">
                        <i class="bi bi-gear"></i> Process Single Response
                    </button>
                    <div id="processSingleStatus" class="mt-2"></div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">⚡ Quick Actions</h5>
                </div>
                <div class="card-body">
                    <button class="btn btn-outline-primary w-100 mb-2" onclick="refreshStats()">
                        <i class="bi bi-arrow-clockwise"></i> Refresh Statistics
                    </button>
                    <button class="btn btn-outline-info w-100 mb-2" onclick="loadUnprocessedResponses()">
                        <i class="bi bi-list-ul"></i> Reload List
                    </button>
                    <button class="btn btn-outline-warning w-100" onclick="clearStatusMessages()">
                        <i class="bi bi-x-circle"></i> Clear Messages
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
@section Scripts {
    <script>
        // Load data when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadStatistics();
            loadUnprocessedResponses();
        });

        // Load statistics
        async function loadStatistics() {
            try {
                const response = await fetch('/BookProcessing/GetUnprocessedResponses');
                const data = await response.json();

                const total = data.length;
                const unprocessed = data.length;
                const processed = total - unprocessed; // This would need total count from another endpoint

                document.getElementById('totalResponses').textContent = total;
                document.getElementById('unprocessedCount').textContent = unprocessed;
                document.getElementById('processedCount').textContent = processed;
            } catch (error) {
                console.error('Error loading statistics:', error);
            }
        }

        // Load unprocessed responses list
        async function loadUnprocessedResponses() {
            const container = document.getElementById('unprocessedList');
            container.innerHTML = `
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2">Loading unprocessed responses...</p>
                </div>
            `;

            try {
                const response = await fetch('/BookProcessing/GetUnprocessedResponses');
                const data = await response.json();

                if (data.length === 0) {
                    container.innerHTML = `
                        <div class="alert alert-success text-center">
                            <i class="bi bi-check-circle"></i>
                            <strong>All caught up!</strong> No unprocessed responses found.
                        </div>
                    `;
                    return;
                }

                let html = '';
                data.forEach(item => {
                    const date = new Date(item.createdAt).toLocaleString();
                    html += `
                        <div class="card mb-3">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="card-title">Response #${item.responseId}</h6>
                                        <p class="card-text mb-1">
                                            <small class="text-muted">
                                                <strong>Endpoint:</strong> ${item.endpoint}<br>
                                                <strong>User ID:</strong> ${item.userId}<br>
                                                <strong>Created:</strong> ${date}
                                            </small>
                                        </p>
                                    </div>
                                    <div>
                                        <button class="btn btn-sm btn-outline-primary" onclick="processSingleResponse(${item.responseId})">
                                            <i class="bi bi-play"></i> Process
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });

                container.innerHTML = html;
            } catch (error) {
                container.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i>
                        Error loading responses: ${error.message}
                    </div>
                `;
            }
        }
        // Process all unprocessed responses
        async function processAllResponses() {
            const button = document.getElementById('processAllBtn');
            const statusDiv = document.getElementById('processAllStatus');

            button.disabled = true;
            button.innerHTML = '<i class="bi bi-hourglass-split"></i> Processing...';
            statusDiv.innerHTML = `
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    Processing all unprocessed responses. This may take a while...
                </div>
            `;

            try {
                const response = await fetch('/BookProcessing/ProcessAllResponses', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (result.success) {
                    statusDiv.innerHTML = `
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle"></i>
                            <strong>Success!</strong> ${result.message}
                        </div>
                    `;
                } else {
                    statusDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle"></i>
                            <strong>Error:</strong> ${result.message}
                        </div>
                    `;
                }
            } catch (error) {
                statusDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i>
                        <strong>Network Error:</strong> ${error.message}
                    </div>
                `;
            } finally {
                button.disabled = false;
                button.innerHTML = '<i class="bi bi-play-circle"></i> Process All Unprocessed Responses';
                loadStatistics();
                loadUnprocessedResponses();
            }
        }

                // Process single response
        async function processSingleResponse(responseId = null) {
            const inputId = responseId || document.getElementById('responseIdInput').value;
            const statusDiv = document.getElementById('processSingleStatus');
            const button = document.getElementById('processSingleBtn');

            console.log("🔧 Processing single response:", inputId);

            if (!inputId) {
                statusDiv.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i>
                        Please enter a Response ID
                    </div>
                `;
                return;
            }

            button.disabled = true;
            button.innerHTML = '<i class="bi bi-hourglass-split"></i> Processing...';
            statusDiv.innerHTML = `
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i>
                    Processing response #${inputId}...
                </div>
            `;

            try {
                // Get anti-forgery token
                const token = document.querySelector('input[name="__RequestVerificationToken"]').value;

                const response = await fetch(`/BookProcessing/ProcessResponse?responseId=${inputId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': token,
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });

                console.log("🔧 ProcessSingle Response status:", response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error! status: ${response.status}, details: ${errorText}`);
                }

                const result = await response.json();
                console.log("🔧 ProcessSingle Result:", result);

                if (result.success) {
                    statusDiv.innerHTML = `
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle"></i>
                            <strong>Success!</strong> ${result.message}
                        </div>
                    `;
                    document.getElementById('responseIdInput').value = '';
                } else {
                    statusDiv.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle"></i>
                            <strong>Error:</strong> ${result.message}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('❌ Error processing single:', error);
                statusDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i>
                        <strong>Error:</strong> ${error.message}
                    </div>
                `;
            } finally {
                button.disabled = false;
                button.innerHTML = '<i class="bi bi-gear"></i> Process Single Response';
                loadStatistics();
                loadUnprocessedResponses();
            }
        }

        // Refresh statistics
        function refreshStats() {
            loadStatistics();
            showTempMessage('Statistics refreshed!', 'success');
        }

        // Clear status messages
        function clearStatusMessages() {
            document.getElementById('processAllStatus').innerHTML = '';
            document.getElementById('processSingleStatus').innerHTML = '';
        }

        // Show temporary message
        function showTempMessage(message, type = 'info') {
            const alertClass = type === 'success' ? 'alert-success' :
                             type === 'error' ? 'alert-danger' : 'alert-info';

            const tempDiv = document.createElement('div');
            tempDiv.className = `alert ${alertClass} alert-dismissible fade show`;
            tempDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            document.querySelector('.container').prepend(tempDiv);

            // Auto remove after 3 seconds
            setTimeout(() => {
                tempDiv.remove();
            }, 3000);
        }
    </script>

    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
}
