@model IEnumerable<EBookDashboard.Models.PlanFeatures>
<style>
    .custom-small-btn {
        padding: 0.25rem 0.75rem;
        font-size: 0.875rem;
        line-height: 1.5;
        border-radius: 0.2rem;
    }
</style>

<div>
    <h1> _FeatureLocks </h1>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <form id="featuresForm" method="post" action="/Payments/GenerateInvoice">
        <table class="table table-bordered table-striped">
            <thead class="table-primary">
                <tr>
                    <th style="width: 50px;">Select</th>
                    <th>Feature</th>
                    <th>Description</th>
                    <th>Rate</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var f in Model)
                {
                    <tr>
                        <td class="text-center">
                            <input type="checkbox" name="SelectedFeatureIds" value="@f.FeatureId"
                                   class="feature-checkbox" data-feature-rate="@f.FeatureRate"
                                   data-feature-name="@f.FeatureName" />
                        </td>
                        <td>@f.FeatureName</td>
                        <td>@f.Description</td>
                        <td>@f.FeatureRate @f.Currency</td>
                    </tr>
                }
            </tbody>
        </table>

        <!-- Hidden fields for additional data -->
        <input type="hidden" id="TotalAmount" name="TotalAmount" value="0" />
        <input type="hidden" id="SelectedFeaturesJson" name="SelectedFeaturesJson" value="" />

        <!-- Selected Features Summary -->
        <div class="mt-3 p-3 bg-light rounded" id="selectedFeaturesSummary" style="display: none;">
            <h5>Selected Features Summary</h5>
            <div id="selectedFeaturesList"></div>
            <div class="mt-2">
                <strong>Total Amount: <span id="totalAmount">0</span> @(Model.FirstOrDefault()?.Currency ?? "USD")</strong>
            </div>
        </div>

        <!-- Buttons moved outside the summary - always visible -->
        <div class="premium-buttons">
            <button type="submit" class="btn btn-primary custom-small-btn" id="generateInvoiceBtn">
                <i class="fas fa-file-invoice"></i> Generate Invoice
            </button>
            <button type="button" class="btn btn-secondary custom-small-btn" onclick="window.clearSelection()">
                <i class="fas fa-times"></i> Clear Selection
            </button>
            <button type="button" class="btn btn-outline-primary custom-small-btn" onclick="window.selectAllFeatures()">
                <i class="fas fa-times"></i> Select All
            </button>

        </div>
    </form>
</div>

<style>
    .table-bordered {
        border: 1px solid #dee2e6;
    }

        .table-bordered th,
        .table-bordered td {
            border: 1px solid #dee2e6;
        }

    .table-primary {
        background-color: #007bff !important;
        color: white;
    }

    .selected-feature-item {
        padding: 5px 0;
        border-bottom: 1px solid #eee;
    }
</style>

<script>
    // Debug function to check if script is loading
    console.log("✅ Feature locks script loaded");

    // Track selected features
    let selectedFeatures = [];

    // Define functions first and attach to window
    function updateSelectedFeatures() {
        console.log("✅ updateSelectedFeatures called");

        selectedFeatures = [];
        let total = 0;

        const checkedBoxes = document.querySelectorAll('.feature-checkbox:checked');
        console.log(`✅ Found ${checkedBoxes.length} checked checkboxes`);

        checkedBoxes.forEach(checkbox => {
            const featureId = checkbox.value;
            const featureRate = parseFloat(checkbox.getAttribute('data-feature-rate'));
            const featureName = checkbox.getAttribute('data-feature-name');

            console.log(`✅ Adding feature: ${featureName} (ID: ${featureId}, Rate: ${featureRate})`);

            selectedFeatures.push({
                FeatureId: featureId,
                FeatureName: featureName,
                FeatureRate: featureRate
            });

            total += featureRate;
        });

        // Update UI
        const summary = document.getElementById('selectedFeaturesSummary');
        const list = document.getElementById('selectedFeaturesList');
        const totalAmount = document.getElementById('totalAmount');
        const generateInvoiceBtn = document.getElementById('generateInvoiceBtn');

        if (selectedFeatures.length > 0) {
            console.log("✅ Showing summary with", selectedFeatures.length, "features");

            list.innerHTML = selectedFeatures.map(feature =>
                `<div class="selected-feature-item d-flex justify-content-between">
                    <span>${feature.FeatureName}</span>
                    <span><strong>${feature.FeatureRate} @(Model.FirstOrDefault()?.Currency ?? "USD")</strong></span>
                 </div>`
            ).join('');

            totalAmount.textContent = total.toFixed(2);
            if (summary) summary.style.display = 'block';

            if (generateInvoiceBtn) {
                generateInvoiceBtn.disabled = false;
                console.log("✅ Generate Invoice button enabled");
            }
        } else {
            console.log("✅ Hiding summary - no features selected");
            if (summary) summary.style.display = 'none';
            if (generateInvoiceBtn) {
                generateInvoiceBtn.disabled = true;
                console.log("✅ Generate Invoice button disabled");
            }
        }
    }

    // Calculate total amount
    function calculateTotal() {
        const total = selectedFeatures.reduce((sum, feature) => sum + feature.FeatureRate, 0).toFixed(2);
        console.log("✅ calculateTotal:", total);
        return total;
    }

    // Clear all selections
    function clearSelection() {
        console.log("✅ clearSelection called");
        document.querySelectorAll('.feature-checkbox').forEach(checkbox => {
            checkbox.checked = false;
        });
        updateSelectedFeatures();
    }

    // Select all features
    function selectAllFeatures() {
        console.log("✅ selectAllFeatures called");
        document.querySelectorAll('.feature-checkbox').forEach(checkbox => {
            checkbox.checked = true;
        });
        updateSelectedFeatures();
    }

    // Attach all functions to window object explicitly
    window.updateSelectedFeatures = updateSelectedFeatures;
    window.clearSelection = clearSelection;
    window.selectAllFeatures = selectAllFeatures;
    window.calculateTotal = calculateTotal;

    console.log("✅ All functions attached to window object");

    // Initialize event listeners after DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
        console.log("✅ DOM Content Loaded - Initializing feature locks");

        const checkboxes = document.querySelectorAll('.feature-checkbox');
        const generateInvoiceBtn = document.getElementById('generateInvoiceBtn');

        console.log(`✅ Found ${checkboxes.length} checkboxes`);
        console.log(`✅ Found generate invoice button:`, !!generateInvoiceBtn);

        // Add event listeners to checkboxes
        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                console.log("✅ Checkbox changed:", this.value, this.checked);
                updateSelectedFeatures();
            });
        });

        // Form submit handler
        if (document.getElementById('featuresForm')) {
            document.getElementById('featuresForm').addEventListener('submit', function(e) {
                console.log("✅ Form submit triggered");

                if (selectedFeatures.length === 0) {
                    e.preventDefault();
                    console.log("❌ No features selected, preventing form submission");
                    alert('Please select at least one feature.');
                    return;
                }

                // Set hidden fields before submission
                document.getElementById('TotalAmount').value = calculateTotal();
                document.getElementById('SelectedFeaturesJson').value = JSON.stringify(selectedFeatures);

                console.log("✅ Form data prepared, submitting...");
                console.log("Selected Features:", selectedFeatures);
                console.log("Total Amount:", calculateTotal());

                // Show loading state
                if (generateInvoiceBtn) {
                    generateInvoiceBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating Invoice...';
                    generateInvoiceBtn.disabled = true;
                }
            });
        }

        // Also add click event listeners as backup
        const clearSelectionBtn = document.querySelector('button[onclick*="clearSelection"]');
        const selectAllBtn = document.querySelector('button[onclick*="selectAllFeatures"]');

        if (clearSelectionBtn) {
            clearSelectionBtn.addEventListener('click', clearSelection);
        }

        if (selectAllBtn) {
            selectAllBtn.addEventListener('click', selectAllFeatures);
        }
    });

    console.log("✅ Feature locks script completely loaded");
</script>