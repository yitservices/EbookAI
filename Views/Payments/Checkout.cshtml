@model EBookDashboard.Models.AuthorPlans
@{
    ViewData["Title"] = "Checkout";
    Layout = "~/Views/Shared/_Layout.cshtml"; // adjust if your dashboard layout is different
}
<style>
    .spinner {
        animation: spin 1s linear infinite;
    }

    @@keyframes spin {
        from {
            transform: rotate(0deg);
        }

        to {
            transform: rotate(360deg);
        }
    }
</style>
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">

            <div class="card shadow-lg border-0 rounded-3">
                <div class="card-header bg-primary text-white text-center">
                    <h3 class="mb-0">Confirm Your Plan</h3>
                </div>
                <div class="card-body">
                    @Html.AntiForgeryToken()
                    <h4 class="text-center mb-4 text-success">
                        @Model.PlanDescription
                    </h4>

                    <div class="table-responsive">
                        <table class="table table-bordered table-striped">
                            <tbody>
                                <tr>
                                    <th scope="row">Plan ID</th>
                                    <td>@Model.PlanId</td>
                                </tr>
                                <tr>
                                    <th scope="row">Rate</th>
                                    <td>@Model.PlanRate.ToString("C")</td>
                                </tr>
                                <tr>
                                    <th scope="row">Duration</th>
                                    <td>@Model.PlanDays days</td>
                                </tr>
                                <tr>
                                    <th scope="row">Max E-Books Allowed</th>
                                    <td>@Model.MaxEBooks</td>
                                </tr>
                                <tr>
                                    <th scope="row">Start Date</th>
                                    <td>@Model.StartDate.ToShortDateString()</td>
                                </tr>
                                <tr>
                                    <th scope="row">End Date</th>
                                    <td>@Model.EndDate.ToShortDateString()</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Remove <form> wrapper -->
                    <input type="hidden" id="authorPlanId" value="@Model.AuthorPlanId" />


                    @*  <form asp-controller="Payments" asp-action="ProcessPayment" method="post">
                        <input type="hidden" name="authorPlanId" value="@Model.AuthorPlanId" />


                       
                    </form> *@
                    <div class="d-flex justify-content-between mt-4">
                        <a asp-controller="Dashboard" asp-action="Index" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left-circle"></i> Cancel
                        </a>
                        <button type="button" id="checkoutButton" class="btn btn-primary">
                            Confirm & Pay
                        </button>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>
<script src="https://js.stripe.com/v3/"></script>
<script>
    document.getElementById("checkoutButton").addEventListener("click", async () => {
        const button = document.getElementById("checkoutButton");
        const originalText = button.innerHTML;

        try {
            // Show loading state
            button.innerHTML = '<i class="bi bi-arrow-repeat spinner"></i> Processing...';
            button.disabled = true;

            // Debug: Check what values we're sending
            console.log("Sending to Stripe:");
            console.log("Product Name:", "@Model.PlanName");
            console.log("Amount:", @((long)(Model.PlanRate * 100)));

            // 1. Get publishable key
            const keyResponse = await fetch("/Checkout/GetPublishableKey");
            if (!keyResponse.ok) {
                throw new Error(`Failed to get publishable key: ${keyResponse.status}`);
            }
            const keyData = await keyResponse.json();
            const stripe = Stripe(keyData.publishableKey);

            // Prepare product data with validation
            const productName = "@Model.PlanName".trim() || "Author Publishing Plan";
            const productDescription = "@Model.PlanDescription".trim() || "E-Book publishing plan subscription";
            const amount = @((long)(Model.PlanRate * 100));

            console.log("Final product data:", {
                productName: productName,
                productDescription: productDescription,
                amount: amount
            });

            // 2. Create Stripe session
            const response = await fetch("/Checkout/CreateSession", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "RequestVerificationToken": document.querySelector('input[name="__RequestVerificationToken"]')?.value
                },
                body: JSON.stringify({
                    productName: productName,
                    productDescription: productDescription,
                    amount: amount,
                    currency: "usd",
                    authorPlanId: @Model.AuthorPlanId
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || "Error creating Stripe session");
            }

            const data = await response.json();
            console.log("Stripe session created:", data);

            // 3. Redirect to Stripe Checkout
            const result = await stripe.redirectToCheckout({
                sessionId: data.sessionId
            });

            if (result.error) {
                throw new Error(result.error.message);
            }

        } catch (error) {
            console.error("Checkout error:", error);
            alert("Checkout failed: " + error.message);

            // Reset button
            button.innerHTML = originalText;
            button.disabled = false;
        }
    });
</script>
