@model EBookDashboard.Models.DashboardIndexViewModel
@{
    ViewData["Title"] = "Dashboard";
    Layout = "~/Views/Shared/_DashboardLayout.cshtml";
}

<!-- Enhanced Dashboard Styles -->
<style>
    .dashboard-wrapper {
        padding: 20px;
        background: linear-gradient(135deg, #f5f7fa 0%, #e4edf9 100%);
        min-height: 100vh;
    }
    
    .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding: 20px;
        background: white;
        border-radius: 15px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }
    
    .welcome-section {
        flex: 1;
    }
    
    .welcome-section h1 {
        font-size: 2.2rem;
        font-weight: 700;
        color: #2c3e50;
        margin-bottom: 10px;
    }
    
    .welcome-section p {
        font-size: 1.1rem;
        color: #7f8c8d;
        margin-bottom: 0;
    }
    
    .user-greeting-card {
        background: linear-gradient(135deg, #4a6cf7 0%, #667eea 100%);
        color: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 8px 25px rgba(74, 108, 247, 0.3);
        margin-bottom: 30px;
        position: relative;
        overflow: hidden;
    }
    
    .user-greeting-card::before {
        content: "";
        position: absolute;
        top: -50px;
        right: -50px;
        width: 150px;
        height: 150px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.1);
    }
    
    .user-greeting-card::after {
        content: "";
        position: absolute;
        bottom: -80px;
        right: -30px;
        width: 200px;
        height: 200px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.05);
    }
    
    .user-info h2 {
        font-size: 1.8rem;
        font-weight: 600;
        margin-bottom: 10px;
        position: relative;
        z-index: 1;
    }
    
    .user-info p {
        font-size: 1.1rem;
        opacity: 0.9;
        position: relative;
        z-index: 1;
    }
    
    .user-stats {
        display: flex;
        gap: 30px;
        margin-top: 20px;
        position: relative;
        z-index: 1;
    }
    
    .stat-item {
        text-align: center;
    }
    
    .stat-value {
        font-size: 2rem;
        font-weight: 700;
        display: block;
    }
    
    .stat-label {
        font-size: 0.9rem;
        opacity: 0.8;
    }
    
    .stats-overview {
        margin-bottom: 30px;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 20px;
    }
    
    .stat-card {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 20px;
        border: 1px solid rgba(0, 0, 0, 0.03);
    }
    
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }
    
    .stat-icon {
        width: 60px;
        height: 60px;
        border-radius: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        flex-shrink: 0;
    }
    
    .bg-primary {
        background: linear-gradient(135deg, #4a6cf7 0%, #667eea 100%);
        color: white;
    }
    
    .bg-success {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
    }
    
    .bg-warning {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color: white;
    }
    
    .bg-info {
        background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        color: white;
    }
    
    .stat-content h3 {
        font-size: 1.8rem;
        font-weight: 700;
        margin-bottom: 5px;
        color: #2c3e50;
    }
    
    .stat-content p {
        font-size: 1rem;
        color: #7f8c8d;
        margin-bottom: 0;
    }
    
    .main-content-area {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 25px;
        margin-bottom: 30px;
    }
    
    .card {
        background: white;
        border-radius: 15px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        overflow: hidden;
        transition: all 0.3s ease;
        border: 1px solid rgba(0, 0, 0, 0.03);
    }
    
    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
    }
    
    .card-header {
        padding: 20px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .card-header h3 {
        font-size: 1.3rem;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 0;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .card-header h3 i {
        color: #4a6cf7;
    }
    
    .card-actions .btn {
        padding: 8px 15px;
        font-size: 0.9rem;
    }
    
    .card-body {
        padding: 20px;
    }
    
    .book-info {
        display: flex;
        gap: 20px;
        align-items: center;
    }
    
    .book-cover-placeholder {
        width: 80px;
        height: 100px;
        background: linear-gradient(135deg, #4a6cf7 0%, #667eea 100%);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 2rem;
        flex-shrink: 0;
    }
    
    .book-details {
        flex: 1;
    }
    
    .book-details h4 {
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 8px;
        color: #2c3e50;
    }
    
    .book-id {
        font-size: 0.9rem;
        color: #7f8c8d;
        margin-bottom: 15px;
    }
    
    .progress-container {
        margin-top: 15px;
    }
    
    .progress-label {
        font-size: 0.9rem;
        color: #7f8c8d;
        margin-bottom: 8px;
    }
    
    .progress-bar {
        height: 10px;
        background: #e9ecef;
        border-radius: 5px;
        overflow: hidden;
        margin-bottom: 8px;
    }
    
    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #4a6cf7, #667eea);
        border-radius: 5px;
    }
    
    .progress-text {
        font-size: 0.9rem;
        color: #7f8c8d;
    }
    
    .no-book-message, .no-projects-message {
        text-align: center;
        padding: 30px 20px;
    }
    
    .no-book-message i, .no-projects-message i {
        font-size: 3rem;
        color: #4a6cf7;
        margin-bottom: 20px;
        opacity: 0.7;
    }
    
    .no-book-message p, .no-projects-message p {
        font-size: 1.1rem;
        color: #7f8c8d;
        margin-bottom: 20px;
    }
    
    .quick-actions-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 15px;
    }
    
    .action-item {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 12px;
        padding: 20px 15px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 12px;
    }
    
    .action-item:hover {
        background: white;
        border-color: #4a6cf7;
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(74, 108, 247, 0.15);
    }
    
    .action-icon {
        width: 50px;
        height: 50px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        color: white;
    }
    
    .action-item span {
        font-size: 0.9rem;
        font-weight: 500;
        color: #2c3e50;
    }
    
    .projects-list {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }
    
    .project-item {
        padding: 15px;
        border-radius: 12px;
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        transition: all 0.3s ease;
    }
    
    .project-item:hover {
        background: white;
        border-color: #4a6cf7;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
    }
    
    .project-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }
    
    .project-info h4 {
        font-size: 1.1rem;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 0;
    }
    
    .project-status {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
    }
    
    .status-draft {
        background: rgba(245, 158, 11, 0.15);
        color: #f59e0b;
    }
    
    .status-published {
        background: rgba(16, 185, 129, 0.15);
        color: #10b981;
    }
    
    .status-in-progress {
        background: rgba(59, 130, 246, 0.15);
        color: #3b82f6;
    }
    
    .project-progress {
        margin-bottom: 15px;
    }
    
    .project-actions .btn {
        padding: 6px 12px;
        font-size: 0.9rem;
    }
    
    .activities-list {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    
    .activity-item {
        display: flex;
        gap: 15px;
        padding: 15px;
        border-radius: 12px;
        background: #f8f9fa;
        border: 1px solid #e9ecef;
    }
    
    .activity-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        background: rgba(74, 108, 247, 0.1);
        color: #4a6cf7;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
        flex-shrink: 0;
    }
    
    .activity-content {
        flex: 1;
    }
    
    .activity-content h4 {
        font-size: 1rem;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 5px;
    }
    
    .activity-content p {
        font-size: 0.9rem;
        color: #7f8c8d;
        margin-bottom: 8px;
    }
    
    .activity-time {
        font-size: 0.8rem;
        color: #95a5a6;
    }
    
    .no-activities-message {
        text-align: center;
        padding: 30px 20px;
    }
    
    .no-activities-message i {
        font-size: 2.5rem;
        color: #4a6cf7;
        margin-bottom: 15px;
        opacity: 0.7;
    }
    
    .no-activities-message p {
        font-size: 1rem;
        color: #7f8c8d;
        margin-bottom: 0;
    }
    
    .premium-features-card .card-header {
        text-align: center;
        flex-direction: column;
        gap: 10px;
    }
    
    .premium-features-card .card-header h3 {
        font-size: 1.5rem;
    }
    
    .premium-features-card .card-header p {
        font-size: 1.1rem;
        color: #7f8c8d;
        margin-bottom: 0;
    }
    
    .features-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 25px;
    }
    
    .feature-item {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 20px 15px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 1px solid #e9ecef;
    }
    
    .feature-item:hover {
        background: white;
        border-color: #4a6cf7;
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(74, 108, 247, 0.15);
    }
    
    .feature-icon {
        width: 50px;
        height: 50px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        color: white;
        margin: 0 auto 15px;
    }
    
    .bg-purple {
        background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
    }
    
    .bg-orange {
        background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
    }
    
    .bg-teal {
        background: linear-gradient(135deg, #14b8a6 0%, #0d9488 100%);
    }
    
    .bg-red {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    }
    
    .feature-item h4 {
        font-size: 1.1rem;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 8px;
    }
    
    .feature-item p {
        font-size: 0.9rem;
        color: #7f8c8d;
        margin-bottom: 0;
    }
    
    .upgrade-cta {
        text-align: center;
        padding-top: 20px;
        border-top: 1px solid rgba(0, 0, 0, 0.05);
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #4a6cf7 0%, #667eea 100%);
        border: none;
        padding: 12px 25px;
        font-size: 1rem;
        font-weight: 600;
        border-radius: 10px;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(74, 108, 247, 0.3);
    }
    
    .btn-primary:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(74, 108, 247, 0.4);
    }
    
    @@media (max-width: 992px) {
        .main-content-area {
            grid-template-columns: 1fr;
        }
        
        .stats-grid {
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }
    }
    
    @@media (max-width: 768px) {
        .dashboard-header {
            flex-direction: column;
            gap: 20px;
            text-align: center;
        }
        
        .user-stats {
            justify-content: center;
        }
        
        .book-info {
            flex-direction: column;
            text-align: center;
        }
        
        .project-info {
            flex-direction: column;
            gap: 10px;
            align-items: flex-start;
        }
    }
</style>

<!-- Main Dashboard Content -->
<div class="dashboard-wrapper">
    <!-- Welcome Section -->
    <div class="dashboard-header">
        <div class="welcome-section">
            <h1>Home</h1>
            <p>Your complete eBook publishing command center</p>
        </div>
        <div class="user-greeting-card">
            <div class="user-info">
                <h2>Welcome back, @Model.UserName!</h2>
                <p>Ready to create amazing books today?</p>
            </div>
            <div class="user-stats">
                <div class="stat-item">
                    <span class="stat-value">@Model.TotalBooksPublished</span>
                    <span class="stat-label">Books Published</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value">@Model.AverageRating</span>
                    <span class="stat-label">Average Rating</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Overview - Only show Books Published (real data from database) -->
    <div class="stats-overview">
        <div class="stats-grid">
            <div class="stat-card" data-aos="fade-up" data-aos-delay="100">
                <div class="stat-icon bg-primary">
                    <i class="fas fa-book"></i>
                </div>
                <div class="stat-content">
                    <h3>@Model.TotalBooksPublished</h3>
                    <p>Books Published</p>
                </div>
            </div>
            @* Only show revenue if there's actual data *@
            @if (Model.MonthlyRevenue > 0)
            {
                <div class="stat-card" data-aos="fade-up" data-aos-delay="200">
                    <div class="stat-icon bg-success">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="stat-content">
                        <h3>@Model.MonthlyRevenue.ToString("C")</h3>
                        <p>Monthly Revenue</p>
                    </div>
                </div>
            }
            @* Only show downloads if there's actual data *@
            @if (Model.TotalDownloads > 0)
            {
                <div class="stat-card" data-aos="fade-up" data-aos-delay="300">
                    <div class="stat-icon bg-warning">
                        <i class="fas fa-download"></i>
                    </div>
                    <div class="stat-content">
                        <h3>@Model.TotalDownloads</h3>
                        <p>Total Downloads</p>
                    </div>
                </div>
            }
            @* Only show rating if there's actual data *@
            @if (Model.AverageRating > 0)
            {
                <div class="stat-card" data-aos="fade-up" data-aos-delay="400">
                    <div class="stat-icon bg-info">
                        <i class="fas fa-star"></i>
                    </div>
                    <div class="stat-content">
                        <h3>@Model.AverageRating.ToString("F1")</h3>
                        <p>Average Rating</p>
                    </div>
                </div>
            }
        </div>
    </div>

    <!-- Main Content Area -->
    <div class="main-content-area">
        <!-- Left Column -->
        <div class="content-column">
            <!-- Current Working Book -->
            <div class="card current-book-card">
                <div class="card-header">
                    <h3><i class="fas fa-book-open"></i> Currently Working On</h3>
                    <div class="card-actions">
                        <button class="btn btn-outline-primary btn-sm" onclick="editCurrentBook()">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    @if (Model.CurrentWorkingBook != null && !string.IsNullOrEmpty(Model.CurrentWorkingBook.Title))
                    {
                        <div class="book-info">
                            <div class="book-cover-placeholder">
                                <i class="fas fa-book"></i>
                            </div>
                            <div class="book-details">
                                <h4>@Model.CurrentWorkingBook.Title</h4>
                                <p class="book-id">ID: @Model.CurrentWorkingBook.BookIdText</p>
                                <div class="progress-container">
                                    <div class="progress-label">Progress</div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: @(Model.CurrentWorkingBook?.ProgressPercentage)%"></div>
                                    </div>
                                    <div class="progress-text">@Model.CurrentWorkingBook?.ProgressText</div>
                                </div>
                            </div>
                        </div>
                    }
                    else
                    {
                        <div class="no-book-message">
                            <i class="fas fa-book"></i>
                            <p>No active project</p>
                            <button class="btn btn-primary" onclick="window.location.href='/Books/AIGenerateBook'">
                                <i class="fas fa-plus"></i> Start New Book
                            </button>
                        </div>
                    }
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card quick-actions-card">
                <div class="card-header">
                    <h3><i class="fas fa-bolt"></i> Quick Actions</h3>
                </div>
                <div class="card-body">
                    <div class="quick-actions-grid">
                        <button class="action-item" onclick="window.location.href='/Books/AIGenerateBook'">
                            <div class="action-icon bg-primary">
                                <i class="fas fa-edit"></i>
                            </div>
                            <span>AI Writer</span>
                        </button>
                        <button class="action-item" onclick="window.location.href='/Dashboard/Styling'">
                            <div class="action-icon bg-success">
                                <i class="fas fa-paint-brush"></i>
                            </div>
                            <span>Styling</span>
                        </button>
                        <button class="action-item" onclick="window.location.href='/Dashboard/Preview'">
                            <div class="action-icon bg-warning">
                                <i class="fas fa-eye"></i>
                            </div>
                            <span>Preview</span>
                        </button>
                        <button class="action-item" onclick="window.location.href='/Dashboard/GenerateFormat'">
                            <div class="action-icon bg-info">
                                <i class="fas fa-file-export"></i>
                            </div>
                            <span>Export</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column -->
        <div class="content-column">
            <!-- Current Projects -->
            <div class="card projects-card">
                <div class="card-header">
                    <h3><i class="fas fa-project-diagram"></i> Current Projects</h3>
                    <div class="card-actions">
                        <button class="btn btn-outline-primary btn-sm" onclick="window.location.href='/Dashboard/MyBooks'">
                            View All
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    @if (Model.CurrentProjects != null && Model.CurrentProjects.Any())
                    {
                        <div class="projects-list">
                            @foreach (var project in Model.CurrentProjects.Take(3))
                            {
                                <div class="project-item">
                                    <div class="project-info">
                                        <h4>@project.Title</h4>
                                        <span class="project-status status-@project.Status.ToLower()">@project.Status</span>
                                    </div>
                                    <div class="project-progress">
                                        <div class="progress-bar">
                                            <div class="progress-fill" style="width: @project.ProgressPercentage%"></div>
                                        </div>
                                        <div class="progress-text">@project.ProgressText</div>
                                    </div>
                                    <div class="project-actions">
                                        <button class="btn btn-primary btn-sm" onclick="editProject(@project.BookId)">
                                            <i class="fas fa-edit"></i> Continue
                                        </button>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="no-projects-message">
                            <i class="fas fa-folder-open"></i>
                            <p>No projects yet</p>
                            <button class="btn btn-primary" onclick="window.location.href='/Books/AIGenerateBook'">
                                <i class="fas fa-plus"></i> Create Your First Book
                            </button>
                        </div>
                    }
                </div>
            </div>

        </div>
    </div>

    <!-- Premium Features Section -->
    <div class="card premium-features-card">
        <div class="card-header">
            <h3><i class="fas fa-crown"></i> Unlock Premium Features</h3>
            <p>Take your publishing to the next level</p>
        </div>
        <div class="card-body">
            <div class="features-grid">
                <div class="feature-item" onclick="showFeatureModal('AI Cover Design')">
                    <div class="feature-icon bg-purple">
                        <i class="fas fa-palette"></i>
                    </div>
                    <h4>AI Cover Design</h4>
                    <p>Create stunning book covers with AI</p>
                </div>
                <div class="feature-item" onclick="showFeatureModal('Audio Book Creation')">
                    <div class="feature-icon bg-orange">
                        <i class="fas fa-microphone"></i>
                    </div>
                    <h4>Audio Books</h4>
                    <p>Convert your books to audio format</p>
                </div>
                <div class="feature-item" onclick="showFeatureModal('Advanced Analytics')">
                    <div class="feature-icon bg-teal">
                        <i class="fas fa-chart-bar"></i>
                    </div>
                    <h4>Analytics</h4>
                    <p>Track sales and reader engagement</p>
                </div>
                <div class="feature-item" onclick="showFeatureModal('Priority Support')">
                    <div class="feature-icon bg-red">
                        <i class="fas fa-rocket"></i>
                    </div>
                    <h4>Priority Support</h4>
                    <p>Get help when you need it most</p>
                </div>
            </div>
            <div class="upgrade-cta">
                <button class="btn btn-primary btn-lg" onclick="showPricingPlans()">
                    <i class="fas fa-crown"></i> View All Plans
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Anti-Forgery Token -->
@Html.AntiForgeryToken()

<!-- Enhanced JavaScript -->
<script>
    // Enhanced dashboard JavaScript
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize AOS animations
        AOS.init({
            duration: 800,
            easing: 'ease-in-out',
            once: true
        });
        
        // Set up CSRF token
        setupCSRFToken();
        
        // Load cart item count
        loadCartItemCount();
        
        // Animate counters if present
        if (document.querySelectorAll('.stat-value[data-target]').length > 0) {
            animateCounters();
        }
    });
    
    // Setup CSRF token for AJAX requests
    function setupCSRFToken() {
        const token = $('input[name="__RequestVerificationToken"]').val();
        if (token) {
            // Setup jQuery AJAX defaults
            $.ajaxSetup({
                beforeSend: function(xhr) {
                    xhr.setRequestHeader('RequestVerificationToken', token);
                }
            });
            window.csrfToken = token;
        }
    }
    
    // Load cart item count
    function loadCartItemCount() {
        $.get('/Features/GetCartSummary')
            .done(function(data) {
                if (data.success) {
                    $('#cartItemCount').text(data.count);
                    if (data.count > 0) {
                        $('#checkoutButton').show();
                    } else {
                        $('#checkoutButton').hide();
                    }
                }
            })
            .fail(function() {
                console.log('Failed to load cart item count');
            });
    }
    
    // Animate counters
    function animateCounters() {
        const counters = document.querySelectorAll('.stat-value[data-target]');
        counters.forEach(counter => {
            const target = parseInt(counter.getAttribute('data-target'));
            const duration = 2000;
            const increment = target / (duration / 16);
            let current = 0;
            
            const timer = setInterval(() => {
                current += increment;
                if (current >= target) {
                    clearInterval(timer);
                    counter.textContent = target.toLocaleString();
                } else {
                    counter.textContent = Math.ceil(current).toLocaleString();
                }
            }, 16);
        });
    }
    
    // Show feature modal
    function showFeatureModal(featureType) {
        showPlanFeaturesModal();
    }
    
    // Show pricing plans
    function showPricingPlans() {
        if (typeof showPlanFeaturesModal === 'function') {
            showPlanFeaturesModal();
        } else {
            window.location.href = '/Dashboard/Subscriptions';
        }
    }
    
    // Edit current book
    function editCurrentBook() {
        Swal.fire({
            title: 'Edit Book',
            text: 'Opening book editor...',
            icon: 'info',
            timer: 1500,
            timerProgressBar: true,
            showConfirmButton: false
        }).then(() => {
            window.location.href = '/Books/Edit/12345';
        });
    }
    
    // Edit project
    function editProject(projectId) {
        Swal.fire({
            title: 'Continue Project',
            text: 'Loading project...',
            icon: 'info',
            timer: 1000,
            timerProgressBar: true,
            showConfirmButton: false
        }).then(() => {
            window.location.href = '/Books/Edit/' + projectId;
        });
    }
    
    // Show plan features modal
    function showPlanFeaturesModal() {
        if (typeof Swal === 'undefined') { 
            const s = document.createElement('script'); 
            s.src = 'https://cdn.jsdelivr.net/npm/sweetalert2@11'; 
            document.head.appendChild(s); 
        }
        
        (async function(){
            try {
                const res = await fetch('/Plans/GetPlanFeatures');
                if (!res.ok) throw new Error('Failed to load features');
                const features = await res.json();
                let list = (features || []).map(f => `
                    <label style="display:block;border:1px solid #e5e7eb;border-radius:14px;padding:14px;background:#fff;box-shadow:0 6px 18px rgba(0,0,0,.04)">
                        <div style="display:flex;gap:12px;align-items:flex-start">
                            <input type="checkbox" class="feat-check" value="${f.featureId}" data-name="${(f.featureName||'').replace(/"/g,'&quot;')}" data-price="${f.featureRate||0}" />
                            <div style="flex:1">
                                <div style="display:flex;justify-content:space-between;align-items:center">
                                    <strong>${f.featureName}</strong>
                                    <span style="font-weight:800">$${Number(f.featureRate||0).toFixed(2)}</span>
                                </div>
                                <div style="color:#6b7280;font-size:.9rem;margin-top:4px">${f.description || ''}</div>
                            </div>
                        </div>
                    </label>`).join('');
                const html = `
                    <div style="max-height:60vh;overflow:auto">
                        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px">${list}</div>
                    </div>
                    <div style="margin-top:12px;display:flex;justify-content:space-between;align-items:center;border-top:1px solid #eee;padding-top:12px">
                        <div><strong>Selected:</strong> <span id="featCount">0</span> Â· <strong>Total:</strong> $<span id="featTotal">0.00</span></div>
                        <div style="display:flex;gap:8px">
                            <button class="btn btn-secondary btn-sm" id="btnAddToCartDash"><i class="fas fa-cart-plus"></i> Add Selected to Cart</button>
                            <button class="btn btn-primary btn-sm" id="btnGoSummaryDash">Go to Summary</button>
                        </div>
                    </div>`;
                Swal.fire({ 
                    title: 'Select Features', 
                    html, 
                    width: '1000px', 
                    showConfirmButton: false, 
                    showCloseButton: true, 
                    didOpen: () => {
                        function recalc(){ 
                            const checks = document.querySelectorAll('.feat-check:checked'); 
                            let total = 0; 
                            checks.forEach(ch => total += Number(ch.dataset.price||0)); 
                            document.getElementById('featCount').textContent = checks.length; 
                            document.getElementById('featTotal').textContent = total.toFixed(2);
                        } 
                        document.querySelectorAll('.feat-check').forEach(ch => ch.addEventListener('change', recalc)); 
                        recalc();
                        
                        document.getElementById('btnAddToCartDash').addEventListener('click', ()=>{
                            const checks = Array.from(document.querySelectorAll('.feat-check:checked')); 
                            if(checks.length === 0){ 
                                Swal.fire('Info','Please select at least one feature.','info'); 
                                return; 
                            }
                            const items = checks.map(ch => ({ 
                                id: Number(ch.value), 
                                type:'feature', 
                                name: ch.dataset.name||'Feature', 
                                price: Number(ch.dataset.price||0) 
                            }));
                            
                            if (window.CartManager && typeof CartManager.addItems === 'function') { 
                                CartManager.addItems(items); 
                                CartManager.open(); 
                            } else { 
                                const cart = getCart(); 
                                items.forEach(it => { 
                                    if(!cart.items.some(x => x.id === it.id)) 
                                        cart.items.push(it); 
                                }); 
                                setCart(cart); 
                            }
                            Swal.fire('Added','Selected features added to cart.','success');
                        });
                        
                        document.getElementById('btnGoSummaryDash').addEventListener('click', async ()=>{
                            const checks = Array.from(document.querySelectorAll('.feat-check:checked')); 
                            if(checks.length === 0){ 
                                Swal.fire('Info','Please select at least one feature.','info'); 
                                return; 
                            }
                            const ids = checks.map(ch => Number(ch.value));
                            
                            if (window.CartManager && typeof CartManager.addItems === 'function') { 
                                const items = checks.map(ch => ({ 
                                    id: Number(ch.value), 
                                    type:'feature', 
                                    name: ch.dataset.name||'Feature', 
                                    price: Number(ch.dataset.price||0) 
                                })); 
                                CartManager.addItems(items); 
                            }
                            
                            try { 
                                Swal.fire({
                                    title:'Creating bill...', 
                                    didOpen:()=>Swal.showLoading(), 
                                    allowOutsideClick:false, 
                                    allowEscapeKey:false, 
                                    showConfirmButton:false
                                }); 
                                const billId = await CartManager.createBillFromFeatures(ids); 
                                Swal.close(); 
                                window.location.href = `/Payments/PaymentSummary?billId=${billId}`; 
                            } catch(e){ 
                                Swal.close(); 
                                window.location.href = `/Payments/PaymentSummaryFromFeatures?featureIds=${ids.join(',')}`; 
                            }
                        });
                    }
                });
            } catch(e){ 
                if (typeof Swal !== 'undefined') 
                    Swal.fire('Error', e.message || 'Could not load features.', 'error'); 
            }
        })();
    }
    
    // Cart helpers (shared)
    function getCart() { 
        try { 
            return JSON.parse(localStorage.getItem('cart') || '{"items":[]}'); 
        } catch { 
            return { items: [] }; 
        } 
    }
    
    function setCart(cart) { 
        localStorage.setItem('cart', JSON.stringify(cart)); 
    }
</script>