@{
    ViewData["Title"] = "Book Styling";
    Layout = "~/Views/Shared/_DashboardLayout.cshtml";
}

<style>
    :root {
        --primary: #7c3aed;
        --secondary: #06b6d4;
        --surface: #ffffff;
        --background: #f8fafc;
        --text-primary: #1e293b;
        --border: #e2e8f0;
        --shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        --radius: 16px;
    }

    .page-container {
        width: 100%;
        padding: 30px;
        background: var(--background);
        min-height: 100vh;
    }

    .page-header h1 {
        font-size: 2.5rem;
        font-weight: 800;
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 10px;
    }

    .card {
        background: var(--surface);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        border: 1px solid var(--border);
        padding: 30px;
        margin-bottom: 24px;
    }

    .card-header {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 20px;
        color: var(--text-primary);
        border-bottom: 2px solid var(--border);
        padding-bottom: 12px;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-label {
        display: block;
        font-weight: 600;
        margin-bottom: 8px;
        color: var(--text-primary);
    }

    .form-control {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid var(--border);
        border-radius: 8px;
        font-size: 1rem;
    }

    .form-control:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 4px rgba(124, 58, 237, 0.1);
    }

    .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
    }

    .btn-primary {
        background: linear-gradient(135deg, var(--primary), var(--secondary));
        color: white;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
    }

    .premium-banner {
        background: linear-gradient(135deg, #f59e0b, #ec4899);
        color: white;
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 24px;
        text-align: center;
    }

    .style-template {
        border: 2px solid var(--border);
        border-radius: 12px;
        padding: 20px;
        cursor: pointer;
        transition: all 0.3s;
        text-align: center;
    }

    .style-template:hover {
        border-color: var(--primary);
        transform: translateY(-4px);
        box-shadow: var(--shadow);
    }

    .style-template.selected {
        border-color: var(--primary);
        background: rgba(124, 58, 237, 0.05);
    }
</style>

<div class="page-container">
    <div class="page-header">
        <h1><i class="fas fa-paint-brush"></i> Book Styling</h1>
        <p>Customize the appearance of your book</p>
    </div>

    @if (!ViewBag.HasStylingFeature)
    {
        <div class="premium-banner">
            <h3><i class="fas fa-crown"></i> Premium Feature</h3>
            <p>Styling features require a premium subscription. <a href="/Dashboard/Subscriptions" style="color:white;text-decoration:underline;">Upgrade Now</a></p>
        </div>
    }

    <!-- Book Selection -->
    <div class="card">
        <div class="card-header">Select Book</div>
        <div class="form-group">
            <label class="form-label">Choose Book to Style</label>
            <select id="bookSelect" class="form-control" onchange="loadBookStyles(this.value)">
                <option value="">-- Select Book --</option>
                @if (ViewBag.UserBooks != null)
                {
                    @foreach (var book in ViewBag.UserBooks)
                    {
                        var isSelected = ViewBag.SelectedBookId != null && ViewBag.SelectedBookId == book.BookId;
                        <option value="@book.BookId" selected="@(isSelected ? "selected" : null)">
                            @book.Title
                        </option>
                    }
                }
            </select>
        </div>
        <input type="hidden" id="userId" value="@ViewBag.UserId" />
        <input type="hidden" id="currentBookId" value="@ViewBag.SelectedBookId" />
    </div>

    @if (ViewBag.HasStylingFeature)
    {
        <!-- Style Templates -->
        <div class="card">
            <div class="card-header">Style Templates</div>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                <div class="style-template" onclick="selectTemplate('classic')">
                    <h4>Classic</h4>
                    <p>Traditional book style</p>
                </div>
                <div class="style-template" onclick="selectTemplate('modern')">
                    <h4>Modern</h4>
                    <p>Contemporary design</p>
                </div>
                <div class="style-template" onclick="selectTemplate('minimal')">
                    <h4>Minimal</h4>
                    <p>Clean and simple</p>
                </div>
                <div class="style-template" onclick="selectTemplate('elegant')">
                    <h4>Elegant</h4>
                    <p>Sophisticated look</p>
                </div>
            </div>
        </div>

        <!-- Style Customization -->
        <div class="card">
            <div class="card-header">Style Customization</div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Drop Caps</label>
                    <select class="form-control" id="stDropCaps">
                        <option value="off">Off</option>
                        <option value="on">On</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Embedded Font</label>
                    <select class="form-control" id="stFont">
                        <option value="Georgia">Georgia</option>
                        <option value="Times New Roman">Times New Roman</option>
                        <option value="Arial">Arial</option>
                        <option value="Helvetica">Helvetica</option>
                        <option value="Merriweather">Merriweather</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Background Color</label>
                    <input type="color" class="form-control" id="stBgColor" value="#ffffff" style="height:50px;">
                </div>
                <div class="form-group">
                    <label class="form-label">Chapter Title Font</label>
                    <select class="form-control" id="stChapterFont">
                        <option value="inherit">Inherit</option>
                        <option value="bold">Bold</option>
                        <option value="italic">Italic</option>
                        <option value="Georgia">Georgia</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Line Height</label>
                    <input type="number" class="form-control" id="stLineHeight" value="1.5" step="0.1" min="1" max="3">
                </div>
                <div class="form-group">
                    <label class="form-label">Text Justification</label>
                    <select class="form-control" id="stJustify">
                        <option value="left">Left</option>
                        <option value="center">Center</option>
                        <option value="right">Right</option>
                        <option value="justify">Justify</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <button class="btn btn-primary" onclick="saveStylePreferences()">
                    <i class="fas fa-save"></i> Save Style Preferences
                </button>
                <span id="styleStatus" class="status-message" style="display:none;margin-left:12px;"></span>
            </div>
        </div>
    }
</div>

<script>
    function getBookId() {
        const bookId = document.getElementById('currentBookId')?.value || document.getElementById('bookSelect')?.value;
        if (!bookId) {
            alert('Please select a book first');
            return null;
        }
        return parseInt(bookId);
    }

    function loadBookStyles(bookId) {
        if (bookId) {
            document.getElementById('currentBookId').value = bookId;
            window.location.href = `/Dashboard/Styling?bookId=${bookId}`;
        }
    }

    function selectTemplate(templateName) {
        document.querySelectorAll('.style-template').forEach(el => el.classList.remove('selected'));
        event.target.closest('.style-template').classList.add('selected');
        // Apply template defaults
        // This would load template presets from database
    }

    // Save style preferences - Database connected
    async function saveStylePreferences() {
        const bookId = getBookId();
        if (!bookId) return;

        const payload = {
            dropCaps: document.getElementById('stDropCaps').value,
            font: document.getElementById('stFont').value,
            bgColor: document.getElementById('stBgColor').value,
            chapterFont: document.getElementById('stChapterFont').value,
            lineHeight: document.getElementById('stLineHeight').value,
            justify: document.getElementById('stJustify').value
        };

        const status = document.getElementById('styleStatus');
        status.textContent = 'Saving...';
        status.style.display = 'inline-block';

        try {
            const res = await fetch(`/Books/SaveStylePreferences?bookId=${bookId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            if (res.status === 402) {
                status.textContent = 'Premium feature required';
                status.className = 'status-message status-error';
                return;
            }
            
            const result = await res.json();
            if (result.success) {
                status.textContent = 'Style preferences saved!';
                status.className = 'status-message status-success';
            } else {
                status.textContent = 'Save failed';
                status.className = 'status-message status-error';
            }
        } catch (e) {
            status.textContent = 'Error: ' + e.message;
            status.className = 'status-message status-error';
        }
    }

    // Load existing style preferences from database
    document.addEventListener('DOMContentLoaded', function() {
        @if (ViewBag.StylePreferences != null)
        {
            <text>
            try {
                const prefs = JSON.parse('@Html.Raw(ViewBag.StylePreferences)');
                if (prefs.dropCaps) document.getElementById('stDropCaps').value = prefs.dropCaps;
                if (prefs.font) document.getElementById('stFont').value = prefs.font;
                if (prefs.bgColor) document.getElementById('stBgColor').value = prefs.bgColor;
                if (prefs.chapterFont) document.getElementById('stChapterFont').value = prefs.chapterFont;
                if (prefs.lineHeight) document.getElementById('stLineHeight').value = prefs.lineHeight;
                if (prefs.justify) document.getElementById('stJustify').value = prefs.justify;
            } catch (e) {
                console.error('Error loading preferences:', e);
            }
            </text>
        }
    });
</script>

