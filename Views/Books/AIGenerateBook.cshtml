@{
    ViewData["Title"] = "AI Book Generator";
    Layout = "~/Views/Shared/_DashboardLayout.cshtml";
}

<style>
    :root {
        --primary: #7c3aed;
        --primary-light: #8b5cf6;
        --primary-dark: #6d28d9;
        --secondary: #06b6d4;
        --accent: #f59e0b;
        --surface: #ffffff;
        --background: #f8fafc;
        --text-primary: #1e293b;
        --text-secondary: #64748b;
        --border: #e2e8f0;
        --radius: 8px;
        --transition: all 0.2s ease;
    }

    .medium-input {
        width: 360px; /* Adjust as needed */
        height: 25px;
        font-size: 12px;
        padding: 2px 5px;
    }
    .small-input {
        width: 80px; /* Adjust as needed */
        height: 25px;
        font-size: 12px;
        padding: 2px 5px;
    }
    .main-container {
        max-width: 1200px;
        margin: 0;
        padding: 20px;
        min-height: 100vh;
    }

    .header {
        text-align: left;
        margin-bottom: 25px;
    }

        .header h2 {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .header p {
            font-size: 0.95rem;
            color: var(--text-secondary);
            margin: 0;
            line-height: 1.4;
        }

    .premium-buttons {
        margin-bottom: 20px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .generator-card {
        background: var(--surface);
        border-radius: var(--radius);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        border: 1px solid var(--border);
        margin-bottom: 25px;
        max-width: 900px;
    }

    .card-body {
        padding: 20px;
    }

    /* Form Elements - Compact */
    .form-group {
        margin-bottom: 15px;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-bottom: 15px;
    }

    .form-label {
        display: block;
        font-size: 0.8rem;
        font-weight: 600;
        margin-bottom: 5px;
        color: var(--text-primary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        line-height: 1.2;
    }

    .chapter-label {
        font-weight: bold;
        font-size: 0.85rem;
        color: #2563eb;
    }

    /* Wider Inputs */
    .form-control-Input {
        width: 100%;
        padding: 8px 12px;
        border: 1.5px solid var(--border);
        border-radius: 6px;
        font-size: 0.9rem;
        transition: var(--transition);
        background: var(--surface);
        height: 38px;
        display: block;
    }

        .form-control-Input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
        }

    .form-control {
        width: 100%;
        padding: 8px 12px;
        border: 1.5px solid var(--border);
        border-radius: 6px;
        font-size: 0.9rem;
        transition: var(--transition);
        background: var(--surface);
        height: 38px;
    }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
        }

    .form-control2 {
        width: 100%;
        padding: 10px 12px;
        border: 1.5px solid var(--border);
        border-radius: 6px;
        font-size: 0.9rem;
        transition: var(--transition);
        background: var(--surface);
        resize: vertical;
        min-height: 200px;
        font-family: inherit;
    }

        .form-control2:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
        }

    /* Dropdown Container */
    .dropdown-container {
        display: flex;
        gap: 10px;
        align-items: end;
        margin-bottom: 15px;
    }

        .dropdown-container .form-label {
            flex-shrink: 0;
            width: 120px;
        }

        .dropdown-container select {
            flex: 1;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 20 20' fill='none' stroke='%2364748b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 35px;
        }

    /* Buttons */
    .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        padding: 8px 16px;
        border: none;
        border-radius: 6px;
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        text-decoration: none;
        height: 36px;
    }

    .btn-primary {
        background: var(--primary);
        color: white;
    }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

    .btn-secondary {
        background: #6b7280;
        color: white;
    }

        .btn-secondary:hover {
            background: #4b5563;
            transform: translateY(-1px);
        }

    .btn-success {
        background: #10b981;
        color: white;
    }

        .btn-success:hover {
            background: #059669;
            transform: translateY(-1px);
        }

    .btn-outline-primary {
        background: transparent;
        color: var(--primary);
        border: 1.5px solid var(--primary);
    }

        .btn-outline-primary:hover {
            background: var(--primary);
            color: white;
        }

    .btn-outline-success {
        background: transparent;
        color: #10b981;
        border: 1.5px solid #10b981;
    }

        .btn-outline-success:hover {
            background: #10b981;
            color: white;
        }

    .btn-group {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-top: 20px;
    }

    .custom-small-btn {
        padding: 6px 12px;
        font-size: 0.8rem;
        height: 32px;
        min-width: 80px;
    }

    /* Create Book Button */
    .create-book-btn {
        background-color: #dbeafe;
        border: 1.5px solid #3b82f6;
        color: #1e40af;
        white-space: nowrap;
    }

        .create-book-btn:hover {
            background-color: #3b82f6;
            color: white;
        }

    /* Chat History */
    .book-result {
        background: var(--surface);
        border-radius: var(--radius);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        border: 1px solid var(--border);
        max-width: 900px;
    }

        .book-result h5 {
            padding: 15px 20px;
            margin: 0;
            background: #f8fafc;
            border-bottom: 1px solid var(--border);
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
        }

    .chat-container {
        padding: 20px;
    }

    .message {
        display: flex;
        margin-bottom: 16px;
    }

    .message-ai .message-avatar {
        background: var(--primary);
        color: white;
    }

    .message-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 0.8rem;
        margin-right: 12px;
        flex-shrink: 0;
    }

    .message-content {
        background: #f8fafc;
        padding: 12px 16px;
        border-radius: 12px;
        border-top-left-radius: 4px;
        font-size: 0.9rem;
        line-height: 1.5;
        color: var(--text-primary);
    }

    /* Hidden Fields */
    .hidden-fields {
        display: none;
    }

    /* Search Icon */
    .search-icon {
        background: none;
        border: none;
        cursor: pointer;
        padding: 8px;
        color: var(--text-secondary);
        font-size: 1.1rem;
    }

        .search-icon:hover {
            color: var(--primary);
        }

    /* Responsive */
    @@media (max-width: 768px) {
        .main-container {
            padding: 15px;
        }

        .form-row {
            grid-template-columns: 1fr;
            gap: 10px;
        }

        .dropdown-container {
            flex-direction: column;
            align-items: stretch;
            gap: 8px;
        }

            .dropdown-container .form-label {
                width: auto;
            }

        .btn-group {
            flex-direction: column;
        }

        .btn {
            width: 100%;
            justify-content: center;
        }
    }
    /* In generateBook() show loader */
    /* Loading States */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(5px);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        flex-direction: column;
        gap: 20px;
    }

    .loading-spinner {
        width: 50px;
        height: 50px;
        border: 4px solid #f3f4f6;
        border-top: 4px solid #7c3aed;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    .loading-text {
        font-size: 1.1rem;
        color: #374151;
        font-weight: 500;
    }

    .loading-dots {
        display: flex;
        gap: 4px;
    }

    .loading-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #7c3aed;
        animation: bounce 1.4s infinite ease-in-out;
    }

        .loading-dot:nth-child(1) {
            animation-delay: -0.32s;
        }

        .loading-dot:nth-child(2) {
            animation-delay: -0.16s;
        }

    @@keyframes spin {
        0%

    {
        transform: rotate(0deg);
    }

    100% {
        transform: rotate(360deg);
    }

    }

    @@keyframes bounce {
        0%, 80%, 100%

    {
        transform: scale(0.8);
        opacity: 0.5;
    }

    40% {
        transform: scale(1);
        opacity: 1;
    }

    }

    /* Button loading states */
    .btn-loading {
        position: relative;
        color: transparent !important;
    }

        .btn-loading::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            top: 50%;
            left: 50%;
            margin-top: -10px;
            margin-left: -10px;
        }

    /* Form loading state */
    .form-loading {
        position: relative;
        pointer-events: none;
        opacity: 0.7;
    }

        .form-loading::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            z-index: 1;
            border-radius: var(--radius);
        }

    /* Specific element loading */
    .input-loading {
        background: linear-gradient(90deg, #f3f4f6 25%, #e5e7eb 50%, #f3f4f6 75%);
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
        color: transparent;
    }

    @@keyframes shimmer {
        0%

    {
        background-position: -200% 0;
    }

    100% {
        background-position: 200% 0;
    }

    }

    /* Progress bar */
    .loading-progress {
        width: 200px;
        height: 4px;
        background: #e5e7eb;
        border-radius: 2px;
        overflow: hidden;
        margin-top: 10px;
    }

    .loading-progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #7c3aed, #8b5cf6);
        border-radius: 2px;
        animation: progress 2s ease-in-out infinite;
    }

    @@keyframes progress {
        0%

    {
        transform: translateX(-100%);
    }

    50% {
        transform: translateX(0%);
    }

    100% {
        transform: translateX(100%);
    }

    }

    .readonly-disabled:hover {
        background-color: #6c757d !important;
        border-color: #6c757d !important;
        transform: none !important;
    }

    /* Optional: Visual indicator for ReadOnly books */
    .readonly-indicator {
        background-color: #f8f9fa;
        border-left: 4px solid #dc3545;
        padding: 8px 12px;
        margin: 10px 0;
        border-radius: 4px;
        font-weight: bold;
        color: #dc3545;
    }

    .generate-btn {
        background: linear-gradient(45deg, #6a11cb, #2575fc) !important;
        border: none !important;
        color: white !important;
        font-weight: bold !important;
        box-shadow: 0 4px 15px rgba(106, 17, 203, 0.4) !important;
        transition: all 0.3s ease !important;
    }

        .generate-btn:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.6) !important;
        }

        .generate-btn:disabled {
            background: #90EE90 !important; /* Light green */
            transform: none !important;
            box-shadow: none !important;
        }

    .add-chapter-btn {
        background: #007bff;
        color: white;
        border: 0;
        border-radius: 20px;
        padding: 4px 10px;
        font: bold 12px sans-serif;
        cursor: pointer;
        margin-bottom: 10px;
        box-shadow: 0 3px 6px #0003;
        transition: .2s;
    }

        .add-chapter-btn:hover {
            background: #0056b3;
            transform: scale(1.05);
        }

    .readonly-disabled {
        opacity: 0.6;
        background-color: #f8f9fa !important;
        border-color: #6c757d !important;
        color: #6c757d !important;
    }

    /* For the Generate button specifically when disabled */
    .btn-primary:disabled {
        background-color: #6c757d !important;
        border-color: #6c757d !important;
    }
    /* Loading state styles */
    .btn-loading {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .spinner-border-sm {
        width: 1rem;
        height: 1rem;
    }

    /* Disabled state for all buttons during generation */
    button:disabled {
        opacity: 0.6;
        cursor: not-allowed !important;
    }

    .generate-btn:disabled {
        background-color: #6c757d !important;
        border-color: #6c757d !important;
    }
    /* Divide Page in 2 Columns*/
    .page-layout {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 20px;
    }

    /* Main page takes more space */
    .main-container {
        flex: 3;
    }

    /* Chat sidebar on the right */
    .chat-sidebar {
        flex: 1;
        max-width: 350px;
        position: sticky;
        top: 10px;
        height: calc(100vh - 20px);
        overflow-y: auto;
        background: #ffffff;
        padding: 15px;
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }

    .blinking-message {
        color: #007bff;
        font-weight: bold;
        animation: blink 1s infinite;
        padding: 10px;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
    }

    @@keyframes blink {
        0%

        {
            opacity: 1;
        }

        50% {
            opacity: 0.3;
        }

        100% {
            opacity: 1;
        }

    }
    /* Processing Message Styles */
    .processing-message {
        background: linear-gradient(45deg, #e3f2fd, #bbdefb);
        border: 1px solid #90caf9;
        border-radius: 8px;
        padding: 15px;
        margin: 15px 0;
        display: none;
        align-items: center;
        gap: 12px;
        animation: pulse 2s infinite;
    }

        .processing-message .spinner-border-sm {
            width: 1.2rem;
            height: 1.2rem;
            border-width: 0.2em;
        }

    @@keyframes pulse {
        0%

    {
        box-shadow: 0 0 0 0 rgba(33, 150, 243, 0.4);
    }

    70% {
        box-shadow: 0 0 0 10px rgba(33, 150, 243, 0);
    }

    100% {
        box-shadow: 0 0 0 0 rgba(33, 150, 243, 0);
    }

    }

    /* Auto-hide after 5 minutes */
    .processing-message.auto-hide {
        animation: fadeOut 0.5s ease-in 300s forwards;
    }

    @@keyframes fadeOut {
        to

    {
        opacity: 0;
        display: none;
    }

    }
    /* Confirmation*/
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        backdrop-filter: blur(2px);
    }

    .modal-content {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        min-width: 350px;
        max-width: 500px;
        animation: modalAppear 0.3s ease-out;
    }

    @@keyframes modalAppear {
        from

    {
        opacity: 0;
        transform: translate(-50%, -60%);
    }

    to {
        opacity: 1;
        transform: translate(-50%, -50%);
    }

    }

    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s;
    }

    .btn-primary {
        background: #4a69bd;
        color: white;
    }

        .btn-primary:hover {
            background: #3c5aa8;
            transform: translateY(-2px);
        }

    .btn-secondary {
        background: #6c757d;
        color: white;
    }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }
</style>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<div class="page-layout">
    <div class="main-container">
        <!-- Header -->
        <div class="header">
            <h2>AI Book Generator</h2>
            <p>Transform your ideas into beautifully crafted books with artificial intelligence</p>
        </div>

        <!-- Premium Buttons -->
        <div class="premium-buttons">
            <button id="plansPurchaseBtn" class="btn btn-primary custom-small-btn" onclick="showPricingPlans()">
                <i class="fas fa-crown"></i> View All Plans
            </button>
            <button id="planFeaturesBtn" class="btn btn-primary custom-small-btn" onclick="showPlanFeatures()">
                <i class="fas fa-info-circle"></i> Feature Details
            </button>
           @*  <button id="purchaseHistoryBtn" class="btn btn-secondary custom-small-btn" onclick="showPurchaseHistory()">
                <i class="fas fa-receipt"></i> Purchase History
            </button> *@
        </div>

        <!-- Main Form -->
        <div class="generator-card">
            <div class="card-body">
                <!-- Book Selection -->
                <div class="dropdown-container">
                    <label class="form-label chapter-label" style="color: blue;">BOOK SELECTION</label>
                    <select id="savedResponsesDropdown" class="form-control" onchange="loadSelectedResponse(this.value)">
                        <option value="">Load a previously generated book...</option>
                    </select>
                    <button id="createBookBtn" class="btn custom-small-btn create-book-btn" onclick="createBook()">
                        📖 Create Book
                    </button>
                </div>

                <!-- Hidden Fields  class="hidden-fields"> -->
                <div class="hidden-fields">
                    <label>UserId:</label>
                    <input type="text" id="UserId" value="@ViewBag.UserId">           

                    <label>BookId:</label>
                    <input type="text" id="BookId" value="0">

                    <label>ResponseId:</label>
                    <input type="text" id="ResponseId" value="0">

                    <label>ChapterNo:</label>
                    <input type="text" id="ChapterNo" value="1">
                </div>

                <!-- Book Title -->
                <div class="form-group">
                    <label class="form-label chapter-label" style="color: blue;">BOOK TITLE</label>
                    <input type="text" id="BookTitle" class="form-control-Input" value="" placeholder="Enter book title">
                </div>

                <!-- Chapter Number and Title -->
                <div class="form-row">
                
                        <label class="form-label chapter-label" style="color: blue;">CHAPTER NUMBER</label>
                         <button id="addChapterBtn" class="add-chapter-btn" onclick="addNewChapter()">
                            + Add Chapter
                        </button>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <select id="ChapterDropdown" class="medium-input" onchange="loadBookChapterNos(this.value)">
                                <option value="1" selected>1</option>
                                <option value="0">Load a previously generated chapter numbers...</option>
                            </select>
                             <button id="findShowBtn" class="search-icon" onclick="showSelectedBook()" title="Find & Show">
                                <i class="bi bi-search"></i>Preview
                            </button> 
                            <label class="form-label chapter-label" style="color: blue;">CHAPTER STATUS</label>
                    
                            <input type="text" id="Status" placeholder="Status" value="OK" class="small-input" readonly
                                   style="font-weight: bold; color: red; background-color: #fff;" />
                
                    </div>
                </div>
                <div class="form-row">
                    <label class="form-label chapter-label" style="color: blue;">CHAPTER TITLE</label>
                        <input type="text" id="Title" class="form-control-Input" value="The future of artificial intelligence" placeholder="Enter chapter title">
                </div>

                <!-- Chapter Topic -->
                <div class="form-group">
                    <label class="form-label chapter-label" style="color: blue;">CHAPTER TOPIC</label>
                    <textarea id="UserInput" class="form-control2" placeholder="Enter chapter topic">If you want peace, work for justice</textarea>
                </div>
          
                <!-- Action Buttons -->
                <!-- Processing Message -->

                <div id="processingMessage" class="alert alert-info processing-message" style="display: none;color: blue; font-weight: bold;">
                    <div class="spinner-border spinner-border-sm" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <strong>Processing, please wait...</strong> This may take up to 5 minutes.
                </div>
                <div class="btn-group">
                    <div class="generate-section">
                        <button type="button" id="GenerateBtn" class="btn btn-primary btn-lg generate-btn" onclick="confirmGenerateChapter()" title="Generate Book Chapter using AI">
                            <span class="btn-text">✨ Generate Chapter</span>
                            <span class="btn-loading"> @*  style="display: none;"> *@
                                <span class="spinner-border spinner-border-sm" role="status"></span>
                                Generating...
                            </span>
                        </button>
                    </div>
                    <button id="EditBtn" class="btn btn-outline-primary custom-small-btn" onclick="confirmEditChapter()">
                        🔁 Edit
                    </button>
                    @*  <button class="btn btn-success custom-small-btn" onclick="updateBook()">
                       💾 Update/Save
                     </button> *@
                    <button id="FinalizeBtn" class="btn btn-outline-success custom-small-btn" onclick="finalizeChapter()">
                        ✅ Finalize
                    </button>
                    @* <button id="CancelBtn" class="btn btn-outline-success custom-small-btn" onclick="cancelActions()">
                        ✅ Cancel
                    </button> *@
                </div>
              
                <input type="hidden" id="APIRawResponse">
            </div>
        </div>
    </div>
    <!-- Chat History -->
    <div id="bookResult" class="book-result">
        <h5>💬 Chat History</h5>
        <div id="chatContainer" class="chat-container">
            <div class="message message-ai">
                <div class="message-avatar">AI</div>
                <div class="message-content">
                    Hello! I'm ready to help you create an amazing book. Just enter your topic above and click "Generate Book" to get started.
                </div>
            </div>
        </div>
    </div>
 
   @*  Loading ... *@
    <!-- Global Loading Overlay -->
   @*  <div id="globalLoading" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingMessage">Processing your request...</div>
        <div class="loading-progress">
            <div class="loading-progress-bar"></div>
        </div>
    </div>

    <!-- Inline loading for specific sections -->
    <div id="formLoading" class="loading-overlay" style="display: none; position: absolute; border-radius: var(--radius);">
        <div class="loading-spinner" style="width: 30px; height: 30px;"></div>
    </div> *@

</div>
<!-- Notification Container -->
<div id="notificationContainer"></div>
<!-- Custom Confirmation Modal -->
<div id="confirmationModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); min-width: 300px;">
        <h3 style="margin-top: 0; color: #333;">Confirm Action</h3>
        <p style="margin-bottom: 25px; color: #666;">Are you sure you want to Generate new Chapter?</p>
        <div style="text-align: right;">
            <button id="confirmNo" class="btn btn-secondary" style="margin-right: 10px;">No</button>
            <button id="confirmYes" class="btn btn-primary">Yes</button>
        </div>
    </div>
</div>
<script>

     // -----> Execution Step 2 (exeutes just after controller action method) <-------------
     // Global variables
      let confirmationCallback = null;
      let abortController = null;
     const userId = '@ViewBag.UserId';
     console.log("🔍 Logged-in User ID from ViewBag:", userId);  
     //===(1)============================OK
     //  On Page Load -->Execution Step 3
     //        PAGE INITIALIZATION 
     //===================================
     document.addEventListener('DOMContentLoaded', function()  {
         console.log("🚀 DOM Content Loaded - Starting initialization");
        
         // Load books immediately
         loadSavedBooksDropdown();

         loadBookAllChaptersNumbers();

          // Show debug info after delay
         setTimeout(debugBooks, 1000);

         // Add enter key support
        
         const modal = document.getElementById('confirmationModal');
         const yesBtn = document.getElementById('confirmYes');
         const noBtn = document.getElementById('confirmNo');
          // Yes button click
         yesBtn.addEventListener('click', function() {
             hideConfirmation();
             if (confirmationCallback) {
                 confirmationCallback(true);
             }
         });

         // No button click
         noBtn.addEventListener('click', function() {
             hideConfirmation();
             if (confirmationCallback) {
                 confirmationCallback(false);
             }
         });

         // Close modal when clicking outside
         modal.addEventListener('click', function(e) {
             if (e.target === modal) {
                 hideConfirmation();
                 if (confirmationCallback) {
                     confirmationCallback(false);
                 }
             }
         });
           const userInput = document.getElementById('UserInput');
         if (userInput) {
             userInput.addEventListener('keypress', function(e) {
                 if (e.key === 'Enter') {
                     generateBook();
                 }
             });
         }
         const showBookBtn = document.getElementById('showBookBtn');
        if (showBookBtn) {
            showBookBtn.addEventListener('click', showSelectedBook);
           // console.log("✅ Show button event listener attached");
        }
        // console.log("📄 Page loaded, initializing button states...");

         // Initial check after a short delay to ensure all elements are loaded
        // console.log("✅ Page initialization complete");
     });
    //==================================
    //   Processing, please wait...
    //=================================
     function startProcessing() {
            const messageElement = document.getElementById('processingMessage');
            const generateBtn = document.getElementById('generateBtn');

            // Show processing message
           // messageElement.style.display = 'block';

            // Disable the generate button
            generateBtn.disabled = true;
            generateBtn.innerHTML = 'Generating...';

            // Hide the message after 5 minutes (300,000 milliseconds)
            setTimeout(() => {
              //  messageElement.style.display = 'none';
                generateBtn.disabled = false;
                generateBtn.innerHTML = 'Generate Report';
            }, 300000); // 5 minutes = 300,000 ms

            // Your actual generation logic here
            // This is where you'd call your backend API
            generateReport();
        }

         // Show confirmation modal
    function showConfirmation(message, callback) {
        const modal = document.getElementById('confirmationModal');
        const messageElement = modal.querySelector('p');

        // Set the message
        messageElement.textContent = message;

        // Store the callback
        confirmationCallback = callback;

        // Show modal
        modal.style.display = 'block';
    }

    // Hide confirmation modal
    function hideConfirmation() {
        const modal = document.getElementById('confirmationModal');
        modal.style.display = 'none';
        confirmationCallback = null;
    }
      //===(16-3)============================================OK
      // Load Selected Book from Drop-Down from Books table
      //    if not found then Load same from
      //          RawData table
      //======================================================
      async function loadSelectedResponse(bookId)
      {
          // console.log("Loading loadSelectedResponse Function");
          //  console.log("🔍 Loading selected book:", bookId);
          if (!bookId) {
              resetButtonStates();
              clearBookForm();
              console.log("❌  No book selected - buttons reset");
              return;
          }
          document.getElementById('BookId').value = bookId;
          try
           {
             const userId = document.getElementById("UserId").value;
             if (!userId || userId === "0")
             {
                  throw new Error("User ID not found");
             }
            //   console.log("🔍 Loading book details for user:", userId, "book:", bookId);

           // Load data from  Books + APIRawResponse
           const response = await fetch(`/Books/GetBookDetails?userId=${userId}&bookId=${bookId}`);
           //   console.log("📨 Get Json result:", response);

           if (!response.ok)
           {
               throw new Error("Failed to load book details");
           }

          const result = await response.json();
          // console.log("📚 Loading loadSelectedResponse Function ==>", result);

          // Load Selected Book Data into the FORM
          if (result.success)
          {
              showNotification("Book loaded successfully!", "success");
              // ✅ Get the first chapter (latest or default)
              const latestChapter = result.chapters && result.chapters.length > 0
                     ? result.chapters[0]
                     : null;

              // ✅ Fill the ResponseId field (from last chapter)
              document.getElementById("ResponseId").value = latestChapter ? latestChapter.responseId : "0";

              // ✅ Fill the ChapterNo field (from last chapter)
              document.getElementById("ChapterNo").value = latestChapter ? latestChapter.chapterNo : "1";
              // ✅ Fill other fields
              // ✅ Fill the textarea or content field
              document.getElementById("BookTitle").value = result.bookTitle || "";
              // ✅ Fill the textarea or content field
              document.getElementById("Status").value = latestChapter ? latestChapter.statusCode : "Draft";
              // ✅ Fill the textarea or content field
              document.getElementById("Title").value = latestChapter ? latestChapter.chapterTitle : "";
              // ✅ Fill the textarea or content field
               document.getElementById("UserInput").value = latestChapter ? latestChapter.requestData : "";

              // ✅ Check if book is ReadOnly and disable buttons accordingly
               const statusCode = latestChapter ? latestChapter.statusCode : "Draft";
               checkAndDisableButtonsForReadOnly(statusCode);

              // Load Book Content
              await loadBookAllChaptersNumbers()  // load All Chapter Numbers of this Book
              populateBookForm(result);   // Function to populate FORM's fields with book data
              // showBookContent(result);    // Load Book's Title, ChapterNiData
              showNotification("Book loaded successfully!", "success");
              } else {
                   // clearBookForm();
                   showNotification("Error: " + result.message, "error");
            }
        } catch (error) {
                  console.error("Error loading book details:", error);
                  //clearBookForm();
                  showNotification("Error loading book details: " + error.message, "error");
        }
   }
     //=====(39)===============================OK
     //            Create Book
     //========================================
     async  function createBook()
     {
        try {
           console.log("🔍 Step 1: Collecting UserId from form");

           // ✅ Get only the UserId for redirect
           const userId = document.getElementById('UserId')?.value;

           if (!userId) {
              Swal.fire("Warning", "User ID is required to create a book.", "warning");
              return;
           }

           console.log("🚀 Step 2: Redirecting to CreateBook page with UserId:", userId);

          // ✅ Immediately redirect to CreateBook page with UserId
          window.location.href = `/Books/CreateBook?userId=${userId}`;

          // Refresh dropdown after saving
          console.log("🚀 Step 3: Loading Books Drop-Down :");

          loadSavedBooksDropdown();

        } catch (err) {
                 console.error("🔥 Error in createBook():", err);
                 Swal.fire("Error", err.message || "Unexpected error occurred.", "error");
        }
     }
     //====================================
     //   Add New Chapter Button
     //====================================
      async function addNewChapter() {

               console.log("🔄 Executing addNewChapter function");

          const userId = document.getElementById("UserId").value;
          const bookId = document.getElementById('BookId').value;

         // 1. Clear fields
         document.getElementById("Title").value = "";
         document.getElementById("UserInput").value = "";
         document.getElementById("Status").value = "Draft";
         // Clear existing content
         chatContainer.innerHTML = '';
         // Control Buttons
          checkAndDisableButtonsForReadOnly("New");
         // 2. Get current last chapter number
         let chapterDropdown = document.getElementById("ChapterDropdown");
         let maxChapter = 0;

          const response = await fetch(`/Books/GetLastChapter?userId=${userId}&bookId=${bookId}`);
          const data = await response.json();
              console.log("🔄 Executing Books/GetLastChapter function",data );
          console.log("Last Chapter = ", data.lastChapter);

          // Example: Set next chapter in textbox
           document.getElementById("ChapterNo").value = data.lastChapter + 1;
           document.getElementById("ChapterDropdown").value = data.lastChapter + 1;
         // 4. Add new option to dropdown
          let opt = document.createElement("option");
           opt.value = data.lastChapter + 1;
           opt.text = data.lastChapter + 1;
          opt.selected = true;

          chapterDropdown.insertBefore(opt, chapterDropdown.options[0]); // Add on top

     }
     //=================================================100% OK
     //   Update Status when chapter selection changes
     //=============================================
     async function loadBookChapterNos(selectedValue) {  // ← Add 'async' here

        //   console.log("🔄 Chapter No Drop-Down function loadBookChapterNos() called with chapter:", selectedValue);

         const userId = document.getElementById("UserId").value;
         const bookId = document.getElementById('BookId').value;
         const responseIdElement = document.getElementById("ResponseId").value;
         const ddl = document.getElementById("ChapterDropdown");
         const statusInput = document.getElementById("Status");
          const titleInput = document.getElementById("Title");
         const userInput = document.getElementById("UserInput");

        //    console.log("🔍 Current Values - UserId:", userId, "BookId:", bookId);

       if (!userId || userId === "0" || !bookId || bookId === "0") {
          console.error("❌ UserId or BookId missing");
          return;
       }

       // ==== Update hidden field ===========
       document.getElementById("ChapterNo").value=selectedValue;
       //=======================================
       if (selectedValue === "0")
         {
             // "Load previously generated..." selected
             statusInput.value = "OK";
              titleInput.value = "";
             userInput.value = "";
             if (responseIdElement) responseIdElement.value = "";
                  updateButtonStates("OK"); // Enable buttons
                 return;
         }
         // Clear existing content
         chatContainer.innerHTML = '';
      try {
             // Fetch chapter data from API      GetSavedChapterNos
             //console.log("🔗 Calling URL:", `/Books/GetChapterData?userId=${userId}&bookId=${bookId}&chapterNo=${selectedValue}`);

             const response = await fetch(`/Books/GetChapterData?userId=${userId}&bookId=${bookId}&chapterNo=${selectedValue}`);
             console.log("📨 Response status:", response.status);

             if (!response.ok) {
                 throw new Error('Failed to fetch chapter data');
             }

              const result = await response.json();
              // console.log("📚 Chapter data received:", result);

             if (result.success)
              {
                 showNotification("Book loaded successfully!", "success");

                 // ✅ Get the first chapter (latest or default)
                 const latestChapter = result.chapters && result.chapters.length > 0
                       ? result.chapters[0]
                       : null;

                 // ✅ Fill the ResponseId field (from last chapter)
                 document.getElementById("ResponseId").value = latestChapter ? latestChapter.responseId : "0";

                 // ✅ Fill the ChapterNo field (from last chapter)
                 document.getElementById("ChapterNo").value = latestChapter ? latestChapter.chapterNo : "1";
                 // ✅ Fill other fields
                 // ✅ Fill the textarea or content field
                 document.getElementById("BookTitle").value = result.bookTitle || "";
                 // ✅ Fill the textarea or content field
                 document.getElementById("Status").value = latestChapter ? latestChapter.statusCode : "Draft";
                 // ✅ Fill the textarea or content field
                 document.getElementById("Title").value = latestChapter ? latestChapter.chapterTitle : "";
                 // ✅ Fill the textarea or content field
                 document.getElementById("UserInput").value = latestChapter ? latestChapter.requestData : "";
                 // ✅ Check if book is ReadOnly and disable buttons accordingly
                 const statusCode = latestChapter ? latestChapter.statusCode : "Draft";
                 checkAndDisableButtonsForReadOnly(statusCode);

                 // Load Book Content
                 populateBookForm(result);   // Function to populate FORM's fields with book data
                 //showBookContent(result);    // Load Book's Title, ChapterNiData
                 showNotification("Book loaded successfully!", "success");
             } else {
                  // clearBookForm();
                  showNotification("Error: " + result.message, "error");
               }
         } catch (error) {
               console.error("Error loading book details:", error);
               //clearBookForm();
               showNotification("Error loading book details: " + error.message, "error");
         }
     }
   //====(2-37)==============================OK
   //  Run On Button Click 📖 Show
   //    Load Selected Book Data
   //========================================
      async function showSelectedBook()
         {
              const requestData = {
                       ResponseId: document.getElementById('ResponseId')?.value,
                       UserId: document.getElementById('UserId')?.value,
                       BookId: document.getElementById('BookId')?.value,
                       Title: document.getElementById('Title')?.value,
                       Chapter: parseInt(document.getElementById('ChapterNo')?.value),
                       UserInput: document.getElementById('UserInput')?.value
              };
               console.log("🔄 showSelectedBook() executed after button clicked", requestData);
            //  console.log("🔍 Loading selected book:", requestData.BookId);
              if (!requestData.BookId) {
                   resetButtonStates();
                   clearBookForm();
                   console.log("❌  No book selected - buttons reset");
                   return;
              }
              try
                {
                  if (!requestData.UserId || requestData.UserId === "0")
                   {
                          throw new Error("User ID not found");
                   }              
                   if (!requestData.ResponseId)
                   {
                        throw new Error("Please select a Chapter");
                   }
                   // Load data from  Books + APIRawResponse
                     const response = await fetch(`/Books/GetBookChapterResponse?userId=${requestData.UserId}&bookId=${requestData.BookId}&chapterNo=${requestData.Chapter}`);
                    console.log("📨 Get Json result:", response);

                    if (!response.ok)
                    {
                         throw new Error("Failed to load book details");
                    }
                    const result = await response.json();
                    console.log("📚 Loading loadSelectedResponse Function ==xx==>", result);

                    // Load Selected Book Data into the FORM
                     if (result.success)
                     {
                           console.log("📚 result.success ", result);
                         populateBookForm(result);
                         showBookContent(result);    // Load Book's Title, ChapterNiData
                          showNotification("Book loaded successfully!", "success");
                      } else {
                          // clearBookForm();
                          showNotification("Error: " + result.message, "error");
                      }
                } catch (error) {
                    console.error("Error loading book details:", error);
                    //clearBookForm();
                    showNotification("Error loading book details: " + error.message, "error");
                }
         }
       //====(3-22)======================================== OK
       //========= Display the Book in Scroll Bars  =====
       //================================================
        function displayBook(bookData, showMode = false) {

            console.log("📖 displayBook() Rendering book", bookData);

             let hasList = false;

           try {
                const chatContainer = document.getElementById("chatContainer");
                 const bookResult = document.getElementById("bookResult");

                  if (!chatContainer && !bookResult) {
                      console.error("❌ Chat/book result containers not found");
                     return;
                 }
                  // Clear existing content in the appropriate container
                 if (bookResult) {
                     bookResult.innerHTML = ''; // Clear book result area
                 }
                 if (chatContainer) {
                     chatContainer.innerHTML = ''; // Clear chat area if it exists
                 }

                if (typeof bookData === 'string') {
                    bookData = JSON.parse(bookData);
                }
               } catch (error) { 
                   console.error("❌ Error in displayBook:", error);
                     return;
               }
                console.log("📖 displayBook() Rendering book", bookData);
                
                const core = (bookData && bookData.data) ? bookData.data : (bookData || {});
                const responseId = core.ResponseId || core.responseId || bookData.ResponseId || bookData.responseId || '';
                const rawTitle = core.title || bookData.title || '';
                const suggested = (core.suggest_chapter_name || core.suggestChapterName || '')
                           .split('\n').map(s => s.trim()).filter(Boolean);
                const inferredTitle = rawTitle || (core.user_input ? `Book: ${core.user_input}` : '');
                const chaptersRaw = core.chapters || bookData.Chapters || bookData.chapters || [];
                let chapters = Array.isArray(chaptersRaw) ? chaptersRaw : [];

                // ✅ SET RESPONSE ID IN THE FORM
                    if (responseId) {
                        document.getElementById('ResponseId').value = responseId;
                        console.log("📋 ResponseId set from book data:", responseId);
                    }
                // Gracefully handle single-content responses by building a pseudo chapter
                if (chapters.length === 0 && core.content) {
                    chapters = [{
                       chapterNumber: 1,
                       title: suggested[0] || 'Chapter 1',
                       content: core.content,
                       status: core.status || ''
                    }];
                }
                const total = chapters.length;

                let html = showMode ? `<div class="reader-theme reader-show">` : `<div class="reader-theme">`;

                if (total === 0) {
                    html = `<div class="alert alert-warning">No content available.</div>`;
                    document.getElementById('bookResult').innerHTML = html;
                    return;
                }
               // Single chapter: show a focused reader view without extra chrome
               if (total === 1) {
                           const ch = chapters[0];
                           const chapterNumber = ch.chapterNumber ?? ch.ChapterNumber ?? 1;
                           const title = ch.title ?? ch.Title ?? `Chapter ${chapterNumber}`;
                           const content = ch.content ?? ch.Content ?? ch.data ?? ch.Data?.content ?? '';

                           if (showMode) {
                               html += `
                                   <div class="reader-cover">
                                       <div class="reader-cover-inner">
                                           <h2 class="reader-title">${escapeHtml(inferredTitle || title)}</h2>
                                       </div>
                                   </div>`;
                           }

                           html += `
                           <div class="generator-card">
                               <div class="card-body">
                                   <h4 class="fw-bold mb-3">${escapeHtml(title)}</h4>
                                   <div class="chapter-content-container">
                                       <div class="chapter-content-scrollable">${isLikelyHtml(content) ? sanitizeHtml(content) : `<pre>${escapeHtml(formatText(content))}</pre>`}</div>
                                   </div>
                                   ${(core.suggest_chapter_name || core.suggestChapterName) ? (() => {
                                       const raw = core.suggest_chapter_name || core.suggestChapterName || '';
                                       let inner = '';
                                       if (hasList) {
                                       const hasList = /<\s*ul[\s\S]*?>/i.test(raw);
                                           inner = `<div class=\"outline-html\">${sanitizeHtml(raw)}</div>`;
                                       } else {
                                           const items = raw.split('\n').map(x => x.trim()).filter(Boolean).slice(0, 12);
                                           inner = items.map(x => `<span class=\"outline-pill\">${escapeHtml(x)}</span>`).join('');
                                       }
                                       return `
                                           <div class=\"outline-card\">
                                               <div class=\"outline-header\">
                                                   <div class=\"outline-title\"><i class=\"bi bi-list-stars\"></i> Outline</div>
                                                   <button class=\"btn btn-outline-secondary btn-sm\" type=\"button\" onclick=\"const b=this.closest('div').parentElement.nextElementSibling; b.style.display=b.style.display==='none'?'block':'none'\">Toggle</button>
                                               </div>
                                               <div class=\"outline-body\" style=\"${showMode ? '' : 'display:none'}\">${inner}</div>
                                           </div>`;
                                   })() : ''}
                               </div>
                           </div>`;
                           html += `</div>`;
                           document.getElementById('bookResult').innerHTML = html;
                           return;
                       }

                       // Multiple chapters: optional outline + clean accordion only
                       if (showMode && (core.suggest_chapter_name || core.suggestChapterName)) {
                           const raw = core.suggest_chapter_name || core.suggestChapterName || '';
                           const hasList = /<\s*ul[\s\S]*?>/i.test(raw);
                           let inner = '';
                           if (hasList) inner = `<div class=\"outline-html\">${sanitizeHtml(raw)}</div>`;
                           else {
                               const items = raw.split('\n').map(x => x.trim()).filter(Boolean).slice(0, 12);
                               inner = items.map(x => `<span class=\"outline-pill\">${escapeHtml(x)}</span>`).join('');
                           }
                           html += `
                               <div class=\"outline-card\">
                                   <div class=\"outline-header\">
                                       <div class=\"outline-title\"><i class=\"bi bi-list-stars\"></i> Outline</div>
                                   </div>
                                   <div class=\"outline-body\">${inner}</div>
                               </div>`;
                       }

                       html += `<div class="accordion" id="bookAccordion">`;
                       chapters.forEach((ch, index) => {
                           const ResponseId = ch.ResponseId ?? ch.responseId ?? '';
                           const chapterId = `chapter${index}`;
                           const chapterNumber = ch.chapterNumber ?? ch.ChapterNumber ?? (index + 1);
                           const title = ch.title ?? ch.Title ?? `Chapter ${chapterNumber}`;
                           const content = ch.content ?? ch.Content ?? ch.data ?? ch.Data?.content ?? '';
                           const status = ch.status ?? ch.Status ?? '';
                           const finalized = isFinalized(status);
                           const headerBadge = finalized ? `<span class="badge bg-success ms-2">✅ Finalized</span>` : ``;

                           html += `
                           <div class="accordion-item mb-2" id="accordionItem-${chapterId}">
                               <h2 class="accordion-header d-flex align-items-center" id="heading${chapterId}">
                                   <button class="accordion-button ${index === 0 ? '' : 'collapsed'} flex-grow-1"
                                           type="button"
                                           data-bs-toggle="collapse"
                                           data-bs-target="#collapse${chapterId}"
                                           aria-expanded="${index === 0}"
                                           aria-controls="collapse${chapterId}">
                                       <div>
                                           <div class="d-flex align-items-center">
                                               <strong class="me-2">${escapeHtml(title)}</strong>
                                               ${headerBadge}
                                           </div>
                                           <small class="text-muted">Chapter #: ${chapterNumber}</small>
                                       </div>
                                   </button>
                               </h2>
                               <div id="collapse${chapterId}" class="accordion-collapse collapse ${index === 0 ? 'show' : ''}"
                                    aria-labelledby="heading${chapterId}" data-bs-parent="#bookAccordion">
                                   <div class="accordion-body">
                                       <div class="chapter-content-container">
                                           <div class="chapter-content-scrollable">${isLikelyHtml(content) ? sanitizeHtml(content) : `<pre>${escapeHtml(formatText(content))}</pre>`}</div>
                                       </div>

                                       <div class="mt-3">
                                           <label class="form-label small mb-1">Change (instructions or replacement):</label>
                                           <div class="input-group input-group-sm mb-2">
                                               <input type="text" id="changeInput-${chapterId}" class="form-control form-control-sm"
                                                   placeholder="e.g. replace 'apple' with 'pear'">
                                               <button class="btn btn-outline-primary btn-sm" type="button"
                                                   id="changeBtn-${chapterId}"
                                                   onclick="changeChapter('${chapterId}', '${chapterNumber}')"
                                                   ${finalized ? 'disabled' : ''}>
                                                   Change
                                               </button>
                                               <button class="btn btn-outline-success btn-sm ms-2" type="button"
                                                   id="finalizeBtn-${chapterId}"
                                                   onclick="finalizeChapter('${chapterId}', '${chapterNumber}')"
                                                   ${finalized ? 'disabled' : ''}>
                                                   Finalize
                                               </button>
                                           </div>
                                           <div id="changeStatus-${chapterId}" class="small text-muted"></div>
                                       </div>
                                   </div>
                               </div>
                           </div>`;
           });

          html += `</div>`;
          html += `</div>`;
          document.getElementById('bookResult').innerHTML = html;
      }
      //=====(4-18)======================================================= OK
      //=======   Display the Book in Scroll Bars Helper Functions =====
      //================================================================
      // Helper: escape HTML to safely render user/AI content
       function escapeHtml(str) {
          if (str === undefined || str === null) return '';
             return String(str)
              .replace(/&/g, '&amp;')
              .replace(/</g, '&lt;')
              .replace(/>/g, '&gt;')
              .replace(/"/g, '&quot;')
              .replace(/'/g, '&#39;');
       }
      //===(5-20)=== Detect if content likely contains HTML markup == OK
      function isLikelyHtml(content) {
         if (!content) return false;
          return /<\s*\w+[\s\S]*?>/i.test(content);
      }
      //===(6-21)=== Minimal client-side sanitizer to allow basic formatting tags only ==OK
      function sanitizeHtml(unsafeHtml) {
         try {
               const allowedTags = new Set(['p','br','hr','ul','ol','li','strong','b','em','i','u','h1','h2','h3','h4','h5','h6','blockquote','code','pre','span','div']);
               const allowedAttrs = new Set(['class','style']);
               const parser = new DOMParser();
               const doc = parser.parseFromString(String(unsafeHtml), 'text/html');
               const walker = document.createTreeWalker(doc.body, NodeFilter.SHOW_ELEMENT, null);
               const toRemove = [];
               while (walker.nextNode()) {
                    const el = walker.currentNode;
                    if (!allowedTags.has(el.tagName.toLowerCase())) {
                         toRemove.push(el);
                         continue;
                    }
                    // Strip disallowed attributes and dangerous values
                    [...el.attributes].forEach(attr => {
                         const name = attr.name.toLowerCase();
                         const value = attr.value || '';
                          if (!allowedAttrs.has(name)) {
                                  el.removeAttribute(name);
                                  return;
                           }
                           if (name === 'style' && /expression\(|javascript:|url\(/i.test(value)) {
                                  el.removeAttribute('style');
                           }
                     });
                }
                toRemove.forEach(n => n.replaceWith(n.textContent || ''));
                return doc.body.innerHTML;
         } catch (e) {
                return escapeHtml(String(unsafeHtml));
         }
      }
      //====(7-35)==== Add any missing function that might be called but not defined
      function isFinalized(status) {
             return status === 'finalized' || status === 'approved' || status === 'completed';
      }
      // =====(10-29)================ NOTIFICATION SYSTEM =====================
      function showNotification(message, type = 'success') {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;

            let icon = '✓';
            if (type === 'error') icon = '⚠';

            notification.innerHTML = `
                <span style="font-size: 1.2rem;">${icon}</span>
                <span>${message}</span>
            `;

            container.appendChild(notification);

            // Trigger animation
            setTimeout(() => notification.classList.add('show'), 10);

            // Remove after delay
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 400);
            }, 4000);
      }
      //=======(11-26)============
      function addMessage(content, isUser = false) {
           // Get chat container - CORRECT CASE
             const chatContainer = document.getElementById('chatContainer');
            //const chatcontainer = document.getelementbyId('chatcontainer');  ==> NOTE: It is case sensitive
            // Check if content is valid
            console.log("📋 Step 3: addMessage() function executed:", content);
            if (content === undefined || content === null) return '';
            
            // Check if chat container exists
            if (!chatContainer) {
                 console.error('❌ chatContainer element not found');
                 return null;
             }
             // Create message div - CORRECT CASE
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'message-user' : 'message-ai'}`;

            messageDiv.innerHTML = `
                <div class="message-avatar">${isUser ? 'You' : 'AI'}</div>
                <div class="message-content">
                    <div class="streaming-content">${content}</div>
                </div>
            `;
            // Append to container - CORRECT CASE
            chatContainer.appendChild(messageDiv);

            // scroll to bottom
            chatContainer.scrollTop = chatContainer.scrollHeight;
            // Return streaming content element - CORRECT CASE
            return messageDiv.querySelector('.streaming-content');
      }
    //===(11-17)=====================================100% OK
    //   Run on button click ⚙️ Generate
    //        Generate Book Chapter
    //=============================================
    function confirmGenerateChapter() {
        if (confirm("Are you sure you want to generate this chapter?")) {
            generateBook();  // run your original function
             
        } else {
            return; // do nothing
        }
    }
    //==================
    async function generateBook() {
        console.log("🟢 Step 1: generateBook() function started");
      
        // --- Step 2: Collect input values from the page ---
        const requestData = {
            UserId: document.getElementById('UserId').value,
            BookId: document.getElementById('BookId').value,
            Title: document.getElementById('Title')?.value,
            Chapter: parseInt(document.getElementById('ChapterNo').value),
            UserInput: document.getElementById('UserInput')?.value     
        };

        const status = document.getElementById('Status')?.value

        console.log("Generating chapter for userId ==>>:", requestData.UserId, "bookId:", requestData.BookId);

        if (status === "ReadOnly") {
            alert('Warning! finalized chapters cannot changed');
             hideGenerateLoading(); // Hide loading if ReadOnly
            return;
        }

        // ✅ FIX: Correct condition checks
          if (!requestData.UserId || requestData.UserId == "0") {
            alert('Please select a user');
             hideGenerateLoading(); // Hide loading if ReadOnly
            return;
        }

        if (!requestData.BookId || requestData.BookId == "0") {
            alert('Please select a book');
             hideGenerateLoading(); // Hide loading if ReadOnly
            return;
        }
        if (!requestData.UserInput || requestData.UserInput.length == "0") {
             alert('Please enter prompt');
              hideGenerateLoading(); // Hide loading if ReadOnly
             return;
         }
         if (!requestData.Chapter || requestData.Chapter == "0") {
             alert('Please select a Chapter');
              hideGenerateLoading(); // Hide loading if ReadOnly
             return;
         }

         const generateBtn = document.getElementById("GenerateBtn");
         const messageElement = document.getElementById('processingMessage');
         // Show processing message
           messageElement.style.display = 'block';
           generateBtn.innerHTML = 'Generating...';

         // Show loading state immediately
           showGenerateLoading();
           disableControls()
         // Disable all buttons and show loading state
          manageButtonStates("Generate");
        
         //btnText.style.display = 'none';
         //btnLoading.style.display = 'inline-block';
        
         showNotification("🚀 Starting generation process...", "info");
         //==============Generate New Chapter Number ================
         let chapterNo =0;
             const apiUrl = `/Books/GetNextChapterNumber?userId=${encodeURIComponent(requestData.UserId)}&bookId=${encodeURIComponent(requestData.BookId)}`;
             console.log("🔍 Calling API:", apiUrl);

             const response2 = await fetch(apiUrl);
             console.log("🔍 Response status:", response2.status);

             if (!response2.ok) {
                      throw new Error(`HTTP error! status: ${response2.status}`);
             }
             const data = await response2.json();
             console.log("📋 Chapter number data received:", data);

             if (data.success) {
                      console.log("✅ SUCCESS: Next chapter number:", data.nextChapterNumber);
                       chapterNo =  data.nextChapterNumber;
              } else {
                      console.error("❌ API returned failure:", data.message);
                       chapterNo = 1; // Return default chapter 1 on failure
              }
          // Update Chapter value
           requestData.Chapter = chapterNo;
           document.getElementById("ChapterNo").value = chapterNo;
           document.getElementById("ChapterDropdown").value = chapterNo;
        //================== End Chapter Number ================
        console.log("📋 Step 2: Collected input data:", requestData);

        // Add user message
        addMessage(`I want to create a chapter about: "${requestData.UserInput}" with ${requestData.Chapter} chapters.`, true);

        // Show loading spinner
        showTypingIndicator();
        console.log("⏳ Step 3: Displayed loading spinner");

        // Simulate AI thinking
        setTimeout(async () => {
            hideTypingIndicator();

            // Add AI response with streaming
            const aiMessageElement = addMessage('');
            const thinkingText = `Great! I'll create a chapter about "${requestData.UserInput}" with ${requestData.Chapter} chapters. Let me start generating the content...`;

            console.log("🚀 Step 4: Sending POST request to /Books/AIGenerateBook");

            simulateStreaming(thinkingText, aiMessageElement, async () => {
                try {
                    const response = await fetch('/Books/AIGenerateBook', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestData)
                    });
                     //-----> Message Box
                        Swal.fire({
                        title: "Processing Completed",
                        text: "Your request has been processed successfully!",
                        icon: "success",
                        confirmButtonText: "OK"
                    });
                     
                    console.log("📨 Step 5: Received response:", response);
                     // Stop displaying Processing, please wait...
                      messageElement.style.display = 'none';
                      // After complition  
                      enableControls()
                           // To stop/hide the processing message and reset button
                        messageElement.style.display = 'none';
                        generateBtn.innerHTML = 'Generate Chapter';

                    if (response.ok) {
                        const bookData = await response.json();
                        console.log("✅ Step 6: Response converted to JSON:", bookData);

                        document.getElementById('APIRawResponse').value = JSON.stringify(bookData);
                        document.getElementById('ResponseId').value = bookData.responseId;

                        // Show book generation complete message
                        const completeMessage = addMessage('');
                        const completeText = `✅ Book generated successfully! "${bookData.data?.title || 'Untitled Book'}" is ready with ${bookData.data?.chapters?.length || 0} chapters.`;
                        // manageButtonStates("Edit")
                         simulateStreaming(completeText, completeMessage, () => {
                              showSelectedBook();

                            //displayBook(bookData);
                            console.log("✅ Step 7: Load Saved Response Drop-Down", bookData);
                            loadSavedBooksDropdown();
                            showNotification('Book generated successfully!', 'success');
                             
                        });
                         
                    } else {
                        const errorText = await response.text();
                        console.error("❌ Step 8: Server returned error:", errorText);
                        throw new Error(errorText || 'Failed to generate book');
                    }
                } catch (error) {
                    console.error("🔥 Step 9: Exception occurred:", error);
                    const errorMessage = addMessage(`❌ Sorry, I encountered an error: ${error.message}`);
                    showNotification('Failed to generate book', 'error');
                 } finally {
                     // Always hide loading state when done
                     hideGenerateLoading();
                 }
            });
        }, 1000);
    }
    //===(11-17)=====================================OK
    //   Run on button click 🔁 Edit
    //        Edit Book Chapter
    //=============================================
    function confirmEditChapter() {
            if (confirm("Are you sure you want to generate this chapter?")) {
                 editInChapter();  // run your original function
                  
            } else {
                return; // do nothing
            }
        }
    async function editInChapter() {
        console.log("🟢 Step 1: editInChapter function started");
          
         // --- Step 2: Collect input values from the page ---  messageElement
        // 🔧 FIX: Create the correct request structure for the API
         const requestData = {
             UserId: document.getElementById('UserId').value,
             BookId: document.getElementById('BookId').value,
             Title: document.getElementById('Title')?.value,
             chapter: parseInt(document.getElementById('ChapterNo').value),
             changes: document.getElementById('UserInput')?.value
         };
          // Create a new AbortController for this request
            abortController = new AbortController();
          const messageElement = document.getElementById('processingMessage');
          const statusEl = document.getElementById('statusEl');
          const changeBtn = document.getElementById('changeBtn');
          const finalizeBtn = document.getElementById('finalizeBtn');
   

        // Get other values for validation
        const Status = document.getElementById('Status')?.value;
     
        if (Status === "ReadOnly") {
            alert('Warning! finalized chapters cannot changed');
              if (statusEl) statusEl.innerHTML = '';
            return;
        }

         // ✅ FIX: Correct condition checks
           if (!requestData.UserId || requestData.UserId == "0") {
             alert('Please select a user');
              hideGenerateLoading(); // Hide loading if ReadOnly
               if (statusEl) statusEl.innerHTML = '';
             return;
         }

         if (!requestData.BookId || requestData.BookId == "0") {
             alert('Please select a book');
              hideGenerateLoading(); // Hide loading if ReadOnly
               if (statusEl) statusEl.innerHTML = '';
             return;
         }
           if (!requestData.changes || requestData.changes.length == "0") {
              alert('Please enter prompt');
               hideGenerateLoading(); // Hide loading if ReadOnly
                if (statusEl) statusEl.innerHTML = '';
              return;
          }
          if (!requestData.chapter || requestData.chapter == "0") {
              alert('Please select a Chapter');
               hideGenerateLoading(); // Hide loading if ReadOnly
                if (statusEl) statusEl.innerHTML = '';
              return;
          }

          const editBtn = document.getElementById("EditBtn");
          // Show processing message
             messageElement.style.display = 'block';
             editBtn.innerHTML = 'Editing...';

            // Only update if elements exist
            if (statusEl) {
                  statusEl.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Editing...`;
            }
             if (changeBtn) {
                changeBtn.disabled = true;
             }
             if (finalizeBtn) {
                 finalizeBtn.disabled = true;
             }
        console.log("📋 Step 2: Collected input data:", requestData);
        
            const generateBtn = document.getElementById("EditBtn");
         
           // Show processing message
             if (messageElement) {
                 messageElement.style.display = 'block';
             }
             if (changeBtn) {
                    changeBtn.innerHTML = 'Editing...';
             }
            
          // Show loading state immediately
           showGenerateLoading();
            disableControls()

        // Add user message
          const chatContainer = document.getElementById("chatContainer");
             if (chatContainer) {
                 addMessage(`I want to edit chapter ${requestData.chapter} of the book: "${requestData.changes}"`, true);
             }
        
        console.log("⏳ Step 3: Displayed loading spinner");

        // Simulate AI thinking
        setTimeout(async () => {
             let aiMessageElement = null;
             if (chatContainer) {
                 aiMessageElement = addMessage('');
             }

            const thinkingText = `I'll edit chapter ${requestData.chapter} with your changes: "${requestData.changes}". Let me process the edits...`;

            console.log("🚀 Step 4: Sending POST request to /Books/AIEditBook");
            console.log("📦 Request payload:", requestData);
            // Only simulate streaming if we have a message element
            if (aiMessageElement) {
                simulateStreaming(thinkingText, aiMessageElement, async () => {
                    await processEditRequest(requestData);
                });
            } else {
                // If no chat container, just process the request directly
                await processEditRequest(requestData);
            }
        }, 1000);

         

    }
    //==================================
    // Hit API for the edit request
    //=================================
      async function processEditRequest(requestData) {

         console.log("📨 Step 5: Execute processEditRequest() to POST Request:");
           const messageElement = document.getElementById('processingMessage');
        try {
            const response = await fetch('/Books/AIEditBook', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestData)
            });

            console.log("📨 Step 6: Received the response from API:", response);
            //-----> Message Box
               Swal.fire({
                   title: "Processing Completed",
                   text: "Your request has been processed successfully!",
                   icon: "success",
                   confirmButtonText: "OK"
               });
            // After complition
             enableControls()
             // To stop/hide the processing message and reset button
              messageElement.style.display = 'none';
               EditBtn.innerHTML = 'Edit';

            if (response.ok) {
                const bookData = await response.json();
                console.log("✅ Step 7: Response converted to JSON:", bookData);

                document.getElementById('APIRawResponse').value = JSON.stringify(bookData);
                document.getElementById('ResponseId').value = bookData.responseId;

                // Show edit complete message
                const chatContainer = document.getElementById("chatContainer");
                if (chatContainer) {
                    const completeMessage = addMessage('');
                    const completeText = `✅ Chapter ${requestData.chapter} edited successfully!`;
                    simulateStreaming(completeText, completeMessage, () => {
                         showSelectedBook();
                       // displayBook(bookData);
                         console.log("✅ Step 8: Load Saved Response Drop-Down", bookData);
                        loadSavedBooksDropdown();
                        showNotification('Chapter edited successfully!', 'success');
                    });
                     checkAndDisableButtonsForReadOnly("Edit");
                } else {
                    // If no chat container, just display the book
                     showSelectedBook();
                   // displayBook(bookData);
                    loadSavedBooksDropdown();
                    showNotification('Chapter edited successfully!', 'success');
                }

                checkAndDisableButtonsForReadOnly("Edit");
            } else {
                const errorText = await response.text();
                console.error("❌ Step 8: Server returned error:", errorText);
                throw new Error(errorText || 'Failed to edit chapter');
            }
        } catch (error) {
            console.error("🔥 Step 9: Exception occurred:", error);
            const chatContainer = document.getElementById("chatContainer");
            if (chatContainer) {
                const errorMessage = addMessage(`❌ Sorry, I encountered an error: ${error.message}`);
            }
            showNotification('Failed to edit chapter', 'error');
        }
    }
        //=====(12-27)=======
        function showTypingIndicator() {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message message-ai';
            messageDiv.id = 'typing-indicator';

            messageDiv.innerHTML = `
                <div class="message-avatar">AI</div>
                <div class="message-content">
                    <div class="typing-indicator">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            `;

            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        //=====(13-28)======
        function hideTypingIndicator() {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) {
                indicator.remove();
            }
        }
        // =====(14-25)================ REAL-TIME STREAMING SIMULATION ===================== OK
        function simulateStreaming(text, targetElement, callback) {
            const words = text.split(' ');
            let currentWord = 0;
            targetElement.innerHTML = '';

            const interval = setInterval(() => {
                if (currentWord < words.length) {
                    targetElement.innerHTML += (currentWord === 0 ? '' : ' ') + words[currentWord];
                    currentWord++;

                    // Scroll to bottom of chat
                    const chatContainer = document.getElementById('chatContainer');
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                } else {
                    clearInterval(interval);
                    if (callback) callback();
                }
            }, 50);
        }
    //==============================================================
    //    Add Record and Update APIRawResponse StatusCode=ReadOnly
    //==============================================================
    async function finalizeChapter() {
        console.log("🟢 Step 1: finalizeChapter function started");

        let finalizeData = {
            responseId: document.getElementById("ResponseId").value,
            userId: document.getElementById("UserId").value,
            bookId: document.getElementById("BookId").value,
            Chapter: document.getElementById("ChapterNo").value
        };

        console.log("🟢 Step 2: finalizeData :", finalizeData);

        // Validate required data
        if (!finalizeData.responseId || finalizeData.responseId === "0") {
            alert("Error: Invalid ResponseId");
            return;
        }
        // Validate chapter field specifically
         if (!finalizeData.Chapter || finalizeData.Chapter === "0") {
             alert("Error: Invalid Chapter number");
             return;
         }
          // Convert all values to integers to ensure proper data types
         finalizeData = {
             responseId: parseInt(finalizeData.responseId),
             userId: parseInt(finalizeData.userId),
             bookId: parseInt(finalizeData.bookId),
             chapter: parseInt(finalizeData.Chapter)
         };
          console.log("🟢 Step 3: Converted finalizeData :", finalizeData);
         // Check if any conversion resulted in NaN
         if (isNaN(finalizeData.responseId) || isNaN(finalizeData.userId) ||
             isNaN(finalizeData.bookId) || isNaN(finalizeData.chapter)) {
             alert("Error: One or more fields contain invalid numbers");
             return;
         }

        try {
               console.log("🟢 Step 4: Sending request...");
            // Make this chapter ReadOnly
            const response = await fetch('/Books/FinalizeChapter', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                     'Accept':'application/json'
                },
                body: JSON.stringify(finalizeData)
            });
             // Get the response text to see what the server is saying
             const responseText = await response.text();
             console.log("🟢 Response text:", responseText);
              console.log("🟢 Step 6: Response status:", response.status);

            // Check if response is OK
            if (!response.ok) {
                  // Try to parse as JSON for better error message
                let errorMessage = `Server returned ${response.status}`;
                try{
                     const errorData = JSON.parse(responseText);
                    errorMessage = errorData.message || errorData.title || responseText;
                 } catch {
                    errorMessage = responseText || `Server returned ${response.status}`;
                 }
                    throw new Error(errorMessage);

            }
            const result = JSON.parse(responseText);
            console.log("🟢 Parsed result:", result);
            document.getElementById('Status').value = "ReadOnly";
             disableControls2()
             if (result.success) {
                    alert("Chapter has been finalized (ReadOnly).");
                 } else {
                     alert("Error: " + result.message);
             }
         } catch (error) {
             console.error("❌ Error finalizing chapter:", error);
             alert("Error finalizing chapter: " + error.message);
         }

    }

       //===(11-17)=====================================OK
       //   Run on button click 🔁 Finalize
       //        Finalize Book Chapter
        //============================================= statusEl
        async function finalizeChapterAPI()
        {
            console.log("🟢 Step 1: finalizeChapterAPI function started");
              // --- Step 2: Collect input values from the page ---
                const requestData = {
                  UserId: document.getElementById('UserId').value,
                  BookId: document.getElementById('BookId').value,
                  Title: document.getElementById('Title')?.value,
                  chapter: parseInt(document.getElementById('ChapterNo').value),
                  changes: document.getElementById('UserInput')?.value
              };
              
          const finalizeBtn = document.getElementById("GenerateBtn"); // Changed variable name to lowercase
          const messageElement = document.getElementById('processingMessage');

          // Show processing message
          if (messageElement) {
              messageElement.style.display = 'block';
          }
          if (finalizeBtn) {
              finalizeBtn.innerHTML = 'Finalizing...';
          }

          // Show loading state immediately
          //showGenerateLoading();
          disableControls();
          const status = document.getElementById('Status')?.value;

          console.log("Finalizing chapter for userId ==>>:", requestData.UserId, "bookId:", requestData.BookId);

          if (status === "ReadOnly") {
              alert('Warning! finalized chapters cannot finalized again');
              hideGenerateLoading(); // Hide loading if ReadOnly
              resetFinalizeUI(); // Reset UI state
              return;
          }

          // ✅ FIX: Correct condition checks
          if (!requestData.UserId || requestData.UserId == "0") {
              alert('Please select a user');
              hideGenerateLoading(); // Hide loading if ReadOnly
              resetFinalizeUI(); // Reset UI state
              return;
          }

          if (!requestData.BookId || requestData.BookId == "0") {
              alert('Please select a book');
              hideGenerateLoading(); // Hide loading if ReadOnly
              resetFinalizeUI(); // Reset UI state
              return;
          }
          if (!requestData.UserInput || requestData.UserInput.length == "0") {
              alert('Please enter prompt');
              hideGenerateLoading(); // Hide loading if ReadOnly
              resetFinalizeUI(); // Reset UI state
              return;
          }
          if (!requestData.Chapter || requestData.Chapter == "0") {
              alert('Please select a Chapter');
              hideGenerateLoading(); // Hide loading if ReadOnly
              resetFinalizeUI(); // Reset UI state
              return;
          }

          showNotification("🚀 Starting finalizing process...", "info");
          console.log("📋 Step 2: Collected input data:", requestData);

          // Simulate AI thinking
          setTimeout(async () => {
              hideTypingIndicator();

              // Add AI response with streaming
              const aiMessageElement = addMessage('');
              const thinkingText = `Great! I'll finalize this chapter number ${requestData.Chapter}....`;

              console.log("🚀 Step 4: Sending POST request to /Books/SetReadOnly");

              simulateStreaming(thinkingText, aiMessageElement, async () => {
                  try {
                          const response = await fetch('/Books/SetReadOnly', {
                            method: 'POST',
                             headers: { 'Content-Type': 'application/json' },
                             body: JSON.stringify(requestData)
                         });

                      console.log("📨 Step 5: Received response:", response);

                      // Check if response is successful
                      if (response.ok) {
                          // Stop displaying Processing, please wait...
                          if (messageElement) {
                              messageElement.style.display = 'none';
                          }

                          // After completion
                          enableControls();

                          // To stop/hide the processing message and reset button
                          if (finalizeBtn) {
                              finalizeBtn.innerHTML = '✅ Finalized';
                              // Optional: disable button after finalization
                              finalizeBtn.disabled = true;
                          }

                          showSelectedBook();
                          showNotification('Chapter finalized successfully!', 'success');

                          // Update status to ReadOnly in the UI
                          const statusElement = document.getElementById('Status');
                          if (statusElement) {
                              statusElement.value = 'ReadOnly';
                          }
                      } else {
                          // Handle server errors
                          const errorText = await response.text();
                          throw new Error(errorText || 'Failed to finalize chapter');
                      }
                  } catch (error) {
                      console.error("🔥 Step 9: Exception occurred:", error);
                      const errorMessage = addMessage(`❌ Sorry, I encountered an error: ${error.message}`);
                      showNotification('Failed to finalize chapter', 'error');

                      // Reset button on error
                      if (finalizeBtn) {
                          finalizeBtn.innerHTML = 'Finalize Chapter';
                      }
                  } finally {
                      // Always hide loading state when done
                      hideGenerateLoading();

                      // Ensure processing message is hidden
                      if (messageElement) {
                          messageElement.style.display = 'none';
                      }
                  }
              });
             }, 1000);
      }
          // Helper function to reset UI state
     function resetFinalizeUI() {
         const finalizeBtn = document.getElementById("GenerateBtn");
         const messageElement = document.getElementById('processingMessage');

         if (finalizeBtn) {
             finalizeBtn.innerHTML = 'Finalize Chapter';
             finalizeBtn.disabled = false;
         }
         if (messageElement) {
             messageElement.style.display = 'none';
         }

         enableControls();
     }
      //==============================================
      // Hit API for the Finalize Chapter request
      //==============================================
         async function processFinalRequest(requestData) {
            const statusEl = document.getElementById('statusEl');
         const changeBtn = document.getElementById('changeBtn');
         const finalizeBtn = document.getElementById('finalizeBtn');
         const generateBtn = document.getElementById("FinalizeBtn");
         const messageElement = document.getElementById('processingMessage');

         if (statusEl) statusEl.innerHTML = '';
         if (changeBtn) changeBtn.disabled = false;
         if (finalizeBtn) finalizeBtn.disabled = false;

         // 🔧 FIX: Check if generateBtn exists before resetting
         if (generateBtn) {
             generateBtn.innerHTML = 'Finalize Chapter';
         } else {
             // Try alternative button IDs
             const finalizeChapterBtn = document.getElementById('finalizeChapterBtn');
             if (finalizeChapterBtn) {
                 finalizeChapterBtn.innerHTML = 'Finalize Chapter';
             }
         }

         if (messageElement) messageElement.style.display = 'none';

         enableControls();
         hideGenerateLoading();
      }

     //===(15-2)=====================================================OK
     //====    MAIN FUNCTION TO LOAD BOOKS IN DROPDOWN            ===
     //====     Step 2: LOAD SAVED BOOKS IN DROPDOWN              ===
     //==============================================================
     //---------------------> Execution Step 4 <--------------------
     async function loadSavedBooksDropdown() {
         console.log("🔄 loadSavedBooksDropdown() called");

         const userId = document.getElementById("UserId").value;
         console.log("🔍 User ID from hidden field:", userId);

         if (!userId || userId === "0") {
             console.error("❌ No valid user ID found");
             return;
         }

         try {
             console.log("🔍 Calling API: /Books/GetSavedResponses?userId=" + userId);

             const response = await fetch(`/Books/GetSavedResponses?userId=${encodeURIComponent(userId)}`);
             console.log("🔍 Response status:", response.status);

             if (!response.ok) {
                 throw new Error(`HTTP error! status: ${response.status}`);
             }

             const books = await response.json();
           //  console.log("📚 Books data received:", books);

             const dropdown = document.getElementById("savedResponsesDropdown");

             if (!dropdown) {
                 console.error("❌ Dropdown element not found!");
                 return;
             }

             // Clear and populate dropdown
             dropdown.innerHTML = '<option value="">📚 Load a previously generated book...</option>';

             if (Array.isArray(books) && books.length > 0) {
                 books.forEach(book => {
                     const option = document.createElement("option");
                     option.value = book.bookId;
                     option.textContent = `${book.bookTitle} (${book.createdDate || 'No date'})`;
                     dropdown.appendChild(option);
                 });
               //  console.log(`✅ SUCCESS: Loaded ${books.length} books into dropdown`);
             } else {
                 const option = document.createElement("option");
                 option.value = "";
                 option.textContent = "No saved books found - Generate one first!";
                 option.disabled = true;
                 dropdown.appendChild(option);
              //   console.log("❌ No books found for this user");
             }
         } catch (error) {
             console.error("❌ Error in loadSavedBooksDropdown:", error);
         }
     }
    
    //===========================================100% OK
    //   Load Book's Chapters
    //===========================================
    async function loadBookAllChaptersNumbers(){
        console.log("🔄 Loading loadBookAllChaptersNumbers Function");
       
        const userId = document.getElementById("UserId").value;
        const bookId = document.getElementById('BookId').value;
        const ddl = document.getElementById("ChapterDropdown");
        const statusInput = document.getElementById("Status");

          console.log("Fetching chapters for userId ==>>:", userId, "bookId:", bookId);

        if (!userId || !bookId) {
            console.log("Missing userId or bookId");
            return;
        }
        console.log("Fetching chapters for userId:", userId, "bookId:", bookId);

        try {
            const response = await fetch(`/Books/GetSavedChapterNos?userId=${userId}&bookId=${bookId}`);
             
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

           const data = await response.json();
           console.log("📚 API Response data :", data);

            // Clear old items from Drop-Down
             ddl.innerHTML = "";

          if (!data || data.length === 0) {
                 console.log("No chapters found in response");
                 // No saved chapters → show default (1) + Load Option
                 ddl.innerHTML = `
                     <option value="1" selected>1</option>
                     <option value="0">Load previously generated...</option>
                 `;
                 return;
             }

             console.log(`Found ${data.length} chapters`);

             // Saved chapters exist → fill dropdown with ChapterNo - ChapterTitle
             ddl.innerHTML = `<option value="0">Load previously generated...</option>`;

             data.forEach((row, index) => {  // Added index parameter
                 console.log(`Chapter ${index}:`, row);

                 // Check if the expected properties exist
                 const chapterNo = row.chapterNo || row.chapter || row.ChapterNumber || 'N/A';
                 const chapterTitle = row.chapterTitle || row.title || row.Title || 'Untitled Chapter';

                 // Show both ChapterNo and ChapterTitle in dropdown
                 const displayText = `${chapterNo} - ${chapterTitle}`;  // Fixed duplicate declaration

                 ddl.innerHTML += `<option value="${chapterNo}"  // Using chapterNo variable
                                  data-status="${row.chapterStatus || row.status || 'OK'}"
                                  data-title="${chapterTitle}"    // Using chapterTitle variable>
                      ${displayText}
                  </option>`;
             });

             // Select the first chapter and update status
             if (data.length > 0) {
                 const firstChapterNo = data[0].chapterNo || data[0].chapter || data[0].ChapterNumber;
                 if (firstChapterNo) {
                     ddl.value = firstChapterNo;
                     // Auto-load the first chapter's data
                     loadBookChapterNos(firstChapterNo);
                 }
             }

         } catch (error) {
             console.error("Error loading chapters:", error);
             // Fallback to default options
             ddl.innerHTML = `
                 <option value="1" selected>1</option>
                 <option value="0">Load previously generated...</option>
             `;
             statusInput.value = "OK";
         }

    }
  
     //=============================================
    //   Update Chapter Form with Loaded Data
    //=============================================
    function updateChapterForm(chapterData) {
        // Update chapter title - adjust selector based on your HTML structure
        const chapterTitleInput = document.querySelector('input[name="ChapterTitle"], #ChapterTitle, [placeholder*="Chapter Title"]');
        if (chapterTitleInput && chapterData.chapterTitle) {
            chapterTitleInput.value = chapterData.chapterTitle;
        }

        // Update chapter topic - adjust selector based on your HTML structure
        const chapterTopicInput = document.querySelector('input[name="ChapterTopic"], #ChapterTopic, [placeholder*="Chapter Topic"]');
        if (chapterTopicInput && chapterData.chapterTopic) {
            chapterTopicInput.value = chapterData.chapterTopic;
        }

        // Update chapter content - adjust selector based on your HTML structure
        const chapterContentInput = document.querySelector('textarea[name="Content"], #Content, [placeholder*="Content"]');
        if (chapterContentInput && chapterData.content) {
            chapterContentInput.value = chapterData.content;
        }

        // Update any other fields you have
        console.log("Chapter data loaded:", chapterData);
    }
     //=======================================
     //   Disable all Controle
     //=======================================
         function disableControls2() {

         // List of control IDs to disable
         const controls = [
             "savedResponsesDropdown",
             "createBookBtn",
             "BookTitle",
           //  "addChapterBtn",
             "Status",
             "UserInput"
         ];

         controls.forEach(id => {
             const el = document.getElementById(id);
             if (el) {
                 el.disabled = true;
                 el.style.opacity = "0.6"; // Makes visibly disabled
                 el.style.pointerEvents = "none";
             }
         });
     }
    //=======================================
    //   Disable all Controle
    //=======================================
        function disableControls() {

        // List of control IDs to disable
        const controls = [
            "savedResponsesDropdown",
            "createBookBtn",
            "BookTitle",
           // "addChapterBtn",
            "Status",
            "UserInput"
        ];

        controls.forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.disabled = true;
                el.style.opacity = "0.6"; // Makes visibly disabled
                el.style.pointerEvents = "none";
            }
        });
    }
     //=======================================
     //   Enable all Controle
     //=======================================
         function enableControls() {

         // List of control IDs to enable
         const controls = [
             "savedResponsesDropdown",
             "createBookBtn",
             "BookTitle",
            // "addChapterBtn",
             "ChapterDropdown",
             "findShowBtn",
             "Status",
             "UserInput"
         ];

         controls.forEach(id => {
             const el = document.getElementById(id);
             if (el) {
                 el.disabled = false;
                  el.style.opacity = "1"; // Full opacity for enabled state
                  el.style.pointerEvents = "auto"; // Allow interactions
             }
         });
     }
    //============================================
    //  Check and Disable Buttons for ReadOnly Status
    //============================================
    function checkAndDisableButtonsForReadOnly(statusCode) {
        console.log("🔍 Checking ReadOnly status:", statusCode);

        // Get button references
        const generateBtn = document.getElementById("GenerateBtn");
        const editBtn = document.getElementById("EditBtn");
        const finalizeBtn = document.getElementById("FinalizeBtn");

        if (statusCode === "ReadOnly") {
            // Disable buttons for ReadOnly books
            if (generateBtn) {
                 generateBtn.disabled = true;
                 generateBtn.style.cursor = "not-allowed";
                 generateBtn.title = "Cannot generate - Book is ReadOnly";
                 generateBtn.classList.add('readonly-disabled');
            }
            if (editBtn) {
                editBtn.disabled = true;
                editBtn.style.cursor = "not-allowed";
                editBtn.title = "Cannot edit - Book is ReadOnly";
                editBtn.classList.add('readonly-disabled');
            }
            if (finalizeBtn) {
               finalizeBtn.disabled = true;
               finalizeBtn.style.cursor = "not-allowed";
               finalizeBtn.title = "Cannot finalize - Book is ReadOnly";
               finalizeBtn.classList.add('readonly-disabled');
            }

            console.log("🔒 Buttons disabled - Book is ReadOnly");
            showNotification("📖 This book is ReadOnly - Editing disabled", "info");

        } else {
            // Enable buttons for non-ReadOnly books
            if (generateBtn) {
                generateBtn.disabled = false;
                generateBtn.style.cursor = "pointer";
                generateBtn.title = "Generate Book Chapter using AI";
                generateBtn.classList.remove('readonly-disabled');
            }
            if (editBtn) {
              editBtn.disabled = false;
              editBtn.style.cursor = "pointer";
              editBtn.title = "Edit book content";
              editBtn.classList.remove('readonly-disabled');
            }
            if (finalizeBtn) {
                finalizeBtn.disabled = false;
                finalizeBtn.style.cursor = "pointer";
                finalizeBtn.title = "Finalize book";
                finalizeBtn.classList.remove('readonly-disabled');
            }

            console.log("🔓 Buttons enabled - Book is editable");
        }
    }

    //============================================
    //  Reset Button States (when no book selected)
    //============================================
    function resetButtonStates() {
        console.log("🔄 Resetting button states");

        const generateBtn = document.getElementById("generateBtn");
        const editBtn = document.getElementById("EditBtn");
        const finalizeBtn = document.getElementById("FinalizeBtn");

        // Enable all buttons and remove readonly styling
        if (generateBtn) {
            generateBtn.disabled = false;
          //  generateBtn.title = "Generate new content";
            generateBtn.classList.remove('readonly-disabled');
        }
        if (editBtn) {
            editBtn.disabled = false;
            editBtn.title = "Edit book content";
            editBtn.classList.remove('readonly-disabled');
        }
        if (finalizeBtn) {
            finalizeBtn.disabled = false;
            finalizeBtn.title = "Finalize book";
            finalizeBtn.classList.remove('readonly-disabled');
        }
    }
    //============================================
    //       Disable/Enable Buttons
    //  Manage Button States with Visual Feedback
    //============================================
    function manageButtonStates(state) {
        console.log("🔄 Managing button states for:", state);

        // Get all button references
        const buttons = {
            generateBtn: document.getElementById("generateBtn"),
            editBtn: document.getElementById("EditBtn"),
            finalizeBtn: document.getElementById("FinalizeBtn"),
            savedResponsesDropdown: document.getElementById("savedResponsesDropdown"),
            createBookBtn: document.getElementById("createBookBtn"),
          //  chapterDropdown: document.getElementById("ChapterDropdown"),
          //  plansPurchaseBtn: document.getElementById("plansPurchaseBtn"),
          //  planFeaturesBtn: document.getElementById("planFeaturesBtn"),
            purchaseHistoryBtn: document.getElementById("purchaseHistoryBtn"),
            findShowBtn: document.getElementById("findShowBtn")
        };

        // Remove all state classes first
        Object.values(buttons).forEach(btn => {
            if (btn) {
                btn.classList.remove('state-load', 'state-generate', 'state-edit', 'state-disabled');
            }
        });
         
        // Apply state-specific rules
        switch (state) {
            case "Load":
                // All buttons enabled
                Object.values(buttons).forEach(btn => {
                    if (btn) {
                        btn.disabled = false;
                        btn.classList.add('state-load');
                    }
                });
                console.log("✅ All buttons enabled - Load state");
                break;

            case "Generate":
                // All buttons disabled
                Object.values(buttons).forEach(btn => {
                    if (btn) {
                        btn.disabled = true;
                        btn.classList.add('state-generate', 'state-disabled');
                    }
                });
                console.log("⏳ All buttons disabled - Generate state");
                break;

            case "Edit":
                // Only Generate button disabled
                Object.values(buttons).forEach(btn => {
                    if (btn) {
                        const btnId = btn.id;
                        if (btnId === 'generateBtn') {
                            btn.disabled = true;
                            btn.classList.add('state-edit', 'state-disabled');
                        } else {
                            btn.disabled = false;
                            btn.classList.add('state-edit');
                        }
                    }
                });
                console.log("📝 Generate button disabled - Edit state");
                break;

            default:
                console.warn("⚠️ Unknown state:", state);
                break;
        }
    }
    //=============================================
    //  Cancel Actions
    //=============================================
    function cancelActions(){
        console.log("🛑 Cancel button clicked - aborting request");
        enableControls();

         if (abortController) {
             abortController.abort();
             console.log("✅ Request aborted");
         }

         // Update UI to show cancellation
         const messageElement = document.getElementById('processingMessage');
         if (messageElement) {
             messageElement.innerHTML = '<span style="color: orange;">Request cancelled by user</span>';
             setTimeout(() => {
                 messageElement.style.display = 'none';
             }, 3000);
         }

         const chatContainer = document.getElementById("chatContainer");
         if (chatContainer) {
             const cancelMessage = addMessage('❌ Edit request was cancelled.');
         }

         showNotification('Edit request cancelled', 'warning');
         resetUI();

    }
    //=============================================
    //   Fallback: Update from data attributes
    //=============================================
    function updateFromDataAttributes(ddl, statusInput, titleInput, userInput, selectedValue) {
        const selectedOption = ddl.options[ddl.selectedIndex];
        const chapterStatus = selectedOption.getAttribute('data-status');
        const chapterTitle = selectedOption.getAttribute('data-title');
        const chapterContent = selectedOption.getAttribute('data-content');

        if (chapterStatus) {
            statusInput.value = chapterStatus;
        }
        if (chapterTitle) {
            titleInput.value = chapterTitle;
        }
        if (chapterContent) {
            userInput.value = chapterContent;
        }
    }
    //=============================================
    //   Clear Chapter Data
    //=============================================
    function clearChapterData() {
        // Clear all chapter-related fields
        const fieldsToClear = [
            'input[name="ChapterTitle"], #ChapterTitle',
            'input[name="ChapterTopic"], #ChapterTopic',
            'textarea[name="Content"], #Content'
        ];

        fieldsToClear.forEach(selector => {
            const element = document.querySelector(selector);
            if (element) {
                element.value = '';
            }
        });

        statusInput.value = "OK";
    }
   
    //================================
    //  Loader Spining
    //=================================
        function showGenerateLoading() {
        console.log("🔄 Showing loading state for Generate button");

        const generateBtn = document.getElementById("GenerateBtn");
        const editBtn = document.getElementById("EditBtn");
        const finalizeBtn = document.getElementById("FinalizeBtn");

        // Show spinner and hide normal text in Generate button
        if (generateBtn) {
            const btnText = generateBtn.querySelector('.btn-text');
            const btnLoading = generateBtn.querySelector('.btn-loading');

            //if (btnText) btnText.style.display = 'none';
            //if (btnLoading) btnLoading.style.display = 'inline-block';

            generateBtn.disabled = true;
            generateBtn.style.cursor = 'wait';
        }

        // Disable other buttons
        if (editBtn) {
            editBtn.disabled = true;
            editBtn.style.cursor = 'not-allowed';
            editBtn.style.opacity = '0.6';
        }

        if (finalizeBtn) {
            finalizeBtn.disabled = true;
            finalizeBtn.style.cursor = 'not-allowed';
            finalizeBtn.style.opacity = '0.6';
        }
    }
    //=======================================
        function hideGenerateLoading() {
        console.log("🔚 Hiding loading state for Generate button");

        const generateBtn = document.getElementById("GenerateBtn");
        const editBtn = document.getElementById("EditBtn");
        const finalizeBtn = document.getElementById("FinalizeBtn");

        // Hide spinner and show normal text in Generate button
        if (generateBtn) {
            const btnText = generateBtn.querySelector('.btn-text');
            const btnLoading = generateBtn.querySelector('.btn-loading');

            if (btnText) btnText.style.display = 'inline-block';
            if (btnLoading) btnLoading.style.display = 'none';

            generateBtn.disabled = false;
            generateBtn.style.cursor = 'pointer';
        }

        // Re-enable other buttons based on current status
        const currentStatus = document.getElementById('Status').value;
        checkAndDisableButtonsForReadOnly(currentStatus);
    }
      //===(16-3)============================================OK
      // Load Selected Book from Drop-Down from Books table
      //    if not found then Load same from
      //          RawData table
      //======================================================
       // async function loadSelectedResponse2(bookId) {
            // console.log("🔄 loadSelectedResponse() called with bookId:", bookId);

            // if (!bookId) {
            //     console.log("❌ No book selected");
            //     clearBookForm();
            //     return;
            // }

            // try {
            //     const userId = document.getElementById("UserId").value;
            //     if (!userId || userId === "0") {
            //         throw new Error("User ID not found");
            //     }

            //     console.log("🔍 Loading book data for User:", userId, "Book:", bookId);

            //     // Show loading state
            //     showLoadingIndicator(true);

            //     // First try to get book details from Books table
            //     let response = await fetch(`/Books/GetBookDetails?userId=${userId}&bookId=${bookId}`);

            //     if (!response.ok) {
            //         console.log("📚 Book not found in Books table, trying APIRawResponse...");
            //         // If not found, load from APIRawResponse table
            //         response = await fetch(`/Books/GetLastBookrawResponseData?userId=${userId}&bookId=${bookId}&responseId=0`);

            //         if (!response.ok) {
            //             throw new Error("Failed to load book details from both sources");
            //         }
            //     }

            //     const result = await response.json();
            //     console.log("📚 Book data received:", result);

            //     if (result.success) {
            //         // ✅ Fill the ResponseId field if available
            //         if (result.responseId) {
            //             document.getElementById("ResponseId").value = result.responseId;
            //         }

            //         // ✅ Fill the textarea or content field
            //         if (result.data) {
            //             document.getElementById("UserInput").value = result.data;
            //         }

            //         // Populate form with book data
            //         populateBookForm(result);

            //         // Display book content
            //         showBookContent(result);

            //         showNotification("Book loaded successfully!", "success");

            //     } else {
            //         clearBookForm();
            //         showNotification("Error: " + result.message, "error");
            //     }

            // } catch (error) {
            //     console.error("❌ Error loading book details:", error);
            //     clearBookForm();
            //     showNotification("Error loading book details: " + error.message, "error");
            // } finally {
            //     showLoadingIndicator(false);
            // }
   // }
    // ===(15-2)==================================================OK
    // ====      TO LOAD LAST BOOK'S Data and Disply            ===
   //  ====   When Page Load Auto Display Last Book's Chapter   ===
    // ============================================================
   //  ---------------------> Execution Step  <--------------------
     // async function loadLastBookData(bookId) {
     //     console.log("🔄 loadLastBookData() called");
     //     const userId = document.getElementById("UserId").value;
     //     const bookId = document.getElementById("savedResponsesDropdown").value;

     //     console.log("🔍 User ID:", userId);
     //     console.log("🔍 Book ID:", bookId);

     //     if (!userId || userId === "0") {
     //         console.error("❌ No valid user ID provided");
     //         return;
     //     }

     //     if (!bookId || bookId === "0") {
     //         console.error("❌ No valid Book Selection");
     //         return;
     //     }

     //     try {
     //         console.log("🔍 Calling API: /Books/GetLastBookrawResponseData?userId=" + userId + "&bookId=" + bookId);

     //         const responseId = document.getElementById("ResponseId").value || 0;
     //         const response = await fetch(`/Books/GetLastBookrawResponseData?userId=${userId}&bookId=${bookId}&responseId=${responseId}`);

     //         console.log("🔍 Response status:", response.status);

     //         if (!response.ok) {
     //             throw new Error(`HTTP error! status: ${response.status}`);
     //         }

     //         const result = await response.json();
     //         console.log("📚 Books data received:", result);

     //         if (result.success) {
     //             populateBookForm(result);
     //             displayBook(result);
     //             showNotification("Last book loaded successfully!", "success");
     //         } else {
     //             showNotification("Error loading book: " + result.message, "error");
     //         }

     //     } catch (error) {
     //         console.error("❌ Error in loadLastBookData:", error);
     //         showNotification("Error loading last book: " + error.message, "error");
     //     }

     // }
     //===(17-43)=== Function to show/hide loading indicator
         function showLoadingIndicator(show) {
               const dropdown = document.getElementById('savedResponsesDropdown');
               if (show)
               {
                   dropdown.disabled = true;
                   dropdown.style.opacity = '0.7';
               } else {
                   dropdown.disabled = false;
                   dropdown.style.opacity = '1';
               }
           }
       //====(18-41)========================================100% OK
       // Function to populate form fields with book data
       //===================================================
       function populateBookForm(bookData) {
            console.log("📝 Populating form with book data:", bookData);
           try {
               // Safely update fields only if they exist
               const bookIdElement = document.getElementById("BookId");
               const titleElement = document.getElementById("Title");
               const descriptionElement = document.getElementById("Description");
               const genreElement = document.getElementById("Genre");

               if (bookIdElement && bookData.bookId) {
                   bookIdElement.value = bookData.bookId;
               }

               if (titleElement && bookData.bookTitle) {
                   titleElement.value = bookData.bookTitle;
               }

               if (descriptionElement && bookData.description) {
                   descriptionElement.value = bookData.description;
               }

               if (genreElement && bookData.genre) {
                   genreElement.value = bookData.genre;
               }

               console.log("✅ Form populated successfully");

           } catch (error) {
               console.error("❌ Error in populateBookForm:", error);
           }
       }
       // ====(19-24)==== UI Helper Function to DISPLAY BOOK CONTENT ===================== OK
       //  Display Chapter Content
       //======================================
        function showBookContent(book) {

              console.log("📝 Loading showBookContent() function ==>>>:", book);

             const chatContainer = document.getElementById("chatContainer");

             // Clear existing content
             chatContainer.innerHTML = '';

             // Add book title message
             const titleMessage = addMessage(`📖 **${book.title || "Untitled Book"}**`);

            // Add chapters if available
            if (book.chapters && book.chapters.length > 0) {
                 setTimeout(() => {
                      const chaptersMessage = addMessage(`Here are the chapters of your book:`);
                       console.log("📝 Populating Chapter Content of book =>:", book);
                 // Add each chapter with accordion
                 book.chapters.forEach((chapter, index) => {
                      setTimeout(() => {
                         const chapterDiv = document.createElement('div');
                         chapterDiv.className = 'chapter-accordion';
                         chapterDiv.innerHTML = `
                                    <div class="chapter-item">
                                        <h3 class="chapter-header">
                                            <button class="chapter-button collapsed" type="button" data-bs-toggle="collapse"
                                                    data-bs-target="#chapterCollapse${index}">
                                                Chapter ${chapter.number || index + 1}: ${chapter.name || chapter.title || "Untitled"}
                                            </button>
                                        </h3>
                                        <div id="chapterCollapse${index}" class="collapse">
                                            <div class="chapter-body">
                                                ${chapter.content || "No content available"}
                                            </div>
                                        </div>
                                    </div>
                                `;

                                // Create a new message for each chapter
                                const chapterMessage = document.createElement('div');
                                chapterMessage.className = 'message message-ai';
                                chapterMessage.innerHTML = `
                                    <div class="message-avatar">📚</div>
                                    <div class="message-content">
                                        <div class="streaming-content">
                                            ${chapterDiv.outerHTML}
                                        </div>
                                    </div>
                                `;

                                chatContainer.appendChild(chapterMessage);

                                // Scroll to bottom
                                chatContainer.scrollTop = chatContainer.scrollHeight;

                            }, index * 300);
                        });
                    }, 500);
                } else {
                    setTimeout(() => {
                        addMessage("No chapters found in this book.");
                    }, 500);
                }
        }
        //===(20-31)============================================
        // ========= On Save Button SAVE the BOOK ==============
        //======================================================
        async function saveBook() {
            const rawResponse = document.getElementById('APIRawResponse').value;
            if (!rawResponse) {
                showNotification('Please generate a book first!', 'warning');
                return;
            }
            const requestData = {
                    UserId: document.getElementById('UserId').value,
                    BookId: document.getElementById('BookId').value,
                    Title: document.getElementById('Title').value,
                    Chapter: parseInt(document.getElementById('Chapter').value),
                    UserInput: document.getElementById('UserInput').value
           };
            const body = {
                userId: document.getElementById('UserId').value,
                bookId: document.getElementById('BookId').value,
                title: document.getElementById('Title').value,
                chapter: parseInt(document.getElementById('Chapter').value),
                apiRaw: rawResponse
            };

            try {
                const res = await fetch('/Books/SaveBookFromAPI', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                if (res.ok) {
                    showNotification('✅ Book saved successfully!', 'success');
                    loadSavedBooksDropdown(); // Refresh dropdown after saving
                    addMessage('💾 Your book has been saved to your library!', false);
                } else {
                    throw new Error('Failed to save book');
                }
            } catch (err) {
                showNotification('Error saving book: ' + err.message, 'error');
            }
        }
    //===============================================
    //   Save/Update changes in APIRawResponse Table
    //==============================================
    // async function updateBook() {
    //     console.log("🟢 Step 1: updateBook() function started");

    //     // --- Step 2: Collect input values from the page ---
    //     const requestData = {
    //         ResponseId: document.getElementById('ResponseId').value,
    //         UserId: document.getElementById('UserId').value,
    //         BookId: document.getElementById('BookId').value,
    //         Title: document.getElementById('Title').value,
    //         Chapter: parseInt(document.getElementById('Chapter').value),
    //         UserInput: document.getElementById('UserInput').value
    //     };

    //     console.log("📋 Step 2: Collected input data:", requestData);

    //     try {
    //         const res = await fetch('/Books/UpdateBookInAPI', {
    //             method: 'POST',
    //             headers: { 'Content-Type': 'application/json' },
    //             body: JSON.stringify(requestData)
    //         });

    //         // Check if response is OK
    //         if (!res.ok) {
    //             throw new Error(`HTTP error! status: ${res.status}`);
    //         }

    //         const result = await res.text();
    //         console.log("✅ Update successful:", result);

    //         showNotification('✅ Book updated successfully!', 'success');
    //         addMessage('💾 Your book has been updated in your library!', false);

    //     } catch (err) {
    //         console.error("❌ Error updating book:", err);
    //         showNotification('Error updating book: ' + err.message, 'error');
    //     }
    // }
   
         //=====(4)=============================OK
         // Plans from Plans => PlansController
         //=======================================
          function showPricingPlans() {
                    console.log("✅ Step 1: showPricingPlans called");
                fetch('/Plans/GetPlans')
                    .then(response => response.json())
                    .then(plans => {
                        let html = `<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin: 20px 0;">`;

                        plans.forEach(availablePlan => {
                            html += `
                                <div style="border: 2px solid #e0e0e0; border-radius: 15px; padding: 25px; text-align: center;">
                                    <h4 style="color: #4a6cf7; margin-bottom: 15px;">${availablePlan.planName}</h4>
                                    <div style="font-size: 2rem; font-weight: bold; margin-bottom: 15px;">
                                        $${availablePlan.planRate}<span style="font-size: 1rem; color: #666;"> / ${availablePlan.planDays} days</span>
                                    </div>
                                    <p><strong>Max eBooks:</strong> ${availablePlan.maxEBooks}</p>
                                    <p>${availablePlan.planDescription ?? ""}</p>
                                    <button class="btn btn-primary" onclick="selectPlan(${availablePlan.planId})">
                                        Select ${availablePlan.planName}
                                    </button>
                                </div>
                            `;
                        });
                        html += `</div>`;

                        Swal.fire({
                            title: 'Choose Your Plan',
                            html: html,
                            showConfirmButton: false,
                            showCloseButton: true,
                            width: '900px'
                        });
                    })
                    .catch(error => {
                        console.error("Error fetching plans:", error);
                        Swal.fire("Error", "Could not load plans.", "error");
                    });
            }
            //=============================================================OK
            //====(5)=== Call Checkout.cshtml after confirmation of Plan  ==
            //==============================================================
             function selectPlan(planId) {
                         Swal.fire({
                             title: 'Confirm Plan Selection',
                             text: 'Do you want to continue to checkout?',
                             icon: 'question',
                             showCancelButton: true,
                             confirmButtonText: 'Yes, Continue'
                         }).then((result) => {
                             if (result.isConfirmed) {
                                 window.location.href = `/Payments/Checkout?planId=${planId}`;
                             }
                         });
             }

        //===(6)========================================OK
        // Plan Features Selection => PlansController
        //==============================================
        function showPlanFeatures() {
           // console.log("✅ Step 1: showPlanFeatures called");
            fetch('/Plans/GetPlanFeatures')
              // console.log("✅ Step 2: Plans/GetPlanFeatures called");
                .then(response => response.json())
                .then(features => {
                    let html = `
                        <div class="features-container" style="max-height: 500px; overflow-y: auto; padding: 10px;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin: 10px 0;">
                    `;

                    features.forEach(feature => {
                        html += `
                            <div style="border: 1px solid #ddd; border-radius: 10px; padding: 15px; text-align: left; background: #f9f9f9;">
                                <div style="display: flex; align-items: flex-start; gap: 10px; margin-bottom: 10px;">
                                    <input type="checkbox"
                                           id="feature_${feature.featureId}"
                                           value="${feature.featureId}"
                                           class="feature-checkbox"
                                           style="margin-top: 3px;">
                                    <div style="flex: 1;">
                                        <h5 style="color: #4a6cf7; margin: 0 0 5px 0;">${feature.featureName}</h5>
                                        <div style="font-size: 1.5rem; font-weight: bold; color: #28a745;">
                                            $${feature.featureRate}
                                        </div>
                                    </div>
                                </div>
                                <p style="margin: 0; color: #666; font-size: 0.9rem;">${feature.description || "No description available"}</p>
                            </div>
                        `;
                    });

                    html += `
                            </div>
                            <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <div>
                                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="selectAllFeatures()">
                                            Select All
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="deselectAllFeatures()" style="margin-left: 10px;">
                                            Deselect All
                                        </button>
                                    </div>
                                    <strong>Selected: <span id="selectedCount">0</span> features</strong>
                                </div>
                                <div id="selectedFeaturesList" style="font-size: 0.9rem; color: #666;"></div>
                            </div>
                        </div>
                    `;

                    Swal.fire({
                        title: 'Select Features',
                        html: html,
                        showConfirmButton: true,
                        showCancelButton: true,
                        confirmButtonText: 'Confirm Selection',
                        cancelButtonText: 'Cancel',
                        width: '1000px',
                        didOpen: () => {
                            // Add event listeners to checkboxes
                            const checkboxes = document.querySelectorAll('.feature-checkbox');
                            checkboxes.forEach(checkbox => {
                                checkbox.addEventListener('change', updateSelectedFeatures);
                            });
                            updateSelectedFeatures(); // Initial update
                        }
                    }).then((result) => {
                        if (result.isConfirmed) {
                            confirmFeatureSelection();
                        }
                    });
                })
                .catch(error => {
                    console.error("Error fetching plan features:", error);
                    Swal.fire("Error", "Could not load features.", "error");
                });
        }
        //======================================================OK
        // ===(7)==  Update selected features count and list
        //=====================================================
        function updateSelectedFeatures() {
             console.log("✅ Step 3: updateSelectedFeatures() called");
            const selectedCheckboxes = document.querySelectorAll('.feature-checkbox:checked');
            const selectedCount = selectedCheckboxes.length;

            document.getElementById('selectedCount').textContent = selectedCount;

            const selectedFeaturesList = document.getElementById('selectedFeaturesList');
            if (selectedCount === 0) {
                selectedFeaturesList.innerHTML = '<em>No features selected</em>';
            } else {
                const featureNames = Array.from(selectedCheckboxes).map(checkbox => {
                    const featureDiv = checkbox.closest('div[style*="border: 1px solid #ddd"]');
                    const featureName = featureDiv.querySelector('h5').textContent;
                    return featureName;
                });
                selectedFeaturesList.innerHTML = '<strong>Selected:</strong> ' + featureNames.join(', ');
            }
        }

        //====(8)====== Select all features == OK
        function selectAllFeatures() {
            const checkboxes = document.querySelectorAll('.feature-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = true;
            });
            updateSelectedFeatures();
        }

        //====(9)=== Deselect all features == OK
        function deselectAllFeatures() {
            const checkboxes = document.querySelectorAll('.feature-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = false;
            });
            updateSelectedFeatures();
        }

        //====(10)=== Handle confirmed selection===OK
        function confirmFeatureSelection() {
           //   console.log("✅ Step 4: confirmFeatureSelection() called");
            const selectedCheckboxes = document.querySelectorAll('.feature-checkbox:checked');
            const selectedFeatureIds = Array.from(selectedCheckboxes).map(checkbox => checkbox.value);

            if (selectedFeatureIds.length === 0) {
                Swal.fire("Info", "Please select at least one feature.", "info");
                return;
            }

            console.log("Selected feature IDs:", selectedFeatureIds);
                 // Store the selection for later use
            localStorage.setItem('selectedFeatures', JSON.stringify(selectedFeatureIds));

            // Call selectPlanFeatures with the selected feature IDs
            selectPlanFeatures(selectedFeatureIds);
        }
        // =====(11)===== Call Checkout.cshtml after confirmation of Plan Features ==============OK
        async function selectPlanFeatures(selectedFeatureIds) {
               console.log("🔍 STEP 1:selectPlanFeatures called with:", selectedFeatureIds);

             const result = await Swal.fire({
                 title: 'Confirm Plan Selection',
                 html: `You have selected <strong>${selectedFeatureIds.length}</strong> features.<br>
                        Do you want to continue to checkout?`,
                 icon: 'question',
                 showCancelButton: true,
                 confirmButtonText: 'Yes, Continue to Checkout',
                 cancelButtonText: 'Cancel'
             });
              console.log("🔍 STEP 2: SweetAlert result:", result);
             if (result.isConfirmed) {
              console.log("🔍 STEP 3: User confirmed, starting feature save...");
             try {
                  console.log("🔍 STEP 4: Calling saveAuthorFeatures...");

                 const saveResult = await saveAuthorFeatures(selectedFeatureIds);
                  console.log("🔍 STEP 5: saveAuthorFeatures returned:", saveResult);

                  if (saveResult  && saveResult.success) {
                       console.log("🔍 STEP 6: Save successful, closing SweetAlert...");
                     Swal.close();

                       // Pass both feature IDs and bill ID to checkout
                      //const featureIdsString = selectedFeatureIds.join(',');
                      //window.location.href = `/Payments/Checkout?featureIds=${featureIdsString}&billId=${saveResult.billId}&saved=true`;

                     if (saveResult.billId) {
                         console.log("✅ STEP 7: Redirecting with billId:", saveResult.billId);

                         window.location.href = `/Payments/CheckoutPayment?billId=${saveResult.billId}`;
                     } else {
                         console.log("⚠️ STEP 7: No billId received, using featureIds");
                         const featureIdsString = selectedFeatureIds.join(',');
                         window.location.href = `/Payments/CheckoutPayment?featureIds=${featureIdsString}&saved=true`;
                     }
                 } else {
                      console.error("❌ STEP 6:Save failed:", saveResult.message);
                       const errorMessage = saveResult?.message || "Unknown error occurred";
                     Swal.fire('Error', `Failed to save features: ${saveResult.message}`, 'error');
                 }
             } catch (error) {
                   console.error("❌ STEP 4-5: Exception caught:", error);
                 Swal.fire('Error', `Failed to save features: ${error.message}`, 'error');
             }
           }
        }
        function getCurrentUserId() 
        {
            // Get user ID from the form element
            const userIdElement = document.getElementById('UserId');
            if (userIdElement && userIdElement.value) {
                return parseInt(userIdElement.value);
            }

            // Alternative: Get from hidden field or other source
            const hiddenUserId = document.querySelector('input[name="UserId"]');
            if (hiddenUserId && hiddenUserId.value) {
                return parseInt(hiddenUserId.value);
            }

            console.error("❌ UserId not found in form");
            return 0; // or throw an error
        }
     //    //====(12)========= Helper function ============== OK
     //        // Helper function to get current user ID
     //    function getCurrentUserId() {
     //        console.log("🔍 Getting current user ID...");

     //        // Try different methods to get user ID

     //        // 1. Check if there's a UserId element
     //        const userIdElement = document.getElementById('UserId');
     //        if (userIdElement && userIdElement.value) {
     //            console.log("✅ User ID from UserId element:", userIdElement.value);
     //            return parseInt(userIdElement.value);
     //        }

     //        // 2. Check if there's a userId element (lowercase)
     //        const userIdElement2 = document.getElementById('userId');
     //        if (userIdElement2 && userIdElement2.value) {
     //            console.log("✅ User ID from userId element:", userIdElement2.value);
     //            return parseInt(userIdElement2.value);
     //        }

     //        // 3. Check ViewBag (if available in your Razor view)
     //        if (typeof userId !== 'undefined' && userId) {
     //            console.log("✅ User ID from ViewBag:", userId);
     //            return parseInt(userId);
     //        }

     //        // 4. Check localStorage
     //        const storedUserId = localStorage.getItem('UserId') || localStorage.getItem('userId');
     //        if (storedUserId) {
     //            console.log("✅ User ID from localStorage:", storedUserId);
     //            return parseInt(storedUserId);
     //        }

     //        // 5. Check sessionStorage
     //        const sessionUserId = sessionStorage.getItem('UserId') || sessionStorage.getItem('userId');
     //        if (sessionUserId) {
     //            console.log("✅ User ID from sessionStorage:", sessionUserId);
     //            return parseInt(sessionUserId);
     //        }

     //        console.error("❌ Could not find user ID");
     //        return 1; // Fallback - adjust as needed
     //    }

     //    //===(13)=== Also update your getCurrentAuthorId function to be consistent ===OK
     //    function getCurrentAuthorId() {
     //        console.log("🔍 Getting current author ID...");

     //        // Try different methods to get author ID

     //        // 1. Check if there's an AuthorId element
     //        const authorIdElement = document.getElementById('AuthorId');
     //        if (authorIdElement && authorIdElement.value) {
     //            console.log("✅ Author ID from AuthorId element:", authorIdElement.value);
     //            return parseInt(authorIdElement.value);
     //        }

     //        // 2. Check if there's an authorId element (lowercase)
     //        const authorIdElement2 = document.getElementById('authorId');
     //        if (authorIdElement2 && authorIdElement2.value) {
     //            console.log("✅ Author ID from authorId element:", authorIdElement2.value);
     //            return parseInt(authorIdElement2.value);
     //        }

     //        // 3. For many systems, AuthorId is the same as UserId
     //        console.log("⚠️ No AuthorId found, using UserId instead");
     //        return getCurrentUserId();
     //    }

        //=====(14)===== Function to save features using the new API endpoint === OK
        async function saveAuthorFeatures(featureIds) {
             console.log("✅ Step 6: Continue to saveAuthorFeatures called");
             try {
                    const authorId = getCurrentAuthorId(); // Your existing function
                    const userId = getCurrentUserId();
                    const response = await fetch('/api/AuthorPlanFeatures/save-features', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            authorId: userId,
                            userId: userId,
                            featureIds: featureIds
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                     // Debug: Check what's returned
                    console.log("Save features response:", result);

                     if (result.success && result.billId) {
                         console.log("✅ Bill created successfully with ID:", result.billId);
                         return result; // This contains billId
                     } else {
                         throw new Error(result.message || "Failed to save features");
                     }
                } catch (error) {
                    console.error('Error saving features:', error);
                    return { success: false, message: error.message };
                }
           }

        //===(15)==== Helper function to get current author ID == OK
        function getCurrentAuthorId() {
            // Your existing implementation
             const authorIdElement = document.getElementById('UserId');

            if (authorIdElement) {
                return parseInt(authorIdElement.value);
            }

             const storedAuthorId = localStorage.getItem('UserId');
            if (storedAuthorId) {
                return parseInt(storedAuthorId);
            }

            if (typeof currentAuthorId !== 'undefined') {
                return currentAuthorId;
            }

            return 1; // Fallback
        }
        //=======================================
    //   Format Text Helper Function
    //=======================================
    function formatText(text) {
        if (text === undefined || text === null) return '';
        return String(text).replace(/\r\n/g, '\n');
    }
     //     //===(16)====================OK
     //     //  Plan Features in Table
     //     //===========================
     //      function showFeatureLocks()
     //      {
     //           console.log("✅ Step 1: showFeatureLocks ");
     //           fetch('/Payments/LoadFeatureLocks')
     //               .then(response => response.text())
     //               .then(html => {
     //                    Swal.fire({
     //                         title: 'Feature Access Control',
     //                         html: html, // Razor view content
     //                         showConfirmButton: false,
     //                         showCloseButton: true,
     //                         width: '600px'
     //                    });
     //               }).catch(error => {
     //                      console.error('Error loading feature locks:', error);
     //                      Swal.fire('Error', 'Failed to load feature list.', 'error');
     //              });
     //      }

            
     //           //===(19)==== Helper: normalize plain text for <pre> with pre-wrap == OK
     //           function formatText(text) {
     //               if (text === undefined || text === null) return '';
     //               return String(text).replace(/\r\n/g, '\n');
     //           }

               
          
    //    //===(23)==== Helper function to format chapter content === OK
    //    function formatChapterContent(content) {
    //        if (!content) return '<p class="text-muted">No content available.</p>';

    //        // If content is already HTML, return as is
    //        if (content.includes('<') && content.includes('>')) {
    //            return content;
    //        }

    //        // Convert plain text to paragraphs
    //        const paragraphs = content.split('\n\n').filter(p => p.trim());
    //        if (paragraphs.length > 0) {
    //            return paragraphs.map(p => `<p>${p.replace(/\n/g, '<br>')}</p>`).join('');
    //        }

    //        // Fallback: treat each line as a paragraph
    //        return content.split('\n').map(line => `<p>${line}</p>`).join('');
    //    }

    //     // ====(30)================= DISPLAY BOOK IN CHAT =====================
    //     function displayBookInChat(bookData) {
    //         const chapters = bookData.data?.chapters || [];
    //         const bookTitle = bookData.data?.title || "Untitled Book";

    //         // Add book title message
    //         const titleMessage = addMessage(`📖 **${bookTitle}**\n\nHere are the chapters I've created:`);

    //         // Add each chapter
    //         chapters.forEach((chapter, index) => {
    //             setTimeout(() => {
    //                 const chapterMessage = addMessage(`**Chapter ${index + 1}: ${chapter.title}**\n\n${chapter.content.substring(0, 200)}...`);
    //             }, index * 500);
    //         });

    //         // Add completion message
    //         setTimeout(() => {
    //             addMessage(`🎉 Your book "${bookTitle}" is complete! You can now save it or generate another one.`);
    //         }, chapters.length * 500 + 500);
    //     }

     
    //     //===(34)==== Upgrade for specific feature ===OK
    //     async  function upgradeForFeature(feature) {
    //         Swal.fire({
    //             title: 'Upgrade Required',
    //             text: `To access ${feature}, you need to upgrade your plan. Would you like to see upgrade options?`,
    //             icon: 'info',
    //             showCancelButton: true,
    //             confirmButtonColor: '#4a6cf7',
    //             confirmButtonText: 'Show Plans',
    //             cancelButtonText: 'Maybe Later'
    //         }).then((result) => {
    //             if (result.isConfirmed) {
    //                 showPricingPlans();
    //             }
    //         });
    //    }
  
    //      //====(36)=====
    //      function debugBooks() {
    //          // Add your debug logic here if needed
    //          console.log("🔍 Debug books function called");
    //      }
   

    //  //=====(38)=================================== OK
    //  //         Show Selected Book  ==>  <div id="bookResult" class="book-result">
    //  //========================================
    // function displaySavedBook(responseData)
    // {
    //     console.log("🔍 Step: 4 displaySavedBook function called");
    //     const container = document.getElementById("bookResult");
    //     container.innerHTML = ""; // clear old

    //     try {
    //         const parsed = JSON.parse(responseData);

    //         if (parsed.data && parsed.data.chapters)
    //         {
    //             parsed.data.chapters.forEach((chapter, i) => {
    //                 const card = document.createElement("div");
    //                 card.className = "card my-2";

    //                 card.innerHTML = `
    //                     <div class="card-header">
    //                         <b>Chapter ${i + 1}:</b> ${chapter.title}
    //                     </div>
    //                     <div class="card-body">
    //                         <div class="book-text-box" style="max-height:300px; overflow:auto; white-space:pre-wrap;">${chapter.text}</div>
    //                     </div>
    //                 `;

    //                 container.appendChild(card);
    //             });
    //         } else {
    //             container.innerHTML = `<pre>${responseData}</pre>`;
    //         }
    //     } catch (ex) {
    //         container.innerHTML = `<pre>${responseData}</pre>`;
    //     }
    // }
   
    // //=====(40)=======================================
    // // Test with debug endpoint first
    // //================================================
    //     async function testRequest() {
    //           const requestData = {
    //                UserId: document.getElementById('UserId').value,
    //                BookId: document.getElementById('BookId').value,
    //                Title: document.getElementById('Title').value,
    //                Chapter: parseInt(document.getElementById('Chapter').value),
    //                UserInput: document.getElementById('UserInput').value
    //            };
    //            console.log("🔍 Testing request data structure:", requestData);

    //            const testResponse = await fetch('/Books/DebugRequest', {
    //                        method: 'POST',
    //                        headers: { 'Content-Type': 'application/json' },
    //                        body: JSON.stringify(requestData)
    //             });

    //              const result = await testResponse.json();
    //              console.log("📋 Debug endpoint response:", result);
    //           }

    //    //===(42)=== Function to clear the form when no book is selected
    //    function clearBookForm() {
    //            document.getElementById('Chapter').value = 5; // Default value
    //            document.getElementById('Title').value = '';
    //            document.getElementById('UserInput').value = '';
    //            console.log("Form cleared");
    //    }

     
    // //====(43)================================
    // //       Content Formatting Button
    // //========================================
    //  function openAIBookFormatting() 
    //  {
    //         // Get the required parameters
    //          const requestData = 
    //          {
    //                    UserId: document.getElementById('UserId')?.value || '@ViewBag.UserId';
    //                    BookId: document.getElementById('BookId').value,
    //                    Title: document.getElementById('Title').value,
    //                    Chapter: parseInt(document.getElementById('Chapter').value),
    //                    UserInput: document.getElementById('UserInput').value
    //          };
    //          console.log("📖 Opening AI Book Formatting:", { UserId, BookId, Title });
    //          // Redirect to AIBookFormatting page with parameters
    //         window.location.href = `/Books/AIBookFormatting?userId=${UserId}&bookId=${BookId}&chapterTitle=${encodeURIComponent(Title)}`;
    //  }

    // //===(44)===== Option 1: Open in Bootstrap Modal
    // function openBookFormattingModal(userId, bookId, chapterTitle) 
    // {
    //     // Create modal container if it doesn't exist
    //     let modalContainer = document.getElementById('bookFormattingModal');
    //     if (!modalContainer) 
    //     {
    //         modalContainer = document.createElement('div');
    //         modalContainer.id = 'bookFormattingModal';
    //         modalContainer.className = 'modal fade';
    //         modalContainer.innerHTML = `
    //             <div class="modal-dialog modal-xl modal-dialog-scrollable">
    //                 <div class="modal-content">
    //                     <div class="modal-header">
    //                         <h5 class="modal-title">📖 Book Content Formatting</h5>
    //                         <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
    //                     </div>
    //                     <div class="modal-body">
    //                         <div id="bookFormattingContent"></div>
    //                     </div>
    //                     <div class="modal-footer">
    //                         <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
    //                     </div>
    //                 </div>
    //             </div>
    //         `;
    //         document.body.appendChild(modalContainer);
    //     }
    //     // Load the form content
    //     loadBookFormattingForm(userId, bookId, chapterTitle);

    //     // Show modal
    //     const modal = new bootstrap.Modal(modalContainer);
    //     modal.show();
    // }
</script>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

