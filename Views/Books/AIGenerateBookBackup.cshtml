@{
    ViewData["Title"] = "AI Book Generator";
    Layout = "~/Views/Shared/_DashboardLayout.cshtml";
}

<style>
    :root {
        --primary: #7c3aed;
        --primary-light: #8b5cf6;
        --primary-dark: #6d28d9;
        --secondary: #06b6d4;
        --accent: #f59e0b;
        --surface: #ffffff;
        --background: #f8fafc;
        --text-primary: #1e293b;
        --text-secondary: #64748b;
        --border: #e2e8f0;
        --radius: 8px;
        --transition: all 0.2s ease;
    }

    .main-container {
        max-width: 1200px;
        margin: 0;
        padding: 20px;
        min-height: 100vh;
    }

    .header {
        text-align: left;
        margin-bottom: 25px;
    }

        .header h2 {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .header p {
            font-size: 0.95rem;
            color: var(--text-secondary);
            margin: 0;
            line-height: 1.4;
        }

    .premium-buttons {
        margin-bottom: 20px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .generator-card {
        background: var(--surface);
        border-radius: var(--radius);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        border: 1px solid var(--border);
        margin-bottom: 25px;
        max-width: 900px;
    }

    .card-body {
        padding: 20px;
    }

    /* Form Elements - Compact */
    .form-group {
        margin-bottom: 15px;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-bottom: 15px;
    }

    .form-label {
        display: block;
        font-size: 0.8rem;
        font-weight: 600;
        margin-bottom: 5px;
        color: var(--text-primary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        line-height: 1.2;
    }

    .chapter-label {
        font-weight: bold;
        font-size: 0.85rem;
        color: #2563eb;
    }

    /* Wider Inputs */
    .form-control-Input {
        width: 100%;
        padding: 8px 12px;
        border: 1.5px solid var(--border);
        border-radius: 6px;
        font-size: 0.9rem;
        transition: var(--transition);
        background: var(--surface);
        height: 38px;
        display: block;
    }

        .form-control-Input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
        }

    .form-control {
        width: 100%;
        padding: 8px 12px;
        border: 1.5px solid var(--border);
        border-radius: 6px;
        font-size: 0.9rem;
        transition: var(--transition);
        background: var(--surface);
        height: 38px;
    }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
        }

    .form-control2 {
        width: 100%;
        padding: 10px 12px;
        border: 1.5px solid var(--border);
        border-radius: 6px;
        font-size: 0.9rem;
        transition: var(--transition);
        background: var(--surface);
        resize: vertical;
        min-height: 100px;
        font-family: inherit;
    }

        .form-control2:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
        }

    /* Dropdown Container */
    .dropdown-container {
        display: flex;
        gap: 10px;
        align-items: end;
        margin-bottom: 15px;
    }

        .dropdown-container .form-label {
            flex-shrink: 0;
            width: 120px;
        }

        .dropdown-container select {
            flex: 1;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 20 20' fill='none' stroke='%2364748b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 35px;
        }

    /* Buttons */
    .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        padding: 8px 16px;
        border: none;
        border-radius: 6px;
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        text-decoration: none;
        height: 36px;
    }

    .btn-primary {
        background: var(--primary);
        color: white;
    }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

    .btn-secondary {
        background: #6b7280;
        color: white;
    }

        .btn-secondary:hover {
            background: #4b5563;
            transform: translateY(-1px);
        }

    .btn-success {
        background: #10b981;
        color: white;
    }

        .btn-success:hover {
            background: #059669;
            transform: translateY(-1px);
        }

    .btn-outline-primary {
        background: transparent;
        color: var(--primary);
        border: 1.5px solid var(--primary);
    }

        .btn-outline-primary:hover {
            background: var(--primary);
            color: white;
        }

    .btn-outline-success {
        background: transparent;
        color: #10b981;
        border: 1.5px solid #10b981;
    }

        .btn-outline-success:hover {
            background: #10b981;
            color: white;
        }

    .btn-group {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-top: 20px;
    }

    .custom-small-btn {
        padding: 6px 12px;
        font-size: 0.8rem;
        height: 32px;
        min-width: 80px;
    }

    /* Create Book Button */
    .create-book-btn {
        background-color: #dbeafe;
        border: 1.5px solid #3b82f6;
        color: #1e40af;
        white-space: nowrap;
    }

        .create-book-btn:hover {
            background-color: #3b82f6;
            color: white;
        }

    /* Chat History */
    .book-result {
        background: var(--surface);
        border-radius: var(--radius);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        border: 1px solid var(--border);
        max-width: 900px;
    }

        .book-result h5 {
            padding: 15px 20px;
            margin: 0;
            background: #f8fafc;
            border-bottom: 1px solid var(--border);
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
        }

    .chat-container {
        padding: 20px;
    }

    .message {
        display: flex;
        margin-bottom: 16px;
    }

    .message-ai .message-avatar {
        background: var(--primary);
        color: white;
    }

    .message-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 0.8rem;
        margin-right: 12px;
        flex-shrink: 0;
    }

    .message-content {
        background: #f8fafc;
        padding: 12px 16px;
        border-radius: 12px;
        border-top-left-radius: 4px;
        font-size: 0.9rem;
        line-height: 1.5;
        color: var(--text-primary);
    }

    /* Hidden Fields */
    .hidden-fields {
        display: none;
    }

    /* Search Icon */
    .search-icon {
        background: none;
        border: none;
        cursor: pointer;
        padding: 8px;
        color: var(--text-secondary);
        font-size: 1.1rem;
    }

        .search-icon:hover {
            color: var(--primary);
        }

    /* Responsive */
    @@media (max-width: 768px) {
        .main-container {
            padding: 15px;
        }

        .form-row {
            grid-template-columns: 1fr;
            gap: 10px;
        }

        .dropdown-container {
            flex-direction: column;
            align-items: stretch;
            gap: 8px;
        }

            .dropdown-container .form-label {
                width: auto;
            }

        .btn-group {
            flex-direction: column;
        }

        .btn {
            width: 100%;
            justify-content: center;
        }
    }
    /* In generateBook() show loader */
    /* Loading States */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(5px);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        flex-direction: column;
        gap: 20px;
    }

    .loading-spinner {
        width: 50px;
        height: 50px;
        border: 4px solid #f3f4f6;
        border-top: 4px solid #7c3aed;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    .loading-text {
        font-size: 1.1rem;
        color: #374151;
        font-weight: 500;
    }

    .loading-dots {
        display: flex;
        gap: 4px;
    }

    .loading-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #7c3aed;
        animation: bounce 1.4s infinite ease-in-out;
    }

        .loading-dot:nth-child(1) {
            animation-delay: -0.32s;
        }

        .loading-dot:nth-child(2) {
            animation-delay: -0.16s;
        }

    @@keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    @@keyframes bounce {
        0%, 80%, 100% {
            transform: scale(0.8);
            opacity: 0.5;
        }

        40% {
            transform: scale(1);
            opacity: 1;
        }
    }

    /* Button loading states */
    .btn-loading {
        position: relative;
        color: transparent !important;
    }

        .btn-loading::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            top: 50%;
            left: 50%;
            margin-top: -10px;
            margin-left: -10px;
        }

    /* Form loading state */
    .form-loading {
        position: relative;
        pointer-events: none;
        opacity: 0.7;
    }

        .form-loading::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            z-index: 1;
            border-radius: var(--radius);
        }

    /* Specific element loading */
    .input-loading {
        background: linear-gradient(90deg, #f3f4f6 25%, #e5e7eb 50%, #f3f4f6 75%);
        background-size: 200% 100%;
        animation: shimmer 1.5s infinite;
        color: transparent;
    }

    @@keyframes shimmer {
        0% {
            background-position: -200% 0;
        }

        100% {
            background-position: 200% 0;
        }
    }

    /* Progress bar */
    .loading-progress {
        width: 200px;
        height: 4px;
        background: #e5e7eb;
        border-radius: 2px;
        overflow: hidden;
        margin-top: 10px;
    }

    .loading-progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #7c3aed, #8b5cf6);
        border-radius: 2px;
        animation: progress 2s ease-in-out infinite;
    }

    @@keyframes progress {
        0% {
            transform: translateX(-100%);
        }

        50% {
            transform: translateX(0%);
        }

        100% {
            transform: translateX(100%);
        }
    }
</style>

<div class="main-container">
    <!-- Header -->
    <div class="header">
        <h2>AI Book Generator</h2>
        <p>Transform your ideas into beautifully crafted books with artificial intelligence</p>
    </div>

    <!-- Premium Buttons -->
    <div class="premium-buttons">
        <button class="btn btn-primary custom-small-btn" onclick="showPricingPlans()">
            <i class="fas fa-crown"></i> View All Plans
        </button>
        <button class="btn btn-primary custom-small-btn" onclick="showPlanFeatures()">
            <i class="fas fa-info-circle"></i> Feature Details
        </button>
        <button class="btn btn-secondary custom-small-btn" onclick="showPurchaseHistory()">
            <i class="fas fa-receipt"></i> Purchase History
        </button>
    </div>

    <!-- Main Form -->
    <div class="generator-card">
        <div class="card-body">
            <!-- Book Selection -->
            <div class="dropdown-container">
                <label class="form-label chapter-label">BOOK SELECTION</label>
                <select id="savedResponsesDropdown" class="form-control" onchange="loadSelectedResponse(this.value)">
                    <option value="">Load a previously generated book...</option>
                </select>
                <button id="createBookBtn" class="btn custom-small-btn create-book-btn" onclick="createBook()">
                    📖 Create Book
                </button>
            </div>

            <!-- Hidden Fields -->
            <div class="hidden-fields">
                <input type="text" id="UserId" value="@ViewBag.UserId" />
                <input type="text" id="ResponseId" value="0" />
                <input type="text" id="BookId" value="0" />
                <input type="text" id="Status" value="" />
            </div>

            <!-- Book Title -->
            <div class="form-group">
                <label class="form-label chapter-label">BOOK TITLE</label>
                <input type="text" id="BookTitle" class="form-control-Input" value="" placeholder="Enter book title">
            </div>

            <!-- Chapter Number and Title -->
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label chapter-label">CHAPTER NUMBER</label>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <select id="ChapterDropdown" class="form-control" onchange="loadChapterNos(this.value)">
                            <option value="">Load a previously generated chapter numbers...</option>
                        </select>
                        <button class="search-icon" onclick="showSelectedBook()" title="Find & Show">
                            <i class="bi bi-search"></i>
                        </button>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label chapter-label">CHAPTER TITLE</label>
                    <input type="text" id="Title" class="form-control-Input" value="The future of artificial intelligence" placeholder="Enter chapter title">
                </div>
            </div>

            <!-- Chapter Topic -->
            <div class="form-group">
                <label class="form-label chapter-label">CHAPTER TOPIC</label>
                <textarea id="UserInput" class="form-control2" placeholder="Enter chapter topic">If you want peace, work for justice</textarea>
            </div>

            <!-- Action Buttons -->
            <div class="btn-group">
                <button id="Generatebtn" class="btn btn-primary custom-small-btn" onclick="generateBook()">
                    ⚙️ Generate
                </button>
                <button class="btn btn-outline-primary custom-small-btn" onclick="editInChapter()">
                    🔁 Edit
                </button>
                <button class="btn btn-success custom-small-btn" onclick="updateBook()">
                    💾 Update/Save
                </button>
                <button class="btn btn-outline-success custom-small-btn" onclick="finalizeChapter()">
                    ✅ Finalize
                </button>
            </div>

            <input type="hidden" id="APIRawResponse">
        </div>
    </div>

    <!-- Chat History -->
    <div class="book-result">
        <h5>💬 Chat History</h5>
        <div class="chat-container">
            <div class="message message-ai">
                <div class="message-avatar">AI</div>
                <div class="message-content">
                    Hello! I'm ready to help you create an amazing book. Just enter your topic above and click "Generate Book" to get started.
                </div>
            </div>
        </div>
    </div>
    @*  Loading ... *@
    <!-- Global Loading Overlay -->
    <div id="globalLoading" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text" id="loadingMessage">Processing your request...</div>
        <div class="loading-progress">
            <div class="loading-progress-bar"></div>
        </div>
    </div>

    <!-- Inline loading for specific sections -->
    <div id="formLoading" class="loading-overlay" style="display: none; position: absolute; border-radius: var(--radius);">
        <div class="loading-spinner" style="width: 30px; height: 30px;"></div>
    </div>
</div>

<script>
    function loadChapterNos(chapterNo) {
        console.log("Loading chapter:", chapterNo);
        // Implementation here
    }

    function showSelectedBook() {
        console.log("Showing selected book");
        // Implementation here
    }

    function updateBook() {
        console.log("Updating book");
        // Implementation here
    }

    function finalizeChapter() {
        console.log("Finalizing chapter");
        // Implementation here
    }
    // Global loading states
    function showLoadingState(message = 'Processing your request...', type = 'global') {
        switch(type) {
            case 'global':
                showGlobalLoading(message);
                break;
            case 'form':
                showFormLoading();
                break;
            case 'button':
                showButtonLoading();
                break;
            case 'generate':
                showGenerateLoading();
                break;
        }
    }

    function hideLoadingState(type = 'global') {
        switch(type) {
            case 'global':
                hideGlobalLoading();
                break;
            case 'form':
                hideFormLoading();
                break;
            case 'button':
                hideButtonLoading();
                break;
            case 'generate':
                hideGenerateLoading();
                break;
        }
    }

    // Global loading overlay
    function showGlobalLoading(message = 'Processing your request...') {
        const loadingOverlay = document.getElementById('globalLoading');
        const loadingMessage = document.getElementById('loadingMessage');

        loadingMessage.textContent = message;
        loadingOverlay.style.display = 'flex';
        document.body.style.overflow = 'hidden'; // Prevent scrolling
    }

    function hideGlobalLoading() {
        const loadingOverlay = document.getElementById('globalLoading');
        loadingOverlay.style.display = 'none';
        document.body.style.overflow = ''; // Restore scrolling
    }

    // Form loading state
    function showFormLoading() {
        const form = document.querySelector('.generator-card');
        const formLoading = document.getElementById('formLoading');

        if (form && formLoading) {
            form.style.position = 'relative';
            formLoading.style.display = 'flex';
            formLoading.style.width = form.offsetWidth + 'px';
            formLoading.style.height = form.offsetHeight + 'px';
            form.appendChild(formLoading);
        }
    }

    function hideFormLoading() {
        const formLoading = document.getElementById('formLoading');
        if (formLoading) {
            formLoading.style.display = 'none';
        }
    }

    // Button loading state
    function showButtonLoading(buttonElement = null) {
        if (buttonElement) {
            // Specific button
            buttonElement.classList.add('btn-loading');
            buttonElement.disabled = true;
        } else {
            // All action buttons
            const actionButtons = document.querySelectorAll('.btn-group .btn');
            actionButtons.forEach(btn => {
                btn.classList.add('btn-loading');
                btn.disabled = true;
            });
        }
    }

    function hideButtonLoading(buttonElement = null) {
        if (buttonElement) {
            buttonElement.classList.remove('btn-loading');
            buttonElement.disabled = false;
        } else {
            const actionButtons = document.querySelectorAll('.btn-group .btn');
            actionButtons.forEach(btn => {
                btn.classList.remove('btn-loading');
                btn.disabled = false;
            });
        }
    }

    // Specific loading states for different actions
    function showGenerateLoading() {
        showGlobalLoading('Generating book content... This may take a few moments.');

        // Also disable the generate button specifically
        const generateBtn = document.querySelector('.btn-primary');
        if (generateBtn) {
            generateBtn.classList.add('btn-loading');
            generateBtn.disabled = true;
        }
    }

    function hideGenerateLoading() {
        hideGlobalLoading();

        const generateBtn = document.querySelector('.btn-primary');
        if (generateBtn) {
            generateBtn.classList.remove('btn-loading');
            generateBtn.disabled = false;
        }
    }

    // Input field loading state (skeleton effect)
    function showInputLoading(inputId) {
        const input = document.getElementById(inputId);
        if (input) {
            input.classList.add('input-loading');
            input.disabled = true;
        }
    }

    function hideInputLoading(inputId) {
        const input = document.getElementById(inputId);
        if (input) {
            input.classList.remove('input-loading');
            input.disabled = false;
        }
    }

    // Chat message loading (typing indicator)
    function showTypingIndicator() {
        const chatContainer = document.getElementById('chatContainer');
        if (chatContainer) {
            const typingMessage = document.createElement('div');
            typingMessage.className = 'message message-ai';
            typingMessage.id = 'typingIndicator';
            typingMessage.innerHTML = `
                <div class="message-avatar">AI</div>
                <div class="message-content">
                    <div class="typing-indicator">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            `;
            chatContainer.appendChild(typingMessage);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
    }

    function hideTypingIndicator() {
        const typingIndicator = document.getElementById('typingIndicator');
        if (typingIndicator) {
            typingIndicator.remove();
        }
    }

    // Progress loading with percentage
    function showProgressLoading(message, duration = 5000) {
        showGlobalLoading(message);

        // Simulate progress (you can replace this with real progress updates)
        let progress = 0;
        const interval = setInterval(() => {
            progress += 5;
            const loadingMessage = document.getElementById('loadingMessage');
            if (loadingMessage) {
                loadingMessage.textContent = `${message} (${progress}%)`;
            }

            if (progress >= 100) {
                clearInterval(interval);
            }
        }, duration / 20);

        return interval; // Return interval ID so you can clear it manually if needed
    }

    // Disable Generate Button
        document.getElementById('Generatebtn').addEventListener('click', function(e) {
         bookId: document.getElementById('BookId').value,

         // Disable the button
        this.disabled = true;
         // Optional: Change button text
         this.textContent = 'Processing...';

         // Optional: Add visual feedback
         this.style.opacity = '0.6';
         this.style.cursor = 'not-allowed';
    });
</script>
<!-- Notification Container -->
<div id="notificationContainer"></div>
<script>
      // -----> Execution Step 2 (exeutes just after controller action method) <-------------
      // Global variables
      const userId = '@ViewBag.UserId';
      console.log("🔍 Logged-in User ID from ViewBag:", userId);
      //===(1)============================OK
      //  On Page Load -->Execution Step 3
      //        PAGE INITIALIZATION
      //===================================
      document.addEventListener('DOMContentLoaded', function()  {
          console.log("🚀 DOM Content Loaded - Starting initialization");

          const generateBtn = document.getElementById('Generatebtn');
          if (shouldDisableGenerateBtn()) {
              generateBtn.disabled = true;
              generateBtn.style.opacity = '0.6';
              generateBtn.style.cursor = 'not-allowed';
          }
         // Handle click event
         document.getElementById('Generatebtn').addEventListener('click', function(e) {
         if (shouldDisableGenerateBtn()) {
               e.preventDefault(); // Prevent the
         }
          // Load books immediately
          loadSavedBooksDropdown();

          // Show debug info after delay
          setTimeout(debugBooks, 1000);

          // Add enter key support
          const userInput = document.getElementById('UserInput');
          if (userInput) {
              userInput.addEventListener('keypress', function(e) {
                  if (e.key === 'Enter') {
                      generateBook();
                  }
              });
          }
          const showBookBtn = document.getElementById('showBookBtn');
         if (showBookBtn) {
             showBookBtn.addEventListener('click', showSelectedBook);
             console.log("✅ Show button event listener attached");
         }
          console.log("✅ Page initialization complete");
      });
      // Function to check if button should be disabled
      function shouldDisableGenerateBtn() {
          const bookId = parseInt(document.getElementById('BookId').value) || 0;
          const status = document.getElementById('Status').value; // Assuming Status is an input/select

          return bookId > 0 && status === "ReadOnly";
      }

      //====(2-37)==============================OK
      //  Run On Button Click 📖 Show
      //    Load Selected Book Data
      //========================================
       async function showSelectedBook()
          {
               console.log("🔄 showSelectedBook() executed after button clicked");

             // --- Step 1: Collect input values from the page ---
             console.log("🔍 Step: 1 get UserId, BookId & ChapterNo from FORM");
             const requestData = {
                 ResponseId: document.getElementById('ResponseId').value,
                 UserId: document.getElementById('UserId').value,
                 BookId: document.getElementById('BookId').value,
                 Title: document.getElementById('Title').value,
                 Chapter: parseInt(document.getElementById('Chapter').value),
                 UserInput: document.getElementById('UserInput').value
             };

             console.log("🔍 Step: 1 requestData Filled", requestData);
             addMessage(`I want to load book chapter: "${requestData.UserInput}" with ${requestData.Chapter} chapters.`, true);

             try {
                 console.log("🔍 Step: 2 Books/GetBookResponse function called");
                 console.log(`🔍 Fetching book content for User: ${requestData.UserId}, Book: ${requestData.BookId}`);

                 const response = await fetch(`/Books/GetBookResponse?userId=${requestData.UserId}&bookId=${requestData.BookId}`);
                 if (!response.ok) {
                     throw new Error(`HTTP error! status: ${response.status}`);
                 }

                 const result = await response.json();
                 console.log("🔍 Step: 3 Books/GetBookResponse returned data ", result);

                 if (!result.success) {
                     Swal.fire("Not Found", result.message, "warning");
                     showNotification("Not Found: " + result.message, "warning");
                     return;
                 }

                 // ✅ STEP 4: SET RESPONSE ID BEFORE DISPLAYING BOOK
                 if (result.responseId) {
                     document.getElementById('ResponseId').value = result.responseId;
                     console.log("📋 ResponseId set to:", result.responseId);
                 }

                 console.log("🔍 Step: 4 running displayBook(result.data) Function Sending: ", result.data);
                 displayBook(result.data);
                 showNotification('✅ Book content loaded successfully!', 'success');

             } catch (err) {
                 console.error('❌ Error loading book content:', err);
                 showNotification('❌ Error loading book content: ' + err.message, 'error');
             } finally {
                 // Restore button state
                 const showBookBtn = document.getElementById('showBookBtn');
                 if (showBookBtn) {
                     showBookBtn.innerHTML = '📖 Show';
                     showBookBtn.disabled = false;
                 }
             }

          }
        //====(3-22)======================================== OK
        //========= Display the Book in Scroll Bars  =====
        //================================================
        function displayBook(bookData, showMode = false) {
            try {
                 if (typeof bookData === 'string') {
                     bookData = JSON.parse(bookData);
                 }
               } catch {}
                 console.log("📖 displayBook() Rendering book", bookData);

                 const core = (bookData && bookData.data) ? bookData.data : (bookData || {});
                 const responseId = core.ResponseId || core.responseId || bookData.ResponseId || bookData.responseId || '';
                 const rawTitle = core.title || bookData.title || '';
                 const suggested = (core.suggest_chapter_name || core.suggestChapterName || '')
                            .split('\n').map(s => s.trim()).filter(Boolean);
                 const inferredTitle = rawTitle || (core.user_input ? `Book: ${core.user_input}` : '');
                 const chaptersRaw = core.chapters || bookData.Chapters || bookData.chapters || [];
                 let chapters = Array.isArray(chaptersRaw) ? chaptersRaw : [];

                 // ✅ SET RESPONSE ID IN THE FORM
                     if (responseId) {
                         document.getElementById('ResponseId').value = responseId;
                         console.log("📋 ResponseId set from book data:", responseId);
                     }
                 // Gracefully handle single-content responses by building a pseudo chapter
                 if (chapters.length === 0 && core.content) {
                     chapters = [{
                        chapterNumber: 1,
                        title: suggested[0] || 'Chapter 1',
                        content: core.content,
                        status: core.status || ''
                     }];
                 }
                 const total = chapters.length;

                 let html = showMode ? `<div class="reader-theme reader-show">` : `<div class="reader-theme">`;

                 if (total === 0) {
                     html = `<div class="alert alert-warning">No content available.</div>`;
                     document.getElementById('bookResult').innerHTML = html;
                     return;
                 }
                // Single chapter: show a focused reader view without extra chrome
                if (total === 1) {
                            const ch = chapters[0];
                            const chapterNumber = ch.chapterNumber ?? ch.ChapterNumber ?? 1;
                            const title = ch.title ?? ch.Title ?? `Chapter ${chapterNumber}`;
                            const content = ch.content ?? ch.Content ?? ch.data ?? ch.Data?.content ?? '';

                            if (showMode) {
                                html += `
                                    <div class="reader-cover">
                                        <div class="reader-cover-inner">
                                            <h2 class="reader-title">${escapeHtml(inferredTitle || title)}</h2>
                                        </div>
                                    </div>`;
                            }

                            html += `
                            <div class="generator-card">
                                <div class="card-body">
                                    <h4 class="fw-bold mb-3">${escapeHtml(title)}</h4>
                                    <div class="chapter-content-container">
                                        <div class="chapter-content-scrollable">${isLikelyHtml(content) ? sanitizeHtml(content) : `<pre>${escapeHtml(formatText(content))}</pre>`}</div>
                                    </div>
                                    ${(core.suggest_chapter_name || core.suggestChapterName) ? (() => {
                                        const raw = core.suggest_chapter_name || core.suggestChapterName || '';
                                        const hasList = /<\s*ul[\s\S]*?>/i.test(raw);
                                        let inner = '';
                                        if (hasList) {
                                            inner = `<div class=\"outline-html\">${sanitizeHtml(raw)}</div>`;
                                        } else {
                                            const items = raw.split('\n').map(x => x.trim()).filter(Boolean).slice(0, 12);
                                            inner = items.map(x => `<span class=\"outline-pill\">${escapeHtml(x)}</span>`).join('');
                                        }
                                        return `
                                            <div class=\"outline-card\">
                                                <div class=\"outline-header\">
                                                    <div class=\"outline-title\"><i class=\"bi bi-list-stars\"></i> Outline</div>
                                                    <button class=\"btn btn-outline-secondary btn-sm\" type=\"button\" onclick=\"const b=this.closest('div').parentElement.nextElementSibling; b.style.display=b.style.display==='none'?'block':'none'\">Toggle</button>
                                                </div>
                                                <div class=\"outline-body\" style=\"${showMode ? '' : 'display:none'}\">${inner}</div>
                                            </div>`;
                                    })() : ''}
                                </div>
                            </div>`;
                            html += `</div>`;
                            document.getElementById('bookResult').innerHTML = html;
                            return;
                        }

                        // Multiple chapters: optional outline + clean accordion only
                        if (showMode && (core.suggest_chapter_name || core.suggestChapterName)) {
                            const raw = core.suggest_chapter_name || core.suggestChapterName || '';
                            const hasList = /<\s*ul[\s\S]*?>/i.test(raw);
                            let inner = '';
                            if (hasList) inner = `<div class=\"outline-html\">${sanitizeHtml(raw)}</div>`;
                            else {
                                const items = raw.split('\n').map(x => x.trim()).filter(Boolean).slice(0, 12);
                                inner = items.map(x => `<span class=\"outline-pill\">${escapeHtml(x)}</span>`).join('');
                            }
                            html += `
                                <div class=\"outline-card\">
                                    <div class=\"outline-header\">
                                        <div class=\"outline-title\"><i class=\"bi bi-list-stars\"></i> Outline</div>
                                    </div>
                                    <div class=\"outline-body\">${inner}</div>
                                </div>`;
                        }

                        html += `<div class="accordion" id="bookAccordion">`;
                        chapters.forEach((ch, index) => {
                            const ResponseId = ch.ResponseId ?? ch.responseId ?? '';
                            const chapterId = `chapter${index}`;
                            const chapterNumber = ch.chapterNumber ?? ch.ChapterNumber ?? (index + 1);
                            const title = ch.title ?? ch.Title ?? `Chapter ${chapterNumber}`;
                            const content = ch.content ?? ch.Content ?? ch.data ?? ch.Data?.content ?? '';
                            const status = ch.status ?? ch.Status ?? '';
                            const finalized = isFinalized(status);
                            const headerBadge = finalized ? `<span class="badge bg-success ms-2">✅ Finalized</span>` : ``;

                            html += `
                            <div class="accordion-item mb-2" id="accordionItem-${chapterId}">
                                <h2 class="accordion-header d-flex align-items-center" id="heading${chapterId}">
                                    <button class="accordion-button ${index === 0 ? '' : 'collapsed'} flex-grow-1"
                                            type="button"
                                            data-bs-toggle="collapse"
                                            data-bs-target="#collapse${chapterId}"
                                            aria-expanded="${index === 0}"
                                            aria-controls="collapse${chapterId}">
                                        <div>
                                            <div class="d-flex align-items-center">
                                                <strong class="me-2">${escapeHtml(title)}</strong>
                                                ${headerBadge}
                                            </div>
                                            <small class="text-muted">Chapter #: ${chapterNumber}</small>
                                        </div>
                                    </button>
                                </h2>
                                <div id="collapse${chapterId}" class="accordion-collapse collapse ${index === 0 ? 'show' : ''}"
                                     aria-labelledby="heading${chapterId}" data-bs-parent="#bookAccordion">
                                    <div class="accordion-body">
                                        <div class="chapter-content-container">
                                            <div class="chapter-content-scrollable">${isLikelyHtml(content) ? sanitizeHtml(content) : `<pre>${escapeHtml(formatText(content))}</pre>`}</div>
                                        </div>

                                        <div class="mt-3">
                                            <label class="form-label small mb-1">Change (instructions or replacement):</label>
                                            <div class="input-group input-group-sm mb-2">
                                                <input type="text" id="changeInput-${chapterId}" class="form-control form-control-sm"
                                                    placeholder="e.g. replace 'apple' with 'pear'">
                                                <button class="btn btn-outline-primary btn-sm" type="button"
                                                    id="changeBtn-${chapterId}"
                                                    onclick="changeChapter('${chapterId}', '${chapterNumber}')"
                                                    ${finalized ? 'disabled' : ''}>
                                                    Change
                                                </button>
                                                <button class="btn btn-outline-success btn-sm ms-2" type="button"
                                                    id="finalizeBtn-${chapterId}"
                                                    onclick="finalizeChapter('${chapterId}', '${chapterNumber}')"
                                                    ${finalized ? 'disabled' : ''}>
                                                    Finalize
                                                </button>
                                            </div>
                                            <div id="changeStatus-${chapterId}" class="small text-muted"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>`;
            });

           html += `</div>`;
           html += `</div>`;
           document.getElementById('bookResult').innerHTML = html;
       }
       //=====(4-18)======================================================= OK
       //=======   Display the Book in Scroll Bars Helper Functions =====
       //================================================================
       // Helper: escape HTML to safely render user/AI content
        function escapeHtml(str) {
           if (str === undefined || str === null) return '';
              return String(str)
               .replace(/&/g, '&amp;')
               .replace(/</g, '&lt;')
               .replace(/>/g, '&gt;')
               .replace(/"/g, '&quot;')
               .replace(/'/g, '&#39;');
        }
       //===(5-20)=== Detect if content likely contains HTML markup == OK
       function isLikelyHtml(content) {
          if (!content) return false;
           return /<\s*\w+[\s\S]*?>/i.test(content);
       }
       //===(6-21)=== Minimal client-side sanitizer to allow basic formatting tags only ==OK
       function sanitizeHtml(unsafeHtml) {
          try {
                const allowedTags = new Set(['p','br','hr','ul','ol','li','strong','b','em','i','u','h1','h2','h3','h4','h5','h6','blockquote','code','pre','span','div']);
                const allowedAttrs = new Set(['class','style']);
                const parser = new DOMParser();
                const doc = parser.parseFromString(String(unsafeHtml), 'text/html');
                const walker = document.createTreeWalker(doc.body, NodeFilter.SHOW_ELEMENT, null);
                const toRemove = [];
                while (walker.nextNode()) {
                     const el = walker.currentNode;
                     if (!allowedTags.has(el.tagName.toLowerCase())) {
                          toRemove.push(el);
                          continue;
                     }
                     // Strip disallowed attributes and dangerous values
                     [...el.attributes].forEach(attr => {
                          const name = attr.name.toLowerCase();
                          const value = attr.value || '';
                           if (!allowedAttrs.has(name)) {
                                   el.removeAttribute(name);
                                   return;
                            }
                            if (name === 'style' && /expression\(|javascript:|url\(/i.test(value)) {
                                   el.removeAttribute('style');
                            }
                      });
                 }
                 toRemove.forEach(n => n.replaceWith(n.textContent || ''));
                 return doc.body.innerHTML;
          } catch (e) {
                 return escapeHtml(String(unsafeHtml));
          }
       }
       //====(7-35)==== Add any missing function that might be called but not defined
       function isFinalized(status) {
              return status === 'finalized' || status === 'approved' || status === 'completed';
       }
       //============================================
       //  Change Chapter Content
       //===========================================
         async function editInChapter() {
             console.log("🟢 Step 1: editInChapter() function started");
             // --- Step 2: Collect input values from the page ---
             const requestData = {
                      UserId: document.getElementById('UserId').value,
                      BookId: document.getElementById('BookId').value,
                      Title: document.getElementById('Title').value,
                      Chapter: parseInt(document.getElementById('Chapter').value),
                      UserInput: document.getElementById('UserInput').value
             };
             console.log("📋 Step 2: Collected input data:", requestData);
             // Add user message
             addMessage(`I want to create a book about: "${requestData.UserInput}" with ${requestData.Chapter} chapters.`, true);

                  //--- Step 3: Show typing indicator replaced --- Show loading spinner on page ---
                  showTypingIndicator();
                  console.log("⏳ Step 3: Displayed loading spinner");

                  // Simulate AI thinking
                  setTimeout(async () => {
                  hideTypingIndicator();

                  // Add AI response with streaming
                  const aiMessageElement = addMessage('');
                  const thinkingText = `Great! I'll create a book about "${requestData.UserInput}" with ${requestData.Chapter} chapters. Let me start generating the content...`;

                  // --- Step 4: Send data to backend controller ---
                   console.log("🚀 Step 4: Sending POST request to /Books/AIEditBook");

                  simulateStreaming(thinkingText, aiMessageElement, async () => {
                  // After streaming completes, make the actual API call
                  try {
                         const response = await fetch('/Books/AIEditBook', {
                           method: 'POST',
                           headers: { 'Content-Type': 'application/json' },
                           body: JSON.stringify(requestData)
                        });
                        console.log("📨 Step 5: Received response:", response);
                        // --- Step 5a: Handle success ---
                        if (response.ok) {
                           const bookData = await response.json();

                           console.log("✅ Step 6: Response converted to JSON:", bookData);
                           document.getElementById('APIRawResponse').value = JSON.stringify(bookData);

                           // Show book generation complete message
                           const completeMessage = addMessage('');
                           const completeText = `✅ Book generated successfully! "${bookData.data?.title || 'Untitled Book'}" is ready with ${bookData.data?.chapters?.length || 0} chapters.`;

                           document.getElementById('ResponseId').value = bookData.responseId;

                           simulateStreaming(completeText, completeMessage, () => {
                               // Display the actual book content
                               displayBook(bookData);
                               console.log("✅ Step 7: Load Saved Response Drop-Down", bookData);
                               loadSavedBooksDropdown(); // Refresh dropdown after generating new book
                               showNotification('Book generated successfully!', 'success');
                           });
                              } else {
                                  const errorText = await response.text();
                                  console.error("❌ Step 8: Server returned error:", errorText);
                                  throw new Error(errorText || 'Failed to generate book');
                              }
                          } catch (error) {
                                // --- Step 9: Handle network or unexpected errors ---
                              console.error("🔥 Step 9: Exception occurred:", error);

                              hideTypingIndicator();
                              const errorMessage = addMessage(`❌ Sorry, I encountered an error: ${error.message}`);
                              showNotification('Failed to generate book', 'error');
                          }
                      });
                  }, 1000);
         }
       // // ====(8-32)================= EDIT CONTENT =====================
       // async function changeChapter(chapterId, chapterNumber) {
       //       console.log("✅ Step 1: Change the Chapter ", chapterId);
       //       const statusEl = document.getElementById(`changeStatus-${chapterId}`);
       //       const changeBtn = document.getElementById(`changeBtn-${chapterId}`);
       //       const finalizeBtn = document.getElementById(`finalizeBtn-${chapterId}`);

       //       try {
       //           statusEl.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Sending change...`;
       //           changeBtn.disabled = true;
       //           finalizeBtn.disabled = true;

       //           const changes = document.getElementById(`changeInput-${chapterId}`).value;
       //           if (!changes || changes.trim().length === 0) {
       //               statusEl.innerHTML = `<span class="text-danger">Please provide change instructions.</span>`;
       //               changeBtn.disabled = false;
       //               finalizeBtn.disabled = false;
       //               return;
       //           }

       //           const payload = {
       //               user_id: document.getElementById('UserId').value || '',
       //               book_id: document.getElementById('BookId').value || '',
       //               chapter: String(chapterNumber),
       //               changes: changes
       //           };

       //           const res = await fetch('/Books/EditChapter', {
       //               method: 'POST',
       //               headers: { 'Content-Type': 'application/json' },
       //               body: JSON.stringify(payload)
       //           });

       //           if (!res.ok) {
       //               const text = await res.text();
       //               statusEl.innerHTML = `<span class="text-danger">Error: ${res.status} - ${text}</span>`;
       //               changeBtn.disabled = false;
       //               finalizeBtn.disabled = false;
       //               return;
       //           }

       //           const json = await res.json();
       //           console.log("🔁 Edit response:", json);

       //           let newContent = json?.data?.content ?? json?.content ?? null;
       //           if (!newContent) {
       //               if (typeof json === 'string') newContent = json;
       //               else newContent = JSON.stringify(json);
       //           }

       //           const contentEl = document.getElementById(`chapterContent-${chapterId}`);
       //           contentEl.innerHTML = `<p>${newContent}</p>`;

       //           statusEl.innerHTML = `<span class="text-success">Change applied successfully.</span>`;
       //           changeBtn.disabled = false;
       //           finalizeBtn.disabled = false;

       //           loadSavedBooksDropdown(); // Refresh dropdown
       //       } catch (err) {
       //           console.error("changeChapter error:", err);
       //           statusEl.innerHTML = `<span class="text-danger">Request failed: ${err.message}</span>`;
       //           document.getElementById(`changeBtn-${chapterId}`).disabled = false;
       //           document.getElementById(`finalizeBtn-${chapterId}`).disabled = false;
       //       }
       // }
       // ====(9-33)================= FINALIZE CONTENT ===================== OK
       async function finalizeChapter(chapterId, chapterNumber) {
             const statusEl = document.getElementById(`changeStatus-${chapterId}`);
             const changeBtn = document.getElementById(`changeBtn-${chapterId}`);
             const finalizeBtn = document.getElementById(`finalizeBtn-${chapterId}`);

             try {
                 statusEl.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Finalizing...`;
                 changeBtn.disabled = true;
                 finalizeBtn.disabled = true;

                 const payload = {
                     user_id: document.getElementById('UserId').value || '',
                     book_id: document.getElementById('BookId').value || '',
                     chapter: String(chapterNumber),
                     approve: true
                 };

                 const res = await fetch('/Books/FinalizeChapter', {
                     method: 'POST',
                     headers: { 'Content-Type': 'application/json' },
                     body: JSON.stringify(payload)
                 });

                 const text = await res.text();
                 console.log("Finalize API returned:", text);

                 if (!res.ok) {
                     statusEl.innerHTML = `<span class="text-danger">Error: ${res.status}</span>`;
                     changeBtn.disabled = false;
                     finalizeBtn.disabled = false;
                     return;
                 }

                 // Update UI for finalized chapter
                 const headerBtn = document.querySelector(`#accordionItem-${chapterId} .accordion-button`);
                 if (headerBtn && !headerBtn.querySelector('.badge')) {
                     const span = document.createElement('span');
                     span.className = 'badge bg-success ms-2';
                     span.textContent = '✅ Finalized';
                     const strong = headerBtn.querySelector('strong');
                     if (strong) strong.insertAdjacentElement('afterend', span);
                     else headerBtn.appendChild(span);
                 }

                 document.getElementById(`changeInput-${chapterId}`).disabled = true;
                 changeBtn.disabled = true;
                 finalizeBtn.disabled = true;

                 const item = document.getElementById(`accordionItem-${chapterId}`);
                 if (item) {
                     item.classList.add('border', 'border-success');
                     item.style.backgroundColor = '#ecf9ee';
                 }

                 statusEl.innerHTML = `<span class="text-success">Chapter finalized successfully.</span>`;
                 loadSavedBooksDropdown(); // Refresh dropdown
             } catch (err) {
                 console.error("finalizeChapter error:", err);
                 statusEl.innerHTML = `<span class="text-danger">Finalize failed: ${err.message}</span>`;
                 if (changeBtn) changeBtn.disabled = false;
                 if (finalizeBtn) finalizeBtn.disabled = false;
             }
       }
       // =====(10-29)================ NOTIFICATION SYSTEM =====================
       function showNotification(message, type = 'success') {
             const container = document.getElementById('notificationContainer');
             const notification = document.createElement('div');
             notification.className = `notification notification-${type}`;

             let icon = '✓';
             if (type === 'error') icon = '⚠';
             if (type === 'warning') icon = '⚠';

             notification.innerHTML = `
                 <span style="font-size: 1.2rem;">${icon}</span>
                 <span>${message}</span>
             `;

             container.appendChild(notification);

             // Trigger animation
             setTimeout(() => notification.classList.add('show'), 10);

             // Remove after delay
             setTimeout(() => {
                 notification.classList.remove('show');
                 setTimeout(() => notification.remove(), 400);
             }, 4000);
       }
       //=======(11-26)============
       function addMessage(content, isUser = false) {
             //const chatcontainer = document.getelementbyId('chatcontainer');  ==> NOTE: It is case sensitive
             // Check if content is valid
             console.log("📋 Step 3: addMessage() function executed:", content);
             if (content === undefined || content === null) return '';
             // Get chat container - CORRECT CASE
             const chatContainer = document.getElementById('chatContainer');
             // Check if chat container exists
             if (!chatContainer) {
                  console.error('❌ chatContainer element not found');
                  return null;
              }
              // Create message div - CORRECT CASE
             const messageDiv = document.createElement('div');
             messageDiv.className = `message ${isUser ? 'message-user' : 'message-ai'}`;

             messageDiv.innerHTML = `
                 <div class="message-avatar">${isUser ? 'You' : 'AI'}</div>
                 <div class="message-content">
                     <div class="streaming-content">${content}</div>
                 </div>
             `;
             // Append to container - CORRECT CASE
             chatContainer.appendChild(messageDiv);

             // scroll to bottom
             chatContainer.scrollTop = chatContainer.scrollHeight;
             // Return streaming content element - CORRECT CASE
             return messageDiv.querySelector('.streaming-content');
       }
       //===(11-17)=====================================OK
       //   Run on button click ⚙️ Generate
       //        Generate Book Chapter
       //=============================================
        async function generateBook() {
            console.log("🟢 Step 1: generateBook() function started");
            // --- Step 2: Collect input values from the page ---
            const requestData = {
                     UserId: document.getElementById('UserId').value,
                     BookId: document.getElementById('BookId').value,
                     Title: document.getElementById('Title').value,
                     Chapter: parseInt(document.getElementById('Chapter').value),
                     UserInput: document.getElementById('UserInput').value
            };
            console.log("📋 Step 2: Collected input data:", requestData);

              showLoadingState('Generating your book content...', 'generate');

            // Add user message
            addMessage(`I want to create a book about: "${requestData.UserInput}" with ${requestData.Chapter} chapters.`, true);

                 //--- Step 3: Show typing indicator replaced --- Show loading spinner on page ---
                 showTypingIndicator();
                 console.log("⏳ Step 3: Displayed loading spinner");

                 // Simulate AI thinking
                 setTimeout(async () => {
                 hideTypingIndicator();

                 // Add AI response with streaming
                 const aiMessageElement = addMessage('');
                 const thinkingText = `Great! I'll create a book about "${requestData.UserInput}" with ${requestData.Chapter} chapters. Let me start generating the content...`;

                 // --- Step 4: Send data to backend controller ---
                 console.log("🚀 Step 4: Sending POST request to /Books/AIGenerateBook");

                 simulateStreaming(thinkingText, aiMessageElement, async () => {
                 // After streaming completes, make the actual API call
                 //try {
                       const response = await fetch('/Books/AIGenerateBook', {
                          method: 'POST',
                          headers: { 'Content-Type': 'application/json' },
                          body: JSON.stringify(requestData)
                       });
                       console.log("📨 Step 5: Received response:", response);
                       // --- Step 5a: Handle success ---
                       if (response.ok) {
                          const bookData = await response.json();

                          console.log("✅ Step 6: Response converted to JSON:", bookData);
                          document.getElementById('APIRawResponse').value = JSON.stringify(bookData);

                          // Show book generation complete message
                          const completeMessage = addMessage('');
                          const completeText = `✅ Book generated successfully! "${bookData.data?.title || 'Untitled Book'}" is ready with ${bookData.data?.chapters?.length || 0} chapters.`;

                          document.getElementById('ResponseId').value = bookData.responseId;

                          simulateStreaming(completeText, completeMessage, () => {
                              // Display the actual book content
                              displayBook(bookData);
                              console.log("✅ Step 7: Load Saved Response Drop-Down", bookData);
                              loadSavedBooksDropdown(); // Refresh dropdown after generating new book
                              showNotification('Book generated successfully!', 'success');
                          });
                             } else {
                                 const errorText = await response.text();
                                 console.error("❌ Step 8: Server returned error:", errorText);
                                 throw new Error(errorText || 'Failed to generate book');
                             }
                         // } catch (error) {
                         //       // --- Step 9: Handle network or unexpected errors ---
                         //     console.error("🔥 Step 9: Exception occurred:", error);

                         //     hideTypingIndicator();
                         //     const errorMessage = addMessage(`❌ Sorry, I encountered an error: ${error.message}`);
                         //     showNotification('Failed to generate book', 'error');
                         // }
                     });
                 }, 1000);
        }
         //=====(12-27)=======
         function showTypingIndicator() {
             const chatContainer = document.getElementById('chatContainer');
             const messageDiv = document.createElement('div');
             messageDiv.className = 'message message-ai';
             messageDiv.id = 'typing-indicator';

             messageDiv.innerHTML = `
                 <div class="message-avatar">AI</div>
                 <div class="message-content">
                     <div class="typing-indicator">
                         <div class="typing-dot"></div>
                         <div class="typing-dot"></div>
                         <div class="typing-dot"></div>
                     </div>
                 </div>
             `;

             chatContainer.appendChild(messageDiv);
             chatContainer.scrollTop = chatContainer.scrollHeight;
         }
         //=====(13-28)======
         function hideTypingIndicator() {
             const indicator = document.getElementById('typing-indicator');
             if (indicator) {
                 indicator.remove();
             }
         }
         // =====(14-25)================ REAL-TIME STREAMING SIMULATION ===================== OK
         function simulateStreaming(text, targetElement, callback) {
             const words = text.split(' ');
             let currentWord = 0;
             targetElement.innerHTML = '';

             const interval = setInterval(() => {
                 if (currentWord < words.length) {
                     targetElement.innerHTML += (currentWord === 0 ? '' : ' ') + words[currentWord];
                     currentWord++;

                     // Scroll to bottom of chat
                     const chatContainer = document.getElementById('chatContainer');
                     chatContainer.scrollTop = chatContainer.scrollHeight;
                 } else {
                     clearInterval(interval);
                     if (callback) callback();
                 }
             }, 50);
         }
      //===(15-2)=====================================================OK
      //====    MAIN FUNCTION TO LOAD BOOKS IN DROPDOWN            ===
      //====     Step 2: LOAD SAVED BOOKS IN DROPDOWN              ===
      //==============================================================
      //---------------------> Execution Step 4 <--------------------
      async function loadSavedBooksDropdown() {
          console.log("🔄 loadSavedBooksDropdown() called");

          const userId = document.getElementById("UserId").value;
          console.log("🔍 User ID from hidden field:", userId);

          if (!userId || userId === "0") {
              console.error("❌ No valid user ID found");
              return;
          }

          try {
              console.log("🔍 Calling API: /Books/GetSavedResponses?userId=" + userId);

              const response = await fetch(`/Books/GetSavedResponses?userId=${encodeURIComponent(userId)}`);
              console.log("🔍 Response status:", response.status);

              if (!response.ok) {
                  throw new Error(`HTTP error! status: ${response.status}`);
              }

              const books = await response.json();
              console.log("📚 Books data received:", books);

              const dropdown = document.getElementById("savedResponsesDropdown");

              if (!dropdown) {
                  console.error("❌ Dropdown element not found!");
                  return;
              }

              // Clear and populate dropdown
              dropdown.innerHTML = '<option value="">📚 Load a previously generated book...</option>';

              if (Array.isArray(books) && books.length > 0) {
                  books.forEach(book => {
                      const option = document.createElement("option");
                      option.value = book.bookId;
                      option.textContent = `${book.bookTitle} (${book.createdDate || 'No date'})`;
                      dropdown.appendChild(option);
                  });
                  console.log(`✅ SUCCESS: Loaded ${books.length} books into dropdown`);
              } else {
                  const option = document.createElement("option");
                  option.value = "";
                  option.textContent = "No saved books found - Generate one first!";
                  option.disabled = true;
                  dropdown.appendChild(option);
                  console.log("❌ No books found for this user");
              }
          } catch (error) {
              console.error("❌ Error in loadSavedBooksDropdown:", error);
          }
      }
      //===(16-3)============================================OK
      // Load Selected Book from Drop-Down from Books table
      //    if not found then Load same from
      //          RawData table
      //======================================================
          async function loadSelectedResponse(bookId)
          {
              console.log("Loading loadSelectedResponse Function");
              if (!bookId) {
                 // clearBookForm();
                 return;
              }
              console.log("Loading selected book:", bookId);
              document.getElementById('BookId').value = bookId;
              try
              {
                  const userId = document.getElementById("UserId").value;
                  if (!userId)
                  {
                        throw new Error("User ID not found");
                  }
                  const responseId = document.getElementById("ResponseId").value;
                  if (!responseId)
                  {
                        //throw new Error("User ID not found");
                  }
                  // showLoadingIndicator(true);
                  const response = await fetch(`/Books/GetBookDetails?userId=${userId}&bookId=${bookId}&responseId=${responseId}`);

                  if (!response.ok)
                  {
                      // if not found load from APIRawResponse table
                      //console.log("Loading selected book from APIRawResponse:", bookId);
                     // response = await fetch(`/Books/GetBookFromRawData?userId=${userId}&bookId=${bookId}`);
                      if (!response.ok) {
                          throw new Error("Failed to load book details");
                      }
                  }

                  const result = await response.json();

                  // Load Selected Book Data into the FORM
                   if (result.success)
                   {
                       // ✅ Fill the ResponseId field
                      document.getElementById("ResponseId").value = result.responseId;

                       // ✅ Fill the textarea or content field
                      document.getElementById("BookTitle").value = result.title;

                      // ✅ Fill the textarea or content field
                      document.getElementById("UserInput").value = result.data;
                      //
                      document.getElementById("Status").value = result.data;
                      populateBookForm(result);   // Function to populate FORM's fields with book data
                      showBookContent(result);    // Load Book's Title, ChapterNiData
                      showNotification("Book loaded successfully!", "success");

                    } else {
                        // clearBookForm();
                        showNotification("Error: " + result.message, "error");
                    }
              } catch (error) {
                  console.error("Error loading book details:", error);
                  //clearBookForm();
                  showNotification("Error loading book details: " + error.message, "error");
              }
          }
       //===(16-3)============================================OK
       // Load Selected Book from Drop-Down from Books table
       //    if not found then Load same from
       //          RawData table
       //======================================================
        // async function loadSelectedResponse2(bookId) {
             // console.log("🔄 loadSelectedResponse() called with bookId:", bookId);

             // if (!bookId) {
             //     console.log("❌ No book selected");
             //     clearBookForm();
             //     return;
             // }

             // try {
             //     const userId = document.getElementById("UserId").value;
             //     if (!userId || userId === "0") {
             //         throw new Error("User ID not found");
             //     }

             //     console.log("🔍 Loading book data for User:", userId, "Book:", bookId);

             //     // Show loading state
             //     showLoadingIndicator(true);

             //     // First try to get book details from Books table
             //     let response = await fetch(`/Books/GetBookDetails?userId=${userId}&bookId=${bookId}`);

             //     if (!response.ok) {
             //         console.log("📚 Book not found in Books table, trying APIRawResponse...");
             //         // If not found, load from APIRawResponse table
             //         response = await fetch(`/Books/GetLastBookrawResponseData?userId=${userId}&bookId=${bookId}&responseId=0`);

             //         if (!response.ok) {
             //             throw new Error("Failed to load book details from both sources");
             //         }
             //     }

             //     const result = await response.json();
             //     console.log("📚 Book data received:", result);

             //     if (result.success) {
             //         // ✅ Fill the ResponseId field if available
             //         if (result.responseId) {
             //             document.getElementById("ResponseId").value = result.responseId;
             //         }

             //         // ✅ Fill the textarea or content field
             //         if (result.data) {
             //             document.getElementById("UserInput").value = result.data;
             //         }

             //         // Populate form with book data
             //         populateBookForm(result);

             //         // Display book content
             //         showBookContent(result);

             //         showNotification("Book loaded successfully!", "success");

             //     } else {
             //         clearBookForm();
             //         showNotification("Error: " + result.message, "error");
             //     }

             // } catch (error) {
             //     console.error("❌ Error loading book details:", error);
             //     clearBookForm();
             //     showNotification("Error loading book details: " + error.message, "error");
             // } finally {
             //     showLoadingIndicator(false);
             // }
    // }
     // ===(15-2)==================================================OK
     // ====      TO LOAD LAST BOOK'S Data and Disply            ===
    //  ====   When Page Load Auto Display Last Book's Chapter   ===
     // ============================================================
    //  ---------------------> Execution Step  <--------------------
      // async function loadLastBookData(bookId) {
      //     console.log("🔄 loadLastBookData() called");
      //     const userId = document.getElementById("UserId").value;
      //     const bookId = document.getElementById("savedResponsesDropdown").value;

      //     console.log("🔍 User ID:", userId);
      //     console.log("🔍 Book ID:", bookId);

      //     if (!userId || userId === "0") {
      //         console.error("❌ No valid user ID provided");
      //         return;
      //     }

      //     if (!bookId || bookId === "0") {
      //         console.error("❌ No valid Book Selection");
      //         return;
      //     }

      //     try {
      //         console.log("🔍 Calling API: /Books/GetLastBookrawResponseData?userId=" + userId + "&bookId=" + bookId);

      //         const responseId = document.getElementById("ResponseId").value || 0;
      //         const response = await fetch(`/Books/GetLastBookrawResponseData?userId=${userId}&bookId=${bookId}&responseId=${responseId}`);

      //         console.log("🔍 Response status:", response.status);

      //         if (!response.ok) {
      //             throw new Error(`HTTP error! status: ${response.status}`);
      //         }

      //         const result = await response.json();
      //         console.log("📚 Books data received:", result);

      //         if (result.success) {
      //             populateBookForm(result);
      //             displayBook(result);
      //             showNotification("Last book loaded successfully!", "success");
      //         } else {
      //             showNotification("Error loading book: " + result.message, "error");
      //         }

      //     } catch (error) {
      //         console.error("❌ Error in loadLastBookData:", error);
      //         showNotification("Error loading last book: " + error.message, "error");
      //     }

      // }
      //===(17-43)=== Function to show/hide loading indicator
          function showLoadingIndicator(show) {
                const dropdown = document.getElementById('savedResponsesDropdown');
                if (show)
                {
                    dropdown.disabled = true;
                    dropdown.style.opacity = '0.7';
                } else {
                    dropdown.disabled = false;
                    dropdown.style.opacity = '1';
                }
            }
        //====(18-41)========================================
        // Function to populate form fields with book data
        //===================================================
        function populateBookForm(bookData) {
            console.log("Populating form with book data:", bookData);

            // Populate Number of Chapters
            const chapterCount = bookData.totalChapters || (bookData.chapters ? bookData.chapters.length : 0);
            document.getElementById('Chapter').value = chapterCount > 0 ? chapterCount : 1;

            // Populate Chapter Title (using book title or first chapter title)
            let chapterTitle = bookData.title || '';
            if (bookData.chapters && bookData.chapters.length > 0) {
                chapterTitle = bookData.chapters[0].title || chapterTitle;
            }
            document.getElementById('Title').value = chapterTitle;

            // Populate Chapter Topic (using book description or first chapter content)
            let chapterTopic = bookData.description || '';
            if (bookData.chapters && bookData.chapters.length > 0) {
                chapterTopic = bookData.chapters[0].content || chapterTopic;
            }
            document.getElementById('UserInput').value = chapterTopic;

            // Populate BookId if available
            if (bookData.bookId) {
                document.getElementById('BookId').value = bookData.bookId;
            }
            // ✅ Fill the ResponseId field
           //  document.getElementById("ResponseId").value = bookData.response_id;  //responseId;

             // ✅ Fill the textarea or content field
           //  document.getElementById("UserInput").value = bookData.data;

            console.log("Form populated successfully");
            showNotification("Book loaded successfully!", "success");
        }
        // ====(19-24)==== UI Helper Function to DISPLAY BOOK CONTENT ===================== OK
         function showBookContent(book) {
              const chatContainer = document.getElementById("chatContainer");

              // Clear existing content
              chatContainer.innerHTML = '';

              // Add book title message
              const titleMessage = addMessage(`📖 **${book.title || "Untitled Book"}**`);

             // Add chapters if available
             if (book.chapters && book.chapters.length > 0) {
                  setTimeout(() => {
                       const chaptersMessage = addMessage(`Here are the chapters of your book:`);

                  // Add each chapter with accordion
                  book.chapters.forEach((chapter, index) => {
                       setTimeout(() => {
                          const chapterDiv = document.createElement('div');
                          chapterDiv.className = 'chapter-accordion';
                          chapterDiv.innerHTML = `
                                     <div class="chapter-item">
                                         <h3 class="chapter-header">
                                             <button class="chapter-button collapsed" type="button" data-bs-toggle="collapse"
                                                     data-bs-target="#chapterCollapse${index}">
                                                 Chapter ${chapter.number || index + 1}: ${chapter.name || chapter.title || "Untitled"}
                                             </button>
                                         </h3>
                                         <div id="chapterCollapse${index}" class="collapse">
                                             <div class="chapter-body">
                                                 ${chapter.content || "No content available"}
                                             </div>
                                         </div>
                                     </div>
                                 `;

                                 // Create a new message for each chapter
                                 const chapterMessage = document.createElement('div');
                                 chapterMessage.className = 'message message-ai';
                                 chapterMessage.innerHTML = `
                                     <div class="message-avatar">📚</div>
                                     <div class="message-content">
                                         <div class="streaming-content">
                                             ${chapterDiv.outerHTML}
                                         </div>
                                     </div>
                                 `;

                                 chatContainer.appendChild(chapterMessage);

                                 // Scroll to bottom
                                 chatContainer.scrollTop = chatContainer.scrollHeight;

                             }, index * 300);
                         });
                     }, 500);
                 } else {
                     setTimeout(() => {
                         addMessage("No chapters found in this book.");
                     }, 500);
                 }
         }
         //===(20-31)============================================
         // ========= On Save Button SAVE the BOOK ==============
         //======================================================
         async function saveBook() {
             const rawResponse = document.getElementById('APIRawResponse').value;
             if (!rawResponse) {
                 showNotification('Please generate a book first!', 'warning');
                 return;
             }
             const requestData = {
                     UserId: document.getElementById('UserId').value,
                     BookId: document.getElementById('BookId').value,
                     Title: document.getElementById('Title').value,
                     Chapter: parseInt(document.getElementById('Chapter').value),
                     UserInput: document.getElementById('UserInput').value
            };
             const body = {
                 userId: document.getElementById('UserId').value,
                 bookId: document.getElementById('BookId').value,
                 title: document.getElementById('Title').value,
                 chapter: parseInt(document.getElementById('Chapter').value),
                 apiRaw: rawResponse
             };

             try {
                 const res = await fetch('/Books/SaveBookFromAPI', {
                     method: 'POST',
                     headers: { 'Content-Type': 'application/json' },
                     body: JSON.stringify(body)
                 });

                 if (res.ok) {
                     showNotification('✅ Book saved successfully!', 'success');
                     loadSavedBooksDropdown(); // Refresh dropdown after saving
                     addMessage('💾 Your book has been saved to your library!', false);
                 } else {
                     throw new Error('Failed to save book');
                 }
             } catch (err) {
                 showNotification('Error saving book: ' + err.message, 'error');
             }
         }
     //===============================================
     //   Save/Update changes in APIRawResponse Table
     //==============================================
     async function updateBook() {
         console.log("🟢 Step 1: updateBook() function started");

         // --- Step 2: Collect input values from the page ---
         const requestData = {
             ResponseId: document.getElementById('ResponseId').value,
             UserId: document.getElementById('UserId').value,
             BookId: document.getElementById('BookId').value,
             Title: document.getElementById('Title').value,
             Chapter: parseInt(document.getElementById('Chapter').value),
             UserInput: document.getElementById('UserInput').value
         };

         console.log("📋 Step 2: Collected input data:", requestData);

         try {
             const res = await fetch('/Books/UpdateBookInAPI', {
                 method: 'POST',
                 headers: { 'Content-Type': 'application/json' },
                 body: JSON.stringify(requestData)
             });

             // Check if response is OK
             if (!res.ok) {
                 throw new Error(`HTTP error! status: ${res.status}`);
             }

             const result = await res.text();
             console.log("✅ Update successful:", result);

             showNotification('✅ Book updated successfully!', 'success');
             addMessage('💾 Your book has been updated in your library!', false);

         } catch (err) {
             console.error("❌ Error updating book:", err);
             showNotification('Error updating book: ' + err.message, 'error');
         }
     }
     //=====(39)===============================OK
     //            Create Book
     //========================================
        async  function createBook()
        {
            try {
                 console.log("🔍 Step 1: Collecting UserId from form");

                 // ✅ Get only the UserId for redirect
                 const userId = document.getElementById('UserId')?.value;

                 if (!userId) {
                     Swal.fire("Warning", "User ID is required to create a book.", "warning");
                     return;
                 }

                 console.log("🚀 Step 2: Redirecting to CreateBook page with UserId:", userId);

                 // ✅ Immediately redirect to CreateBook page with UserId
                 window.location.href = `/Books/CreateBook?userId=${userId}`;

             } catch (err) {
                 console.error("🔥 Error in createBook():", err);
                 Swal.fire("Error", err.message || "Unexpected error occurred.", "error");
             }
     }
          //=====(4)=============================OK
          // Plans from Plans => PlansController
          //=======================================
           function showPricingPlans() {
                     console.log("✅ Step 1: showPricingPlans called");
                 fetch('/Plans/GetPlans')
                     .then(response => response.json())
                     .then(plans => {
                         let html = `<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin: 20px 0;">`;

                         plans.forEach(availablePlan => {
                             html += `
                                 <div style="border: 2px solid #e0e0e0; border-radius: 15px; padding: 25px; text-align: center;">
                                     <h4 style="color: #4a6cf7; margin-bottom: 15px;">${availablePlan.planName}</h4>
                                     <div style="font-size: 2rem; font-weight: bold; margin-bottom: 15px;">
                                         $${availablePlan.planRate}<span style="font-size: 1rem; color: #666;"> / ${availablePlan.planDays} days</span>
                                     </div>
                                     <p><strong>Max eBooks:</strong> ${availablePlan.maxEBooks}</p>
                                     <p>${availablePlan.planDescription ?? ""}</p>
                                     <button class="btn btn-primary" onclick="selectPlan(${availablePlan.planId})">
                                         Select ${availablePlan.planName}
                                     </button>
                                 </div>
                             `;
                         });
                         html += `</div>`;

                         Swal.fire({
                             title: 'Choose Your Plan',
                             html: html,
                             showConfirmButton: false,
                             showCloseButton: true,
                             width: '900px'
                         });
                     })
                     .catch(error => {
                         console.error("Error fetching plans:", error);
                         Swal.fire("Error", "Could not load plans.", "error");
                     });
             }
             //=============================================================OK
             //====(5)=== Call Checkout.cshtml after confirmation of Plan  ==
             //==============================================================
              function selectPlan(planId) {
                          Swal.fire({
                              title: 'Confirm Plan Selection',
                              text: 'Do you want to continue to checkout?',
                              icon: 'question',
                              showCancelButton: true,
                              confirmButtonText: 'Yes, Continue'
                          }).then((result) => {
                              if (result.isConfirmed) {
                                  window.location.href = `/Payments/Checkout?planId=${planId}`;
                              }
                          });
              }

         //===(6)========================================OK
         // Plan Features Selection => PlansController
         //==============================================
         function showPlanFeatures() {
            // console.log("✅ Step 1: showPlanFeatures called");
             fetch('/Plans/GetPlanFeatures')
               // console.log("✅ Step 2: Plans/GetPlanFeatures called");
                 .then(response => response.json())
                 .then(features => {
                     let html = `
                         <div class="features-container" style="max-height: 500px; overflow-y: auto; padding: 10px;">
                             <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; margin: 10px 0;">
                     `;

                     features.forEach(feature => {
                         html += `
                             <div style="border: 1px solid #ddd; border-radius: 10px; padding: 15px; text-align: left; background: #f9f9f9;">
                                 <div style="display: flex; align-items: flex-start; gap: 10px; margin-bottom: 10px;">
                                     <input type="checkbox"
                                            id="feature_${feature.featureId}"
                                            value="${feature.featureId}"
                                            class="feature-checkbox"
                                            style="margin-top: 3px;">
                                     <div style="flex: 1;">
                                         <h5 style="color: #4a6cf7; margin: 0 0 5px 0;">${feature.featureName}</h5>
                                         <div style="font-size: 1.5rem; font-weight: bold; color: #28a745;">
                                             $${feature.featureRate}
                                         </div>
                                     </div>
                                 </div>
                                 <p style="margin: 0; color: #666; font-size: 0.9rem;">${feature.description || "No description available"}</p>
                             </div>
                         `;
                     });

                     html += `
                             </div>
                             <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                                 <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                     <div>
                                         <button type="button" class="btn btn-outline-secondary btn-sm" onclick="selectAllFeatures()">
                                             Select All
                                         </button>
                                         <button type="button" class="btn btn-outline-secondary btn-sm" onclick="deselectAllFeatures()" style="margin-left: 10px;">
                                             Deselect All
                                         </button>
                                     </div>
                                     <strong>Selected: <span id="selectedCount">0</span> features</strong>
                                 </div>
                                 <div id="selectedFeaturesList" style="font-size: 0.9rem; color: #666;"></div>
                             </div>
                         </div>
                     `;

                     Swal.fire({
                         title: 'Select Features',
                         html: html,
                         showConfirmButton: true,
                         showCancelButton: true,
                         confirmButtonText: 'Confirm Selection',
                         cancelButtonText: 'Cancel',
                         width: '1000px',
                         didOpen: () => {
                             // Add event listeners to checkboxes
                             const checkboxes = document.querySelectorAll('.feature-checkbox');
                             checkboxes.forEach(checkbox => {
                                 checkbox.addEventListener('change', updateSelectedFeatures);
                             });
                             updateSelectedFeatures(); // Initial update
                         }
                     }).then((result) => {
                         if (result.isConfirmed) {
                             confirmFeatureSelection();
                         }
                     });
                 })
                 .catch(error => {
                     console.error("Error fetching plan features:", error);
                     Swal.fire("Error", "Could not load features.", "error");
                 });
         }
         //======================================================OK
         // ===(7)==  Update selected features count and list
         //=====================================================
         function updateSelectedFeatures() {
              // console.log("✅ Step 3: updateSelectedFeatures() called");
             const selectedCheckboxes = document.querySelectorAll('.feature-checkbox:checked');
             const selectedCount = selectedCheckboxes.length;

             document.getElementById('selectedCount').textContent = selectedCount;

             const selectedFeaturesList = document.getElementById('selectedFeaturesList');
             if (selectedCount === 0) {
                 selectedFeaturesList.innerHTML = '<em>No features selected</em>';
             } else {
                 const featureNames = Array.from(selectedCheckboxes).map(checkbox => {
                     const featureDiv = checkbox.closest('div[style*="border: 1px solid #ddd"]');
                     const featureName = featureDiv.querySelector('h5').textContent;
                     return featureName;
                 });
                 selectedFeaturesList.innerHTML = '<strong>Selected:</strong> ' + featureNames.join(', ');
             }
         }

         //====(8)====== Select all features == OK
         function selectAllFeatures() {
             const checkboxes = document.querySelectorAll('.feature-checkbox');
             checkboxes.forEach(checkbox => {
                 checkbox.checked = true;
             });
             updateSelectedFeatures();
         }

         //====(9)=== Deselect all features == OK
         function deselectAllFeatures() {
             const checkboxes = document.querySelectorAll('.feature-checkbox');
             checkboxes.forEach(checkbox => {
                 checkbox.checked = false;
             });
             updateSelectedFeatures();
         }

         //====(10)=== Handle confirmed selection===OK
         function confirmFeatureSelection() {
            //   console.log("✅ Step 4: confirmFeatureSelection() called");
             const selectedCheckboxes = document.querySelectorAll('.feature-checkbox:checked');
             const selectedFeatureIds = Array.from(selectedCheckboxes).map(checkbox => checkbox.value);

             if (selectedFeatureIds.length === 0) {
                 Swal.fire("Info", "Please select at least one feature.", "info");
                 return;
             }

             console.log("Selected feature IDs:", selectedFeatureIds);
                  // Store the selection for later use
             localStorage.setItem('selectedFeatures', JSON.stringify(selectedFeatureIds));

             // Call selectPlanFeatures with the selected feature IDs
             selectPlanFeatures(selectedFeatureIds);
         }
         // =====(11)===== Call Checkout.cshtml after confirmation of Plan Features ==============OK
         async function selectPlanFeatures(selectedFeatureIds) {
                console.log("🔍 STEP 1:selectPlanFeatures called with:", selectedFeatureIds);

              const result = await Swal.fire({
                  title: 'Confirm Plan Selection',
                  html: `You have selected <strong>${selectedFeatureIds.length}</strong> features.<br>
                         Do you want to continue to checkout?`,
                  icon: 'question',
                  showCancelButton: true,
                  confirmButtonText: 'Yes, Continue to Checkout',
                  cancelButtonText: 'Cancel'
              });
               console.log("🔍 STEP 2: SweetAlert result:", result);
              if (result.isConfirmed) {
               console.log("🔍 STEP 3: User confirmed, starting feature save...");
              try {
                   console.log("🔍 STEP 4: Calling saveAuthorFeatures...");

                  const saveResult = await saveAuthorFeatures(selectedFeatureIds);
                   console.log("🔍 STEP 5: saveAuthorFeatures returned:", saveResult);

                   if (saveResult  && saveResult.success) {
                        console.log("🔍 STEP 6: Save successful, closing SweetAlert...");
                      Swal.close();

                        // Pass both feature IDs and bill ID to checkout
                       //const featureIdsString = selectedFeatureIds.join(',');
                       //window.location.href = `/Payments/Checkout?featureIds=${featureIdsString}&billId=${saveResult.billId}&saved=true`;

                      if (saveResult.billId) {
                          console.log("✅ STEP 7: Redirecting with billId:", saveResult.billId);

                          window.location.href = `/Payments/CheckoutPayment?billId=${saveResult.billId}`;
                      } else {
                          console.log("⚠️ STEP 7: No billId received, using featureIds");
                          const featureIdsString = selectedFeatureIds.join(',');
                          window.location.href = `/Payments/CheckoutPayment?featureIds=${featureIdsString}&saved=true`;
                      }
                  } else {
                       console.error("❌ STEP 6:Save failed:", saveResult.message);
                        const errorMessage = saveResult?.message || "Unknown error occurred";
                      Swal.fire('Error', `Failed to save features: ${saveResult.message}`, 'error');
                  }
              } catch (error) {
                    console.error("❌ STEP 4-5: Exception caught:", error);
                  Swal.fire('Error', `Failed to save features: ${error.message}`, 'error');
              }
            }
         }
      //    //====(12)========= Helper function ============== OK
      //        // Helper function to get current user ID
      //    function getCurrentUserId() {
      //        console.log("🔍 Getting current user ID...");

      //        // Try different methods to get user ID

      //        // 1. Check if there's a UserId element
      //        const userIdElement = document.getElementById('UserId');
      //        if (userIdElement && userIdElement.value) {
      //            console.log("✅ User ID from UserId element:", userIdElement.value);
      //            return parseInt(userIdElement.value);
      //        }

      //        // 2. Check if there's a userId element (lowercase)
      //        const userIdElement2 = document.getElementById('userId');
      //        if (userIdElement2 && userIdElement2.value) {
      //            console.log("✅ User ID from userId element:", userIdElement2.value);
      //            return parseInt(userIdElement2.value);
      //        }

      //        // 3. Check ViewBag (if available in your Razor view)
      //        if (typeof userId !== 'undefined' && userId) {
      //            console.log("✅ User ID from ViewBag:", userId);
      //            return parseInt(userId);
      //        }

      //        // 4. Check localStorage
      //        const storedUserId = localStorage.getItem('UserId') || localStorage.getItem('userId');
      //        if (storedUserId) {
      //            console.log("✅ User ID from localStorage:", storedUserId);
      //            return parseInt(storedUserId);
      //        }

      //        // 5. Check sessionStorage
      //        const sessionUserId = sessionStorage.getItem('UserId') || sessionStorage.getItem('userId');
      //        if (sessionUserId) {
      //            console.log("✅ User ID from sessionStorage:", sessionUserId);
      //            return parseInt(sessionUserId);
      //        }

      //        console.error("❌ Could not find user ID");
      //        return 1; // Fallback - adjust as needed
      //    }

      //    //===(13)=== Also update your getCurrentAuthorId function to be consistent ===OK
      //    function getCurrentAuthorId() {
      //        console.log("🔍 Getting current author ID...");

      //        // Try different methods to get author ID

      //        // 1. Check if there's an AuthorId element
      //        const authorIdElement = document.getElementById('AuthorId');
      //        if (authorIdElement && authorIdElement.value) {
      //            console.log("✅ Author ID from AuthorId element:", authorIdElement.value);
      //            return parseInt(authorIdElement.value);
      //        }

      //        // 2. Check if there's an authorId element (lowercase)
      //        const authorIdElement2 = document.getElementById('authorId');
      //        if (authorIdElement2 && authorIdElement2.value) {
      //            console.log("✅ Author ID from authorId element:", authorIdElement2.value);
      //            return parseInt(authorIdElement2.value);
      //        }

      //        // 3. For many systems, AuthorId is the same as UserId
      //        console.log("⚠️ No AuthorId found, using UserId instead");
      //        return getCurrentUserId();
      //    }

         //=====(14)===== Function to save features using the new API endpoint === OK
         async function saveAuthorFeatures(featureIds) {
              console.log("✅ Step 6: Continue to saveAuthorFeatures called");
              try {
                     const authorId = getCurrentAuthorId(); // Your existing function
                     const userId = getCurrentUserId();
                     const response = await fetch('/api/AuthorPlanFeatures/save-features', {
                         method: 'POST',
                         headers: {
                             'Content-Type': 'application/json',
                         },
                         body: JSON.stringify({
                             authorId: userId,
                             userId: userId,
                             featureIds: featureIds
                         })
                     });

                     if (!response.ok) {
                         throw new Error(`HTTP error! status: ${response.status}`);
                     }

                     const result = await response.json();
                      // Debug: Check what's returned
                     console.log("Save features response:", result);

                      if (result.success && result.billId) {
                          console.log("✅ Bill created successfully with ID:", result.billId);
                          return result; // This contains billId
                      } else {
                          throw new Error(result.message || "Failed to save features");
                      }
                 } catch (error) {
                     console.error('Error saving features:', error);
                     return { success: false, message: error.message };
                 }
            }

         //===(15)==== Helper function to get current author ID == OK
         function getCurrentAuthorId() {
             // Your existing implementation
              const authorIdElement = document.getElementById('UserId');

             if (authorIdElement) {
                 return parseInt(authorIdElement.value);
             }

              const storedAuthorId = localStorage.getItem('UserId');
             if (storedAuthorId) {
                 return parseInt(storedAuthorId);
             }

             if (typeof currentAuthorId !== 'undefined') {
                 return currentAuthorId;
             }

             return 1; // Fallback
         }

      //     //===(16)====================OK
      //     //  Plan Features in Table
      //     //===========================
      //      function showFeatureLocks()
      //      {
      //           console.log("✅ Step 1: showFeatureLocks ");
      //           fetch('/Payments/LoadFeatureLocks')
      //               .then(response => response.text())
      //               .then(html => {
      //                    Swal.fire({
      //                         title: 'Feature Access Control',
      //                         html: html, // Razor view content
      //                         showConfirmButton: false,
      //                         showCloseButton: true,
      //                         width: '600px'
      //                    });
      //               }).catch(error => {
      //                      console.error('Error loading feature locks:', error);
      //                      Swal.fire('Error', 'Failed to load feature list.', 'error');
      //              });
      //      }


      //           //===(19)==== Helper: normalize plain text for <pre> with pre-wrap == OK
      //           function formatText(text) {
      //               if (text === undefined || text === null) return '';
      //               return String(text).replace(/\r\n/g, '\n');
      //           }



     //    //===(23)==== Helper function to format chapter content === OK
     //    function formatChapterContent(content) {
     //        if (!content) return '<p class="text-muted">No content available.</p>';

     //        // If content is already HTML, return as is
     //        if (content.includes('<') && content.includes('>')) {
     //            return content;
     //        }

     //        // Convert plain text to paragraphs
     //        const paragraphs = content.split('\n\n').filter(p => p.trim());
     //        if (paragraphs.length > 0) {
     //            return paragraphs.map(p => `<p>${p.replace(/\n/g, '<br>')}</p>`).join('');
     //        }

     //        // Fallback: treat each line as a paragraph
     //        return content.split('\n').map(line => `<p>${line}</p>`).join('');
     //    }






     //     // ====(30)================= DISPLAY BOOK IN CHAT =====================
     //     function displayBookInChat(bookData) {
     //         const chapters = bookData.data?.chapters || [];
     //         const bookTitle = bookData.data?.title || "Untitled Book";

     //         // Add book title message
     //         const titleMessage = addMessage(`📖 **${bookTitle}**\n\nHere are the chapters I've created:`);

     //         // Add each chapter
     //         chapters.forEach((chapter, index) => {
     //             setTimeout(() => {
     //                 const chapterMessage = addMessage(`**Chapter ${index + 1}: ${chapter.title}**\n\n${chapter.content.substring(0, 200)}...`);
     //             }, index * 500);
     //         });

     //         // Add completion message
     //         setTimeout(() => {
     //             addMessage(`🎉 Your book "${bookTitle}" is complete! You can now save it or generate another one.`);
     //         }, chapters.length * 500 + 500);
     //     }


     //     //===(34)==== Upgrade for specific feature ===OK
     //     async  function upgradeForFeature(feature) {
     //         Swal.fire({
     //             title: 'Upgrade Required',
     //             text: `To access ${feature}, you need to upgrade your plan. Would you like to see upgrade options?`,
     //             icon: 'info',
     //             showCancelButton: true,
     //             confirmButtonColor: '#4a6cf7',
     //             confirmButtonText: 'Show Plans',
     //             cancelButtonText: 'Maybe Later'
     //         }).then((result) => {
     //             if (result.isConfirmed) {
     //                 showPricingPlans();
     //             }
     //         });
     //    }

     //      //====(36)=====
     //      function debugBooks() {
     //          // Add your debug logic here if needed
     //          console.log("🔍 Debug books function called");
     //      }


     //  //=====(38)=================================== OK
     //  //         Show Selected Book  ==>  <div id="bookResult" class="book-result">
     //  //========================================
     // function displaySavedBook(responseData)
     // {
     //     console.log("🔍 Step: 4 displaySavedBook function called");
     //     const container = document.getElementById("bookResult");
     //     container.innerHTML = ""; // clear old

     //     try {
     //         const parsed = JSON.parse(responseData);

     //         if (parsed.data && parsed.data.chapters)
     //         {
     //             parsed.data.chapters.forEach((chapter, i) => {
     //                 const card = document.createElement("div");
     //                 card.className = "card my-2";

     //                 card.innerHTML = `
     //                     <div class="card-header">
     //                         <b>Chapter ${i + 1}:</b> ${chapter.title}
     //                     </div>
     //                     <div class="card-body">
     //                         <div class="book-text-box" style="max-height:300px; overflow:auto; white-space:pre-wrap;">${chapter.text}</div>
     //                     </div>
     //                 `;

     //                 container.appendChild(card);
     //             });
     //         } else {
     //             container.innerHTML = `<pre>${responseData}</pre>`;
     //         }
     //     } catch (ex) {
     //         container.innerHTML = `<pre>${responseData}</pre>`;
     //     }
     // }

     // //=====(40)=======================================
     // // Test with debug endpoint first
     // //================================================
     //     async function testRequest() {
     //           const requestData = {
     //                UserId: document.getElementById('UserId').value,
     //                BookId: document.getElementById('BookId').value,
     //                Title: document.getElementById('Title').value,
     //                Chapter: parseInt(document.getElementById('Chapter').value),
     //                UserInput: document.getElementById('UserInput').value
     //            };
     //            console.log("🔍 Testing request data structure:", requestData);

     //            const testResponse = await fetch('/Books/DebugRequest', {
     //                        method: 'POST',
     //                        headers: { 'Content-Type': 'application/json' },
     //                        body: JSON.stringify(requestData)
     //             });

     //              const result = await testResponse.json();
     //              console.log("📋 Debug endpoint response:", result);
     //           }

     //    //===(42)=== Function to clear the form when no book is selected
     //    function clearBookForm() {
     //            document.getElementById('Chapter').value = 5; // Default value
     //            document.getElementById('Title').value = '';
     //            document.getElementById('UserInput').value = '';
     //            console.log("Form cleared");
     //    }


     // //====(43)================================
     // //       Content Formatting Button
     // //========================================
     //  function openAIBookFormatting()
     //  {
     //         // Get the required parameters
     //          const requestData =
     //          {
     //                    UserId: document.getElementById('UserId')?.value || '@ViewBag.UserId';
     //                    BookId: document.getElementById('BookId').value,
     //                    Title: document.getElementById('Title').value,
     //                    Chapter: parseInt(document.getElementById('Chapter').value),
     //                    UserInput: document.getElementById('UserInput').value
     //          };
     //          console.log("📖 Opening AI Book Formatting:", { UserId, BookId, Title });
     //          // Redirect to AIBookFormatting page with parameters
     //         window.location.href = `/Books/AIBookFormatting?userId=${UserId}&bookId=${BookId}&chapterTitle=${encodeURIComponent(Title)}`;
     //  }

     // //===(44)===== Option 1: Open in Bootstrap Modal
     // function openBookFormattingModal(userId, bookId, chapterTitle)
     // {
     //     // Create modal container if it doesn't exist
     //     let modalContainer = document.getElementById('bookFormattingModal');
     //     if (!modalContainer)
     //     {
     //         modalContainer = document.createElement('div');
     //         modalContainer.id = 'bookFormattingModal';
     //         modalContainer.className = 'modal fade';
     //         modalContainer.innerHTML = `
     //             <div class="modal-dialog modal-xl modal-dialog-scrollable">
     //                 <div class="modal-content">
     //                     <div class="modal-header">
     //                         <h5 class="modal-title">📖 Book Content Formatting</h5>
     //                         <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
     //                     </div>
     //                     <div class="modal-body">
     //                         <div id="bookFormattingContent"></div>
     //                     </div>
     //                     <div class="modal-footer">
     //                         <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
     //                     </div>
     //                 </div>
     //             </div>
     //         `;
     //         document.body.appendChild(modalContainer);
     //     }
     //     // Load the form content
     //     loadBookFormattingForm(userId, bookId, chapterTitle);

     //     // Show modal
     //     const modal = new bootstrap.Modal(modalContainer);
     //     modal.show();
     // }
</script>

<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
